<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/ETL-RDF-STAR/debug_pyoxigraph.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ETL-RDF-STAR/debug_pyoxigraph.py" />
              <option name="updatedContent" value="&quot;&quot;&quot;&#10;Debug script to understand PyOxigraph QuerySolution behavior&#10;&quot;&quot;&quot;&#10;from pyoxigraph import Store, RdfFormat&#10;&#10;# Load small sample&#10;store = Store()&#10;&#10;print(&quot;Loading data...&quot;)&#10;with open(&quot;output/output_data_star.trig&quot;, 'rb') as f:&#10;    store.load(f, RdfFormat.TRIG)&#10;&#10;print(f&quot;Loaded {len(list(store))} quads\n&quot;)&#10;&#10;# Test query&#10;query = &quot;&quot;&quot;&#10;PREFIX dcat: &lt;http://www.w3.org/ns/dcat#&gt;&#10;PREFIX dct: &lt;http://purl.org/dc/terms/&gt;&#10;&#10;SELECT ?dataset ?title&#10;WHERE {&#10;    ?dataset a dcat:Dataset ;&#10;             dct:title ?title .&#10;}&#10;LIMIT 3&#10;&quot;&quot;&quot;&#10;&#10;print(&quot;Executing query...&quot;)&#10;results = list(store.query(query))&#10;print(f&quot;Got {len(results)} results\n&quot;)&#10;&#10;if results:&#10;    first = results[0]&#10;    &#10;    print(f&quot;Type of result: {type(first)}&quot;)&#10;    print(f&quot;Result repr: {repr(first)}&quot;)&#10;    print(f&quot;Result str: {str(first)}&quot;)&#10;    &#10;    print(&quot;\n--- Testing dictionary access ---&quot;)&#10;    try:&#10;        dataset = first['dataset']&#10;        print(f&quot;✓ first['dataset'] = {dataset}&quot;)&#10;        print(f&quot;  Type: {type(dataset)}&quot;)&#10;        print(f&quot;  Str: {str(dataset)}&quot;)&#10;    except Exception as e:&#10;        print(f&quot;✗ Dictionary access failed: {e}&quot;)&#10;    &#10;    print(&quot;\n--- Testing iteration ---&quot;)&#10;    try:&#10;        print(&quot;Iterating over result:&quot;)&#10;        for item in first:&#10;            print(f&quot;  Item: {item} (type: {type(item)})&quot;)&#10;    except Exception as e:&#10;        print(f&quot;✗ Iteration failed: {e}&quot;)&#10;    &#10;    print(&quot;\n--- Testing dir() ---&quot;)&#10;    methods = [m for m in dir(first) if not m.startswith('_')]&#10;    print(f&quot;Available methods: {methods}&quot;)&#10;    &#10;    print(&quot;\n--- Trying different access methods ---&quot;)&#10;    &#10;    # Try __iter__&#10;    try:&#10;        print(&quot;Using __iter__:&quot;)&#10;        for var in first:&#10;            print(f&quot;  Variable: {var}&quot;)&#10;            value = first[var]&#10;            print(f&quot;  Value: {value}&quot;)&#10;            print(f&quot;  Value type: {type(value)}&quot;)&#10;            print(f&quot;  Value str: {str(value)}&quot;)&#10;    except Exception as e:&#10;        print(f&quot;✗ __iter__ failed: {e}&quot;)&#10;    &#10;    print(&quot;\n--- All results ---&quot;)&#10;    for i, result in enumerate(results):&#10;        print(f&quot;\nResult {i+1}:&quot;)&#10;        try:&#10;            for var in result:&#10;                value = result[var]&#10;                print(f&quot;  {var} = {value}&quot;)&#10;        except Exception as e:&#10;            print(f&quot;  Error: {e}&quot;)&#10;&#10;else:&#10;    print(&quot;No results returned!&quot;)&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ETL-RDF-STAR/debug_pyoxigraph2.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ETL-RDF-STAR/debug_pyoxigraph2.py" />
              <option name="originalContent" value="&#10;" />
              <option name="updatedContent" value="&quot;&quot;&quot;&#10;Find how to get variable names from QuerySolutions&#10;&quot;&quot;&quot;&#10;from pyoxigraph import Store, RdfFormat&#10;&#10;store = Store()&#10;with open(&quot;output/output_data_star.trig&quot;, 'rb') as f:&#10;    store.load(f, RdfFormat.TRIG)&#10;&#10;query = &quot;&quot;&quot;&#10;PREFIX dcat: &lt;http://www.w3.org/ns/dcat#&gt;&#10;PREFIX dct: &lt;http://purl.org/dc/terms/&gt;&#10;&#10;SELECT ?dataset ?title ?issued&#10;WHERE {&#10;    ?dataset a dcat:Dataset ;&#10;             dct:title ?title ;&#10;             dct:issued ?issued .&#10;}&#10;LIMIT 3&#10;&quot;&quot;&quot;&#10;&#10;print(&quot;Executing query...&quot;)&#10;query_results = store.query(query)&#10;&#10;print(f&quot;Type of query_results: {type(query_results)}&quot;)&#10;print(f&quot;Query results: {query_results}&quot;)&#10;&#10;# Check if it has variables method&#10;print(f&quot;\ndir(query_results): {[m for m in dir(query_results) if not m.startswith('_')]}&quot;)&#10;&#10;# Try to get variables&#10;if hasattr(query_results, 'variables'):&#10;    print(f&quot;\n✓ Has .variables property!&quot;)&#10;    vars = query_results.variables  # Property, not method!&#10;    print(f&quot;Variables: {vars}&quot;)&#10;    print(f&quot;Variable types: {[type(v) for v in vars]}&quot;)&#10;    print(f&quot;Variable strings: {[str(v) for v in vars]}&quot;)&#10;&#10;# Convert to list and try first result&#10;results_list = list(query_results)&#10;print(f&quot;\nGot {len(results_list)} results&quot;)&#10;&#10;if results_list:&#10;    first = results_list[0]&#10;    print(f&quot;\nFirst result type: {type(first)}&quot;)&#10;&#10;    # Try accessing by string&#10;    print(&quot;\n--- Access by string key ---&quot;)&#10;    for var_name in ['dataset', 'title', 'issued']:&#10;        try:&#10;            value = first[var_name]&#10;            print(f&quot;✓ first['{var_name}'] = {value}&quot;)&#10;        except Exception as e:&#10;            print(f&quot;✗ first['{var_name}'] failed: {e}&quot;)&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ETL-RDF-STAR/static/js/yarrrml-builder.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ETL-RDF-STAR/static/js/yarrrml-builder.js" />
              <option name="originalContent" value="/**&#10; * YARRRML Builder - Visual Mapping Designer&#10; * Guides knowledge engineers through creating YARRRML mappings&#10; * Loads ontology from server-indexed classes and properties&#10; */&#10;&#10;class YARRRMLBuilder {&#10;    constructor() {&#10;        this.mapping = {&#10;            prefixes: {},&#10;            sources: {},&#10;            mappings: {}&#10;        };&#10;        this.currentStep = 0;&#10;        this.steps = ['sources', 'prefixes', 'classes', 'properties', 'review'];&#10;        this.ontology = null;&#10;        this.selectedClass = null;&#10;        this.visibleClasses = new Set();&#10;        this.ontologyIndex = new Map();&#10;        this.contextMenu = null;&#10;        this.detectedColumns = [];&#10;    }&#10;&#10;    init() {&#10;        console.log('YARRRMLBuilder.init() called');&#10;        this.renderBuilder();&#10;        this.loadDefaultPrefixes();&#10;&#10;        // Defer ontology loading until after container is visible&#10;        // The mode switch shows the container, then this runs&#10;        requestAnimationFrame(() =&gt; {&#10;            this.loadOntologyFromServer();&#10;        });&#10;    }&#10;&#10;    loadDefaultPrefixes() {&#10;        this.mapping.prefixes = {&#10;            'ex': 'http://example.org/',&#10;            'schema': 'http://schema.org/',&#10;            'foaf': 'http://xmlns.com/foaf/0.1/',&#10;            'prov': 'http://www.w3.org/ns/prov#',&#10;            'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',&#10;            'rdfs': 'http://www.w3.org/2000/01/rdf-schema#',&#10;            'xsd': 'http://www.w3.org/2001/XMLSchema#',&#10;            'dct': 'http://purl.org/dc/terms/',&#10;            'dcat': 'http://www.w3.org/ns/dcat#',&#10;            'owl': 'http://www.w3.org/2002/07/owl#'&#10;        };&#10;    }&#10;&#10;    /**&#10;     * Load ontology classes and properties from the server's /ontology endpoint&#10;     */&#10;    async loadOntologyFromServer() {&#10;        try {&#10;            // Add cache-busting parameter to ensure fresh data&#10;            const cacheBuster = Date.now();&#10;            const response = await fetch(`/ontology?_=${cacheBuster}`, {&#10;                cache: 'no-store',&#10;                headers: {&#10;                    'Cache-Control': 'no-cache'&#10;                }&#10;            });&#10;            if (!response.ok) {&#10;                throw new Error(`Failed to load ontology from server: ${response.status}`);&#10;            }&#10;&#10;            const data = await response.json();&#10;            console.log('Raw ontology response from server:', data);&#10;&#10;            // Check if we got any classes&#10;            if (!data.classes || data.classes.length === 0) {&#10;                console.warn('Server returned no ontology classes');&#10;                this.showOntologyError('No ontology classes found. Make sure your ontology files are loaded on the server.');&#10;                this.ontology = { classes: [], objectProperties: [], dataProperties: {} };&#10;                this.updateOntologyStats();&#10;                return;&#10;            }&#10;&#10;            // Deduplicate classes by URI&#10;            const uniqueClasses = new Map();&#10;            data.classes.forEach(c =&gt; {&#10;                if (!uniqueClasses.has(c.uri)) {&#10;                    uniqueClasses.set(c.uri, c);&#10;                }&#10;            });&#10;            const deduplicatedClasses = Array.from(uniqueClasses.values());&#10;            console.log(`Deduplicated ${data.classes.length} classes to ${deduplicatedClasses.length}`);&#10;&#10;            // Transform server response to our internal format&#10;            this.ontology = {&#10;                classes: deduplicatedClasses.map(c =&gt; ({&#10;                    id: this.extractLocalName(c.uri),&#10;                    label: this.cleanLabel(c.label),&#10;                    uri: c.uri,&#10;                    prefix: this.getPrefix(c.uri),&#10;                    // Ignore blank node parents (start with _:)&#10;                    parent: (c.parent &amp;&amp; !c.parent.startsWith('_:')) ? this.extractLocalName(c.parent) : null,&#10;                    comment: this.cleanLabel(c.comment)&#10;                })),&#10;                // Filter out object properties with null domain or range&#10;                objectProperties: data.objectProperties&#10;                    .filter(p =&gt; p.domain &amp;&amp; p.range &amp;&amp; !p.domain.startsWith('_:') &amp;&amp; !p.range.startsWith('_:'))&#10;                    .map(p =&gt; ({&#10;                        uri: p.uri,&#10;                        label: this.cleanLabel(p.label),&#10;                        from: this.extractLocalName(p.domain),&#10;                        to: this.extractLocalName(p.range),&#10;                        prefix: this.getPrefix(p.uri)&#10;                    })),&#10;                dataProperties: {}&#10;            };&#10;&#10;            // Group datatype properties by domain class&#10;            data.datatypeProperties.forEach(p =&gt; {&#10;                // Skip if domain is blank node or null&#10;                if (!p.domain || p.domain.startsWith('_:')) return;&#10;&#10;                const domain = this.extractLocalName(p.domain);&#10;                if (!this.ontology.dataProperties[domain]) {&#10;                    this.ontology.dataProperties[domain] = [];&#10;                }&#10;                this.ontology.dataProperties[domain].push({&#10;                    name: this.cleanLabel(p.label),&#10;                    uri: p.uri,&#10;                    type: this.extractDatatype(p.range),&#10;                    prefix: this.getPrefix(p.uri)&#10;                });&#10;            });&#10;&#10;            console.log(`Loaded ontology: ${data.counts.classes} classes, ${data.counts.objectProperties} object properties, ${data.counts.datatypeProperties} datatype properties`);&#10;            console.log('Transformed classes:', this.ontology.classes.map(c =&gt; c.id));&#10;            console.log('Transformed object properties:', this.ontology.objectProperties.length,&#10;                this.ontology.objectProperties.map(p =&gt; `${p.from} --${p.label}--&gt; ${p.to}`));&#10;&#10;            this.buildSearchIndex();&#10;            this.updateOntologyStats();&#10;&#10;            // Show all classes initially - with delay to ensure DOM is laid out&#10;            if (this.ontology.classes.length &gt; 0) {&#10;                setTimeout(() =&gt; {&#10;                    console.log('Initializing graph after ontology load');&#10;                    const container = document.getElementById('ontology-graph');&#10;                    if (!container) {&#10;                        console.error('Container not found');&#10;                        return;&#10;                    }&#10;                    console.log('Container size:', container.getBoundingClientRect());&#10;                    this.initOntologyGraph();&#10;&#10;                    // Show all classes - don't try to focus on just one&#10;                    this.visibleClasses.clear();&#10;                    this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;                    console.log('Initial visible classes:', Array.from(this.visibleClasses));&#10;&#10;                    this.renderOntologyGraph();&#10;                }, 200);&#10;            }&#10;&#10;        } catch (error) {&#10;            console.error('Error loading ontology:', error);&#10;            this.showOntologyError(`Failed to load ontology: ${error.message}. Is the server running?`);&#10;            this.ontology = { classes: [], objectProperties: [], dataProperties: {} };&#10;            this.updateOntologyStats();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Show an error message in the ontology panel&#10;     */&#10;    showOntologyError(message) {&#10;        const details = document.getElementById('ontology-details');&#10;        if (details) {&#10;            details.innerHTML = `&#10;                &lt;div class=&quot;empty-state error&quot;&gt;&#10;                    &lt;svg width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&#10;                        &lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z&quot;/&gt;&#10;                    &lt;/svg&gt;&#10;                    &lt;p&gt;${message}&lt;/p&gt;&#10;                    &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.loadOntologyFromServer()&quot;&gt;&#10;                        Retry&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        // Also clear the graph&#10;        const svg = d3.select('#ontology-canvas');&#10;        const g = svg.select('g.ontology-content');&#10;        if (g.node()) {&#10;            g.selectAll('*').remove();&#10;        }&#10;    }&#10;&#10;    extractLocalName(uri) {&#10;        if (!uri) return '';&#10;        const hashIdx = uri.lastIndexOf('#');&#10;        const slashIdx = uri.lastIndexOf('/');&#10;        const idx = Math.max(hashIdx, slashIdx);&#10;        return idx &gt;= 0 ? uri.substring(idx + 1) : uri;&#10;    }&#10;&#10;    /**&#10;     * Clean label by removing language tags, quotes, and extra whitespace&#10;     * e.g., '&quot;Activity&quot;@en' becomes 'Activity'&#10;     */&#10;    cleanLabel(label) {&#10;        if (!label) return '';&#10;        let cleaned = label;&#10;        // Remove language tags like @en, @de&#10;        cleaned = cleaned.replace(/@[a-z]{2,}(-[A-Z]{2,})?$/i, '');&#10;        // Remove surrounding quotes&#10;        cleaned = cleaned.replace(/^[&quot;']|[&quot;']$/g, '');&#10;        // Trim whitespace&#10;        cleaned = cleaned.trim();&#10;        return cleaned || label;&#10;    }&#10;&#10;    getPrefix(uri) {&#10;        if (!uri) return 'ex';&#10;        for (const [prefix, ns] of Object.entries(this.mapping.prefixes)) {&#10;            if (uri.startsWith(ns)) {&#10;                return prefix;&#10;            }&#10;        }&#10;        // Try to extract prefix from common patterns&#10;        if (uri.includes('schema.org')) return 'schema';&#10;        if (uri.includes('foaf')) return 'foaf';&#10;        if (uri.includes('prov')) return 'prov';&#10;        if (uri.includes('dcat')) return 'dcat';&#10;        if (uri.includes('dc/terms')) return 'dct';&#10;        if (uri.includes('owl')) return 'owl';&#10;        if (uri.includes('rdfs')) return 'rdfs';&#10;        if (uri.includes('rdf')) return 'rdf';&#10;        return 'ex';&#10;    }&#10;&#10;    extractDatatype(rangeUri) {&#10;        if (!rangeUri) return 'string';&#10;        const local = this.extractLocalName(rangeUri);&#10;        if (local.includes('int') || local.includes('Int')) return 'integer';&#10;        if (local.includes('decimal') || local.includes('float') || local.includes('double')) return 'decimal';&#10;        if (local.includes('date') &amp;&amp; local.includes('Time')) return 'dateTime';&#10;        if (local.includes('date') || local.includes('Date')) return 'date';&#10;        if (local.includes('bool')) return 'boolean';&#10;        return 'string';&#10;    }&#10;&#10;    renderBuilder() {&#10;        const container = document.getElementById('yarrrml-builder');&#10;&#10;        container.innerHTML = `&#10;            &lt;div class=&quot;yarrrml-layout&quot;&gt;&#10;                &lt;!-- Left: Wizard Panel --&gt;&#10;                &lt;div class=&quot;wizard-panel&quot;&gt;&#10;                    &lt;div class=&quot;yarrrml-wizard&quot;&gt;&#10;                        &lt;!-- Progress Steps --&gt;&#10;                        &lt;div class=&quot;wizard-progress&quot;&gt;&#10;                            ${this.steps.map((step, i) =&gt; `&#10;                                &lt;div class=&quot;progress-step ${i === this.currentStep ? 'active' : ''} ${i &lt; this.currentStep ? 'completed' : ''}&quot; data-step=&quot;${i}&quot;&gt;&#10;                                    &lt;div class=&quot;step-number&quot;&gt;${i + 1}&lt;/div&gt;&#10;                                    &lt;div class=&quot;step-label&quot;&gt;${this.getStepLabel(step)}&lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            `).join('&lt;div class=&quot;progress-line&quot;&gt;&lt;/div&gt;')}&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Wizard Content --&gt;&#10;                        &lt;div class=&quot;wizard-content&quot;&gt;&#10;                            ${this.renderCurrentStep()}&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Navigation --&gt;&#10;                        &lt;div class=&quot;wizard-nav&quot;&gt;&#10;                            &lt;button class=&quot;btn btn-secondary&quot; id=&quot;wizard-prev&quot; ${this.currentStep === 0 ? 'disabled' : ''}&gt;&#10;                                &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z&quot;/&gt;&lt;/svg&gt;&#10;                                Previous&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-primary&quot; id=&quot;wizard-next&quot;&gt;&#10;                                ${this.currentStep === this.steps.length - 1 ? 'Generate YARRRML' : 'Next'}&#10;                                &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Right: Ontology Browser Panel --&gt;&#10;                &lt;div class=&quot;ontology-browser&quot;&gt;&#10;                    &lt;div class=&quot;ontology-header&quot;&gt;&#10;                        &lt;h3&gt;&#10;                            &lt;svg width=&quot;18&quot; height=&quot;18&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&#10;                                &lt;path d=&quot;M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z&quot;/&gt;&#10;                            &lt;/svg&gt;&#10;                            Ontology Browser&#10;                        &lt;/h3&gt;&#10;                        &lt;span class=&quot;ontology-stats&quot; id=&quot;ontology-stats&quot;&gt;&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Search Box --&gt;&#10;                    &lt;div class=&quot;ontology-search&quot;&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;ontology-search&quot; placeholder=&quot;Search classes, properties...&quot;&#10;                               onkeyup=&quot;yarrrmlBuilder.searchOntology(this.value)&quot;&gt;&#10;                        &lt;div class=&quot;search-results&quot; id=&quot;search-results&quot;&gt;&lt;/div&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Graph Area --&gt;&#10;                    &lt;div class=&quot;ontology-graph-area&quot;&gt;&#10;                        &lt;div class=&quot;graph-toolbar&quot;&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.resetOntologyView()&quot; title=&quot;Reset View&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z&quot;/&gt;&lt;/svg&gt;&#10;                                Reset&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.expandAll()&quot; title=&quot;Expand All&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z&quot;/&gt;&lt;/svg&gt;&#10;                                Expand&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.loadOntologyFromServer()&quot; title=&quot;Reload from Server&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z&quot;/&gt;&lt;/svg&gt;&#10;                                Reload&#10;                            &lt;/button&gt;&#10;                            &lt;span class=&quot;graph-hint&quot;&gt;Right-click to expand&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;ontology-graph&quot; id=&quot;ontology-graph&quot;&gt;&#10;                            &lt;svg id=&quot;ontology-canvas&quot;&gt;&lt;/svg&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Class Details Panel --&gt;&#10;                    &lt;div class=&quot;ontology-details&quot; id=&quot;ontology-details&quot;&gt;&#10;                        &lt;div class=&quot;empty-state small&quot;&gt;&#10;                            &lt;p&gt;Search for a class or click one in the graph&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;!-- Context Menu (hidden by default) --&gt;&#10;            &lt;div class=&quot;context-menu&quot; id=&quot;context-menu&quot; style=&quot;display: none;&quot;&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;expand&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z&quot;/&gt;&lt;/svg&gt;&#10;                    Expand Neighbors&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;focus&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z&quot;/&gt;&lt;/svg&gt;&#10;                    Focus on This Class&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;hide&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27z&quot;/&gt;&lt;/svg&gt;&#10;                    Hide This Class&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-divider&quot;&gt;&lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;use-mapping&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Use in Mapping&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;&#10;        this.bindWizardEvents();&#10;        // Don't init graph here - it's done after ontology loads when container is visible&#10;        this.bindContextMenu();&#10;        this.bindDropdownHandlers();&#10;        this.updateOntologyStats();&#10;        console.log('renderBuilder() complete, ontology-graph element:', document.getElementById('ontology-graph'));&#10;    }&#10;&#10;    bindDropdownHandlers() {&#10;        // Close dropdowns when clicking outside&#10;        document.addEventListener('click', (e) =&gt; {&#10;            const classDropdown = document.getElementById('class-dropdown');&#10;            const predicateDropdown = document.getElementById('predicate-dropdown');&#10;&#10;            if (classDropdown &amp;&amp; !e.target.closest('.class-search-wrapper')) {&#10;                classDropdown.style.display = 'none';&#10;            }&#10;            if (predicateDropdown &amp;&amp; !e.target.closest('.predicate-search-wrapper')) {&#10;                predicateDropdown.style.display = 'none';&#10;            }&#10;        });&#10;    }&#10;&#10;    updateOntologyStats() {&#10;        const statsEl = document.getElementById('ontology-stats');&#10;        if (statsEl &amp;&amp; this.ontology) {&#10;            const classCount = this.ontology.classes?.length || 0;&#10;            const propCount = (this.ontology.objectProperties?.length || 0) +&#10;                Object.values(this.ontology.dataProperties || {}).reduce((sum, arr) =&gt; sum + arr.length, 0);&#10;            statsEl.textContent = `${classCount} classes, ${propCount} properties`;&#10;        }&#10;    }&#10;&#10;    getStepLabel(step) {&#10;        const labels = {&#10;            'sources': 'Data Sources',&#10;            'prefixes': 'Prefixes',&#10;            'classes': 'Class Mappings',&#10;            'properties': 'Properties',&#10;            'review': 'Review &amp; Export'&#10;        };&#10;        return labels[step];&#10;    }&#10;&#10;    renderCurrentStep() {&#10;        const step = this.steps[this.currentStep];&#10;&#10;        switch(step) {&#10;            case 'sources':&#10;                return this.renderSourcesStep();&#10;            case 'prefixes':&#10;                return this.renderPrefixesStep();&#10;            case 'classes':&#10;                return this.renderClassesStep();&#10;            case 'properties':&#10;                return this.renderPropertiesStep();&#10;            case 'review':&#10;                return this.renderReviewStep();&#10;            default:&#10;                return '&lt;p&gt;Unknown step&lt;/p&gt;';&#10;        }&#10;    }&#10;&#10;    renderSourcesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 1: Define Data Sources&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Specify the data sources that will be transformed into RDF.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;sources-list&quot; id=&quot;sources-list&quot;&gt;&#10;                    ${this.renderSourcesList()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addSource()&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Add Source&#10;                &lt;/button&gt;&#10;&#10;                &lt;!-- CSV Preview Section --&gt;&#10;                &lt;div class=&quot;csv-preview-section&quot; id=&quot;csv-preview-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z&quot;/&gt;&lt;/svg&gt;&#10;                        Detected Columns&#10;                    &lt;/h4&gt;&#10;                    &lt;div class=&quot;csv-columns&quot; id=&quot;csv-columns&quot;&gt;&lt;/div&gt;&#10;                    &lt;div class=&quot;csv-sample&quot; id=&quot;csv-sample&quot;&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- File Upload --&gt;&#10;                &lt;div class=&quot;file-upload-section&quot;&gt;&#10;                    &lt;label class=&quot;file-upload-label&quot;&gt;&#10;                        &lt;input type=&quot;file&quot; id=&quot;csv-file-input&quot; accept=&quot;.csv&quot; onchange=&quot;yarrrmlBuilder.handleCSVUpload(event)&quot; style=&quot;display:none;&quot;&gt;&#10;                        &lt;span class=&quot;btn btn-secondary&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z&quot;/&gt;&lt;/svg&gt;&#10;                            Upload CSV to Preview Columns&#10;                        &lt;/span&gt;&#10;                    &lt;/label&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Supported Sources&#10;                    &lt;/h4&gt;&#10;                    &lt;ul&gt;&#10;                        &lt;li&gt;&lt;strong&gt;CSV/JSON/XML:&lt;/strong&gt; File path or URL&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Databases:&lt;/strong&gt; PostgreSQL, MySQL, Oracle, SQL Server&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;SPARQL:&lt;/strong&gt; Query remote endpoints&lt;/li&gt;&#10;                    &lt;/ul&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    handleCSVUpload(event) {&#10;        const file = event.target.files[0];&#10;        if (!file) return;&#10;&#10;        const reader = new FileReader();&#10;        reader.onload = (e) =&gt; {&#10;            const text = e.target.result;&#10;            this.parseCSVPreview(text, file.name);&#10;        };&#10;        reader.readAsText(file);&#10;    }&#10;&#10;    parseCSVPreview(csvText, fileName) {&#10;        const lines = csvText.split('\n').filter(l =&gt; l.trim());&#10;        if (lines.length === 0) return;&#10;&#10;        const headers = this.parseCSVLine(lines[0]);&#10;        this.detectedColumns = headers;&#10;&#10;        const sampleRows = [];&#10;        for (let i = 1; i &lt; Math.min(4, lines.length); i++) {&#10;            sampleRows.push(this.parseCSVLine(lines[i]));&#10;        }&#10;&#10;        const accessInput = document.getElementById('new-source-access');&#10;        if (accessInput) {&#10;            accessInput.value = `data/${fileName}`;&#10;        }&#10;&#10;        const previewSection = document.getElementById('csv-preview-section');&#10;        const columnsDiv = document.getElementById('csv-columns');&#10;        const sampleDiv = document.getElementById('csv-sample');&#10;&#10;        if (previewSection &amp;&amp; columnsDiv) {&#10;            previewSection.style.display = 'block';&#10;&#10;            columnsDiv.innerHTML = `&#10;                &lt;div class=&quot;column-chips&quot;&gt;&#10;                    ${headers.map(h =&gt; `&lt;span class=&quot;column-chip&quot;&gt;${h}&lt;/span&gt;`).join('')}&#10;                &lt;/div&gt;&#10;            `;&#10;&#10;            if (sampleRows.length &gt; 0) {&#10;                sampleDiv.innerHTML = `&#10;                    &lt;table class=&quot;csv-sample-table&quot;&gt;&#10;                        &lt;thead&gt;&#10;                            &lt;tr&gt;${headers.map(h =&gt; `&lt;th&gt;${h}&lt;/th&gt;`).join('')}&lt;/tr&gt;&#10;                        &lt;/thead&gt;&#10;                        &lt;tbody&gt;&#10;                            ${sampleRows.map(row =&gt; `&#10;                                &lt;tr&gt;${row.map(cell =&gt; `&lt;td&gt;${cell || ''}&lt;/td&gt;`).join('')}&lt;/tr&gt;&#10;                            `).join('')}&#10;                        &lt;/tbody&gt;&#10;                    &lt;/table&gt;&#10;                `;&#10;            }&#10;        }&#10;    }&#10;&#10;    parseCSVLine(line) {&#10;        const result = [];&#10;        let current = '';&#10;        let inQuotes = false;&#10;&#10;        for (let i = 0; i &lt; line.length; i++) {&#10;            const char = line[i];&#10;            if (char === '&quot;') {&#10;                inQuotes = !inQuotes;&#10;            } else if (char === ',' &amp;&amp; !inQuotes) {&#10;                result.push(current.trim());&#10;                current = '';&#10;            } else {&#10;                current += char;&#10;            }&#10;        }&#10;        result.push(current.trim());&#10;        return result;&#10;    }&#10;&#10;    renderSourcesList() {&#10;        const sources = Object.entries(this.mapping.sources);&#10;&#10;        if (sources.length === 0) {&#10;            return `&#10;                &lt;div class=&quot;source-item new&quot;&gt;&#10;                    &lt;div class=&quot;form-row&quot;&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Source Name&lt;/label&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-source-name&quot; placeholder=&quot;e.g., source1&quot; value=&quot;&quot;&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Type&lt;/label&gt;&#10;                            &lt;select id=&quot;new-source-type&quot; onchange=&quot;yarrrmlBuilder.onSourceTypeChange(this.value)&quot;&gt;&#10;                                &lt;option value=&quot;csv&quot;&gt;CSV&lt;/option&gt;&#10;                                &lt;option value=&quot;json&quot;&gt;JSON&lt;/option&gt;&#10;                                &lt;option value=&quot;xml&quot;&gt;XML&lt;/option&gt;&#10;                                &lt;option value=&quot;postgresql&quot;&gt;PostgreSQL&lt;/option&gt;&#10;                                &lt;option value=&quot;mysql&quot;&gt;MySQL&lt;/option&gt;&#10;                                &lt;option value=&quot;sparql&quot;&gt;SPARQL&lt;/option&gt;&#10;                            &lt;/select&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;Access Path / Connection&lt;/label&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;new-source-access&quot; placeholder=&quot;data/source.csv&quot; value=&quot;&quot;&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group db-options&quot; id=&quot;db-options&quot; style=&quot;display:none;&quot;&gt;&#10;                        &lt;label&gt;Query&lt;/label&gt;&#10;                        &lt;textarea id=&quot;new-source-query&quot; placeholder=&quot;SELECT * FROM table&quot;&gt;&lt;/textarea&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        return sources.map(([name, config]) =&gt; `&#10;            &lt;div class=&quot;source-item&quot;&gt;&#10;                &lt;div class=&quot;source-header&quot;&gt;&#10;                    &lt;span class=&quot;source-name&quot;&gt;${name}&lt;/span&gt;&#10;                    &lt;span class=&quot;source-type-badge&quot;&gt;${config.type || 'csv'}&lt;/span&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removeSource('${name}')&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;source-details&quot;&gt;&#10;                    &lt;code&gt;${config.access}&lt;/code&gt;&#10;                    ${config.columns ? `&lt;div class=&quot;source-columns&quot;&gt;${config.columns.length} columns detected&lt;/div&gt;` : ''}&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    onSourceTypeChange(type) {&#10;        const dbOptions = document.getElementById('db-options');&#10;        if (dbOptions) {&#10;            dbOptions.style.display = ['postgresql', 'mysql', 'oracle', 'sparql'].includes(type) ? 'block' : 'none';&#10;        }&#10;    }&#10;&#10;    renderPrefixesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 2: Configure Prefixes&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Define namespace prefixes for your ontology.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;prefixes-grid&quot; id=&quot;prefixes-grid&quot;&gt;&#10;                    ${Object.entries(this.mapping.prefixes).map(([prefix, uri]) =&gt; `&#10;                        &lt;div class=&quot;prefix-item&quot;&gt;&#10;                            &lt;input type=&quot;text&quot; class=&quot;prefix-key&quot; value=&quot;${prefix}&quot; readonly&gt;&#10;                            &lt;input type=&quot;text&quot; class=&quot;prefix-uri&quot; value=&quot;${uri}&quot;&gt;&#10;                            &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePrefix('${prefix}')&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    `).join('')}&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;add-prefix-form&quot;&gt;&#10;                    &lt;input type=&quot;text&quot; id=&quot;new-prefix-key&quot; placeholder=&quot;prefix&quot;&gt;&#10;                    &lt;input type=&quot;text&quot; id=&quot;new-prefix-uri&quot; placeholder=&quot;http://example.org/ontology#&quot;&gt;&#10;                    &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addPrefix()&quot;&gt;Add&lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    renderClassesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 3: Define Class Mappings&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Map source rows to RDF classes. Use the ontology browser to find classes.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;class-mappings&quot; id=&quot;class-mappings&quot;&gt;&#10;                    ${this.renderClassMappings()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addClassMapping()&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Add Class Mapping&#10;                &lt;/button&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Subject Template&#10;                    &lt;/h4&gt;&#10;                    &lt;p&gt;Use &lt;code&gt;$(column)&lt;/code&gt; for source columns.&lt;/p&gt;&#10;                    &lt;p&gt;Example: &lt;code&gt;http://example.org/resource/$(id)&lt;/code&gt;&lt;/p&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    renderClassMappings() {&#10;        const mappings = Object.entries(this.mapping.mappings);&#10;        const sourceOptions = Object.keys(this.mapping.sources).length &gt; 0&#10;            ? Object.keys(this.mapping.sources).map(s =&gt; `&lt;option value=&quot;${s}&quot;&gt;${s}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Define a source first --&lt;/option&gt;';&#10;&#10;        // Build class options from ontology&#10;        const classOptions = this.ontology?.classes?.length &gt; 0&#10;            ? this.ontology.classes.map(c =&gt; `&lt;option value=&quot;${c.prefix}:${c.label}&quot;&gt;${c.prefix}:${c.label}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Load ontology first --&lt;/option&gt;';&#10;&#10;        if (mappings.length === 0) {&#10;            return `&#10;                &lt;div class=&quot;class-mapping-item new&quot;&gt;&#10;                    &lt;div class=&quot;form-row&quot;&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Mapping Name&lt;/label&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-mapping-name&quot; placeholder=&quot;e.g., DatasetMapping&quot; value=&quot;&quot;&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Source&lt;/label&gt;&#10;                            &lt;select id=&quot;new-mapping-source&quot;&gt;&#10;                                ${sourceOptions}&#10;                            &lt;/select&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;Subject Template&lt;/label&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;new-mapping-subject&quot; placeholder=&quot;http://example.org/resource/$(id)&quot; value=&quot;&quot;&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;RDF Class&lt;/label&gt;&#10;                        &lt;div class=&quot;class-search-wrapper&quot;&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-mapping-class-search&quot;&#10;                                   placeholder=&quot;Type to search classes...&quot;&#10;                                   oninput=&quot;yarrrmlBuilder.filterClassOptions(this.value)&quot;&#10;                                   onfocus=&quot;yarrrmlBuilder.showClassDropdown()&quot;&gt;&#10;                            &lt;input type=&quot;hidden&quot; id=&quot;new-mapping-class&quot; value=&quot;&quot;&gt;&#10;                            &lt;div class=&quot;class-dropdown&quot; id=&quot;class-dropdown&quot; style=&quot;display: none;&quot;&gt;&#10;                                ${this.ontology?.classes?.map(c =&gt; `&#10;                                    &lt;div class=&quot;class-option&quot; onclick=&quot;yarrrmlBuilder.selectClassOption('${c.prefix}:${c.label}', '${c.id}')&quot;&gt;&#10;                                        &lt;span class=&quot;class-option-label&quot;&gt;${c.prefix}:${c.label}&lt;/span&gt;&#10;                                        &lt;span class=&quot;class-option-uri&quot;&gt;${c.uri}&lt;/span&gt;&#10;                                    &lt;/div&gt;&#10;                                `).join('') || '&lt;div class=&quot;class-option disabled&quot;&gt;No classes loaded&lt;/div&gt;'}&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        return mappings.map(([name, config]) =&gt; `&#10;            &lt;div class=&quot;class-mapping-item&quot;&gt;&#10;                &lt;div class=&quot;mapping-header&quot;&gt;&#10;                    &lt;span class=&quot;mapping-name&quot;&gt;${name}&lt;/span&gt;&#10;                    &lt;span class=&quot;mapping-class-badge&quot;&gt;${config.class || 'No class'}&lt;/span&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removeMapping('${name}')&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;mapping-details&quot;&gt;&#10;                    &lt;div&gt;Source: &lt;code&gt;${config.source}&lt;/code&gt;&lt;/div&gt;&#10;                    &lt;div&gt;Subject: &lt;code&gt;${config.subject}&lt;/code&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    showClassDropdown() {&#10;        const dropdown = document.getElementById('class-dropdown');&#10;        if (dropdown) {&#10;            dropdown.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    filterClassOptions(query) {&#10;        const dropdown = document.getElementById('class-dropdown');&#10;        if (!dropdown || !this.ontology?.classes) return;&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const filtered = this.ontology.classes.filter(c =&gt;&#10;            c.label.toLowerCase().includes(queryLower) ||&#10;            c.id.toLowerCase().includes(queryLower) ||&#10;            c.prefix.toLowerCase().includes(queryLower)&#10;        );&#10;&#10;        dropdown.innerHTML = filtered.length &gt; 0&#10;            ? filtered.map(c =&gt; `&#10;                &lt;div class=&quot;class-option&quot; onclick=&quot;yarrrmlBuilder.selectClassOption('${c.prefix}:${c.label}', '${c.id}')&quot;&gt;&#10;                    &lt;span class=&quot;class-option-label&quot;&gt;${c.prefix}:${c.label}&lt;/span&gt;&#10;                    &lt;span class=&quot;class-option-uri&quot;&gt;${c.uri}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            `).join('')&#10;            : '&lt;div class=&quot;class-option disabled&quot;&gt;No matching classes&lt;/div&gt;';&#10;&#10;        dropdown.style.display = 'block';&#10;    }&#10;&#10;    selectClassOption(classUri, classId) {&#10;        const searchInput = document.getElementById('new-mapping-class-search');&#10;        const hiddenInput = document.getElementById('new-mapping-class');&#10;        const dropdown = document.getElementById('class-dropdown');&#10;&#10;        if (searchInput) searchInput.value = classUri;&#10;        if (hiddenInput) hiddenInput.value = classUri;&#10;        if (dropdown) dropdown.style.display = 'none';&#10;&#10;        // Also focus on this class in the ontology browser&#10;        this.focusOnClass(classId);&#10;    }&#10;&#10;    renderPropertiesStep() {&#10;        const mappingOptions = Object.keys(this.mapping.mappings).length &gt; 0&#10;            ? Object.keys(this.mapping.mappings).map(m =&gt; `&lt;option value=&quot;${m}&quot;&gt;${m}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Define a mapping first --&lt;/option&gt;';&#10;&#10;        // Get detected columns from source&#10;        const columns = this.detectedColumns || [];&#10;        const columnOptions = columns.length &gt; 0&#10;            ? columns.map(c =&gt; `&lt;option value=&quot;${c}&quot;&gt;${c}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Upload CSV to detect columns --&lt;/option&gt;';&#10;&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 4: Map Properties&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Map source columns to RDF predicates. For object properties (IRI references), you can construct URIs from prefix + column values.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;property-mapping-section&quot;&gt;&#10;                    &lt;div class=&quot;mapping-selector&quot;&gt;&#10;                        &lt;label&gt;Target Mapping:&lt;/label&gt;&#10;                        &lt;select id=&quot;property-mapping-select&quot; onchange=&quot;yarrrmlBuilder.onMappingChange(this.value)&quot;&gt;&#10;                            ${mappingOptions}&#10;                        &lt;/select&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;properties-table&quot;&gt;&#10;                        &lt;table&gt;&#10;                            &lt;thead&gt;&#10;                                &lt;tr&gt;&#10;                                    &lt;th style=&quot;width: 30%;&quot;&gt;RDF Predicate&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 35%;&quot;&gt;Value Template&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 15%;&quot;&gt;Type&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 10%;&quot;&gt;Provenance&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 10%;&quot;&gt;&lt;/th&gt;&#10;                                &lt;/tr&gt;&#10;                            &lt;/thead&gt;&#10;                            &lt;tbody id=&quot;properties-tbody&quot;&gt;&#10;                                ${this.renderPropertyRows()}&#10;                            &lt;/tbody&gt;&#10;                        &lt;/table&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;add-property-form&quot;&gt;&#10;                        &lt;h4&gt;Add Property Mapping&lt;/h4&gt;&#10;&#10;                        &lt;div class=&quot;form-row&quot;&gt;&#10;                            &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                &lt;label&gt;RDF Predicate&lt;/label&gt;&#10;                                &lt;div class=&quot;predicate-search-wrapper&quot;&gt;&#10;                                    &lt;input type=&quot;text&quot; id=&quot;new-prop-predicate&quot;&#10;                                           placeholder=&quot;Type to search properties...&quot;&#10;                                           oninput=&quot;yarrrmlBuilder.filterPredicateOptions(this.value)&quot;&#10;                                           onfocus=&quot;yarrrmlBuilder.showPredicateDropdown()&quot;&gt;&#10;                                    &lt;div class=&quot;predicate-dropdown&quot; id=&quot;predicate-dropdown&quot; style=&quot;display: none;&quot;&gt;&#10;                                        ${this.renderPredicateOptions()}&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.8;&quot;&gt;&#10;                                &lt;label&gt;Value Type&lt;/label&gt;&#10;                                &lt;select id=&quot;new-prop-type&quot; onchange=&quot;yarrrmlBuilder.onValueTypeChange(this.value)&quot;&gt;&#10;                                    &lt;option value=&quot;literal&quot;&gt;Literal (Data Property)&lt;/option&gt;&#10;                                    &lt;option value=&quot;iri&quot;&gt;IRI (Object Property)&lt;/option&gt;&#10;                                &lt;/select&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Literal Value Section --&gt;&#10;                        &lt;div id=&quot;literal-value-section&quot;&gt;&#10;                            &lt;div class=&quot;form-row&quot;&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                    &lt;label&gt;Source Column&lt;/label&gt;&#10;                                    &lt;select id=&quot;new-prop-column&quot;&gt;&#10;                                        &lt;option value=&quot;&quot;&gt;Select column...&lt;/option&gt;&#10;                                        ${columnOptions}&#10;                                    &lt;/select&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                    &lt;label&gt;Or Custom Value&lt;/label&gt;&#10;                                    &lt;input type=&quot;text&quot; id=&quot;new-prop-column-custom&quot; placeholder=&quot;column_name or static value&quot;&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.8;&quot;&gt;&#10;                                    &lt;label&gt;Datatype&lt;/label&gt;&#10;                                    &lt;select id=&quot;new-prop-datatype&quot;&gt;&#10;                                        &lt;option value=&quot;string&quot;&gt;String&lt;/option&gt;&#10;                                        &lt;option value=&quot;integer&quot;&gt;Integer&lt;/option&gt;&#10;                                        &lt;option value=&quot;decimal&quot;&gt;Decimal&lt;/option&gt;&#10;                                        &lt;option value=&quot;date&quot;&gt;Date&lt;/option&gt;&#10;                                        &lt;option value=&quot;dateTime&quot;&gt;DateTime&lt;/option&gt;&#10;                                        &lt;option value=&quot;boolean&quot;&gt;Boolean&lt;/option&gt;&#10;                                    &lt;/select&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- IRI Value Section (for Object Properties) --&gt;&#10;                        &lt;div id=&quot;iri-value-section&quot; style=&quot;display: none;&quot;&gt;&#10;                            &lt;div class=&quot;iri-builder&quot;&gt;&#10;                                &lt;div class=&quot;iri-mode-selector&quot;&gt;&#10;                                    &lt;label class=&quot;radio-option&quot;&gt;&#10;                                        &lt;input type=&quot;radio&quot; name=&quot;iri-mode&quot; value=&quot;template&quot; checked onchange=&quot;yarrrmlBuilder.onIriModeChange('template')&quot;&gt;&#10;                                        &lt;span&gt;Build IRI from prefix + template&lt;/span&gt;&#10;                                    &lt;/label&gt;&#10;                                    &lt;label class=&quot;radio-option&quot;&gt;&#10;                                        &lt;input type=&quot;radio&quot; name=&quot;iri-mode&quot; value=&quot;column&quot; onchange=&quot;yarrrmlBuilder.onIriModeChange('column')&quot;&gt;&#10;                                        &lt;span&gt;Use column containing full URI&lt;/span&gt;&#10;                                    &lt;/label&gt;&#10;                                &lt;/div&gt;&#10;&#10;                                &lt;div id=&quot;iri-template-section&quot;&gt;&#10;                                    &lt;p class=&quot;form-hint&quot;&gt;Construct an IRI using a prefix and column value(s). Use $(column) syntax.&lt;/p&gt;&#10;&#10;                                    &lt;div class=&quot;form-row&quot;&gt;&#10;                                        &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.5;&quot;&gt;&#10;                                            &lt;label&gt;Prefix&lt;/label&gt;&#10;                                            &lt;select id=&quot;new-prop-iri-prefix&quot; onchange=&quot;yarrrmlBuilder.updateIriPreview()&quot;&gt;&#10;                                                ${Object.keys(this.mapping.prefixes).map(p =&gt;&#10;                                                    `&lt;option value=&quot;${p}&quot;&gt;${p}:&lt;/option&gt;`&#10;                                                ).join('')}&#10;                                            &lt;/select&gt;&#10;                                        &lt;/div&gt;&#10;                                        &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                            &lt;label&gt;Local Part (use $(column) for dynamic values)&lt;/label&gt;&#10;                                            &lt;input type=&quot;text&quot; id=&quot;new-prop-iri-local&quot;&#10;                                                   placeholder=&quot;e.g., organization/$(org_id) or theme/$(theme_code)&quot;&#10;                                                   oninput=&quot;yarrrmlBuilder.updateIriPreview()&quot;&gt;&#10;                                        &lt;/div&gt;&#10;                                    &lt;/div&gt;&#10;&#10;                                    &lt;div class=&quot;iri-preview&quot;&gt;&#10;                                        &lt;label&gt;Preview:&lt;/label&gt;&#10;                                        &lt;code id=&quot;iri-preview-value&quot;&gt;ex:resource/$(column)&lt;/code&gt;&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;&#10;                                &lt;div id=&quot;iri-column-section&quot; style=&quot;display: none;&quot;&gt;&#10;                                    &lt;p class=&quot;form-hint&quot;&gt;Select a column that contains the complete URI value.&lt;/p&gt;&#10;                                    &lt;div class=&quot;form-group&quot;&gt;&#10;                                        &lt;label&gt;Column with URI&lt;/label&gt;&#10;                                        &lt;select id=&quot;new-prop-iri-column&quot;&gt;&#10;                                            &lt;option value=&quot;&quot;&gt;Select column...&lt;/option&gt;&#10;                                            ${columnOptions}&#10;                                        &lt;/select&gt;&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;form-row&quot; style=&quot;margin-top: 15px;&quot;&gt;&#10;                            &lt;div class=&quot;form-group&quot;&gt;&#10;                                &lt;label class=&quot;checkbox-wrapper&quot;&gt;&#10;                                    &lt;input type=&quot;checkbox&quot; id=&quot;new-prop-provenance&quot;&gt;&#10;                                    Track Provenance (adds RDF-star annotations)&#10;                                &lt;/label&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;yarrrmlBuilder.addPropertyFromForm()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                            Add Property Mapping&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Examples&#10;                    &lt;/h4&gt;&#10;                    &lt;ul&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Data Property:&lt;/strong&gt; &lt;code&gt;dct:title&lt;/code&gt; → &lt;code&gt;$(title_column)&lt;/code&gt; as String&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Object Property (template):&lt;/strong&gt; &lt;code&gt;dct:publisher&lt;/code&gt; → &lt;code&gt;ex:organization/$(org_id)&lt;/code&gt; as IRI&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Object Property (column):&lt;/strong&gt; &lt;code&gt;dcat:theme&lt;/code&gt; → column &lt;code&gt;theme_uri&lt;/code&gt; containing full URI&lt;/li&gt;&#10;                    &lt;/ul&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    onValueTypeChange(valueType) {&#10;        const literalSection = document.getElementById('literal-value-section');&#10;        const iriSection = document.getElementById('iri-value-section');&#10;&#10;        if (valueType === 'iri') {&#10;            literalSection.style.display = 'none';&#10;            iriSection.style.display = 'block';&#10;        } else {&#10;            literalSection.style.display = 'block';&#10;            iriSection.style.display = 'none';&#10;        }&#10;&#10;        this.updateIriPreview();&#10;    }&#10;&#10;    onIriModeChange(mode) {&#10;        const templateSection = document.getElementById('iri-template-section');&#10;        const columnSection = document.getElementById('iri-column-section');&#10;&#10;        if (mode === 'template') {&#10;            templateSection.style.display = 'block';&#10;            columnSection.style.display = 'none';&#10;        } else {&#10;            templateSection.style.display = 'none';&#10;            columnSection.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    updateIriPreview() {&#10;        const prefix = document.getElementById('new-prop-iri-prefix')?.value || 'ex';&#10;        const local = document.getElementById('new-prop-iri-local')?.value || 'resource/$(id)';&#10;        const preview = document.getElementById('iri-preview-value');&#10;&#10;        if (preview) {&#10;            preview.textContent = `${prefix}:${local}`;&#10;        }&#10;    }&#10;&#10;    renderPredicateOptions() {&#10;        if (!this.ontology) return '&lt;div class=&quot;predicate-option disabled&quot;&gt;No ontology loaded&lt;/div&gt;';&#10;&#10;        const allProps = [];&#10;&#10;        // Add data properties&#10;        Object.entries(this.ontology.dataProperties || {}).forEach(([className, props]) =&gt; {&#10;            props.forEach(p =&gt; {&#10;                allProps.push({&#10;                    uri: `${p.prefix}:${p.name}`,&#10;                    label: p.name,&#10;                    prefix: p.prefix,&#10;                    type: p.type,&#10;                    domain: className&#10;                });&#10;            });&#10;        });&#10;&#10;        // Add object properties&#10;        (this.ontology.objectProperties || []).forEach(p =&gt; {&#10;            allProps.push({&#10;                uri: `${p.prefix}:${p.label}`,&#10;                label: p.label,&#10;                prefix: p.prefix,&#10;                type: 'iri',&#10;                domain: p.from&#10;            });&#10;        });&#10;&#10;        if (allProps.length === 0) {&#10;            return '&lt;div class=&quot;predicate-option disabled&quot;&gt;No properties in ontology&lt;/div&gt;';&#10;        }&#10;&#10;        return allProps.map(p =&gt; `&#10;            &lt;div class=&quot;predicate-option&quot; onclick=&quot;yarrrmlBuilder.selectPredicateOption('${p.uri}', '${p.type}')&quot;&gt;&#10;                &lt;span class=&quot;predicate-option-label&quot;&gt;${p.uri}&lt;/span&gt;&#10;                &lt;span class=&quot;predicate-option-meta&quot;&gt;${p.type} ${p.domain ? '(from ' + p.domain + ')' : ''}&lt;/span&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    showPredicateDropdown() {&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;        if (dropdown) {&#10;            dropdown.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    filterPredicateOptions(query) {&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;        if (!dropdown) return;&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const allProps = [];&#10;&#10;        // Collect all properties&#10;        Object.entries(this.ontology?.dataProperties || {}).forEach(([className, props]) =&gt; {&#10;            props.forEach(p =&gt; {&#10;                if (p.name.toLowerCase().includes(queryLower) ||&#10;                    p.prefix.toLowerCase().includes(queryLower)) {&#10;                    allProps.push({&#10;                        uri: `${p.prefix}:${p.name}`,&#10;                        label: p.name,&#10;                        prefix: p.prefix,&#10;                        type: p.type,&#10;                        domain: className&#10;                    });&#10;                }&#10;            });&#10;        });&#10;&#10;        (this.ontology?.objectProperties || []).forEach(p =&gt; {&#10;            if (p.label.toLowerCase().includes(queryLower) ||&#10;                p.prefix.toLowerCase().includes(queryLower)) {&#10;                allProps.push({&#10;                    uri: `${p.prefix}:${p.label}`,&#10;                    label: p.label,&#10;                    prefix: p.prefix,&#10;                    type: 'iri',&#10;                    domain: p.from&#10;                });&#10;            }&#10;        });&#10;&#10;        dropdown.innerHTML = allProps.length &gt; 0&#10;            ? allProps.map(p =&gt; `&#10;                &lt;div class=&quot;predicate-option&quot; onclick=&quot;yarrrmlBuilder.selectPredicateOption('${p.uri}', '${p.type}')&quot;&gt;&#10;                    &lt;span class=&quot;predicate-option-label&quot;&gt;${p.uri}&lt;/span&gt;&#10;                    &lt;span class=&quot;predicate-option-meta&quot;&gt;${p.type} ${p.domain ? '(from ' + p.domain + ')' : ''}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            `).join('')&#10;            : `&lt;div class=&quot;predicate-option disabled&quot;&gt;No matching properties&lt;/div&gt;`;&#10;&#10;        dropdown.style.display = 'block';&#10;    }&#10;&#10;    selectPredicateOption(predicateUri, dataType) {&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;&#10;        if (predicateInput) predicateInput.value = predicateUri;&#10;&#10;        // Auto-switch between literal and IRI mode based on property type&#10;        if (typeSelect) {&#10;            if (dataType === 'iri') {&#10;                typeSelect.value = 'iri';&#10;                this.onValueTypeChange('iri');&#10;            } else {&#10;                typeSelect.value = 'literal';&#10;                this.onValueTypeChange('literal');&#10;&#10;                // Also set the datatype dropdown&#10;                const datatypeSelect = document.getElementById('new-prop-datatype');&#10;                if (datatypeSelect &amp;&amp; dataType) {&#10;                    datatypeSelect.value = dataType;&#10;                }&#10;            }&#10;        }&#10;&#10;        if (dropdown) dropdown.style.display = 'none';&#10;    }&#10;&#10;    addPropertyFromForm() {&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        const provenanceCheck = document.getElementById('new-prop-provenance');&#10;&#10;        const predicate = predicateInput?.value;&#10;        const valueType = typeSelect?.value || 'literal';&#10;        const trackProvenance = provenanceCheck?.checked || false;&#10;&#10;        if (!predicate) {&#10;            alert('Please specify an RDF predicate');&#10;            return;&#10;        }&#10;&#10;        let valueTemplate = '';&#10;        let dataType = 'string';&#10;        let isIriTemplate = false; // true if it's a prefix:local template&#10;&#10;        if (valueType === 'iri') {&#10;            // Check which IRI mode is selected (template or column)&#10;            const iriModeRadio = document.querySelector('input[name=&quot;iri-mode&quot;]:checked');&#10;            const iriMode = iriModeRadio?.value || 'template';&#10;&#10;            console.log('IRI mode:', iriMode);&#10;&#10;            if (iriMode === 'column') {&#10;                // Use column containing full URI&#10;                const iriColumn = document.getElementById('new-prop-iri-column')?.value;&#10;&#10;                if (!iriColumn) {&#10;                    alert('Please select a column containing the full URI');&#10;                    return;&#10;                }&#10;&#10;                valueTemplate = iriColumn;&#10;                isIriTemplate = false;&#10;                console.log('Using IRI from column:', iriColumn);&#10;            } else {&#10;                // Build from prefix + local template&#10;                const iriPrefix = document.getElementById('new-prop-iri-prefix')?.value || 'ex';&#10;                const iriLocal = document.getElementById('new-prop-iri-local')?.value;&#10;&#10;                console.log('Building IRI template - prefix:', iriPrefix, 'local:', iriLocal);&#10;&#10;                if (!iriLocal) {&#10;                    alert('Please specify the IRI local part (e.g., organization/$(org_id))');&#10;                    return;&#10;                }&#10;&#10;                valueTemplate = `${iriPrefix}:${iriLocal}`;&#10;                isIriTemplate = true;&#10;                console.log('Created IRI template:', valueTemplate);&#10;            }&#10;            dataType = 'iri';&#10;        } else {&#10;            // Get literal value&#10;            const columnSelect = document.getElementById('new-prop-column');&#10;            const columnCustom = document.getElementById('new-prop-column-custom');&#10;            const datatypeSelect = document.getElementById('new-prop-datatype');&#10;&#10;            const column = columnCustom?.value || columnSelect?.value;&#10;            dataType = datatypeSelect?.value || 'string';&#10;&#10;            if (!column) {&#10;                alert('Please specify a source column');&#10;                return;&#10;            }&#10;&#10;            valueTemplate = column;&#10;        }&#10;&#10;        // Add to the table&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            // Remove empty row if present&#10;            const emptyRow = tbody.querySelector('.empty-row');&#10;            if (emptyRow) emptyRow.remove();&#10;&#10;            const newRow = document.createElement('tr');&#10;            newRow.className = 'property-row';&#10;&#10;            // Format display based on type&#10;            let valueDisplay;&#10;            if (valueType === 'iri') {&#10;                if (isIriTemplate) {&#10;                    // Template like ex:organization/$(org_id)&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;${valueTemplate}&lt;/code&gt;`;&#10;                } else {&#10;                    // Column containing URI&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;$(${valueTemplate})&lt;/code&gt;`;&#10;                }&#10;            } else {&#10;                valueDisplay = `&lt;code&gt;$(${valueTemplate})&lt;/code&gt;`;&#10;            }&#10;&#10;            newRow.innerHTML = `&#10;                &lt;td&gt;&lt;code&gt;${predicate}&lt;/code&gt;&lt;/td&gt;&#10;                &lt;td&gt;${valueDisplay}&lt;/td&gt;&#10;                &lt;td&gt;&lt;span class=&quot;type-badge ${dataType}&quot;&gt;${dataType}&lt;/span&gt;&lt;/td&gt;&#10;                &lt;td&gt;${trackProvenance ? '&lt;span class=&quot;prov-badge&quot;&gt;Yes&lt;/span&gt;' : 'No'}&lt;/td&gt;&#10;                &lt;td&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePropertyRow(this)&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/td&gt;&#10;            `;&#10;            tbody.appendChild(newRow);&#10;        }&#10;&#10;        // Store in mapping&#10;        const mappingName = document.getElementById('property-mapping-select')?.value;&#10;        if (mappingName &amp;&amp; this.mapping.mappings[mappingName]) {&#10;            if (!this.mapping.mappings[mappingName].properties) {&#10;                this.mapping.mappings[mappingName].properties = [];&#10;            }&#10;            this.mapping.mappings[mappingName].properties.push({&#10;                predicate,&#10;                valueTemplate,&#10;                dataType,&#10;                isIri: valueType === 'iri',&#10;                isIriTemplate: isIriTemplate,&#10;                trackProvenance&#10;            });&#10;        }&#10;&#10;        // Clear form&#10;        this.clearPropertyForm();&#10;    }&#10;&#10;    removePropertyRow(button) {&#10;        const row = button.closest('tr');&#10;        const tbody = document.getElementById('properties-tbody');&#10;        const mappingName = document.getElementById('property-mapping-select')?.value;&#10;&#10;        if (row &amp;&amp; mappingName &amp;&amp; this.mapping.mappings[mappingName]?.properties) {&#10;            const rowIndex = Array.from(tbody.querySelectorAll('tr.property-row')).indexOf(row);&#10;            if (rowIndex &gt;= 0) {&#10;                this.mapping.mappings[mappingName].properties.splice(rowIndex, 1);&#10;            }&#10;        }&#10;&#10;        row?.remove();&#10;&#10;        // Show empty row if no properties left&#10;        if (tbody &amp;&amp; tbody.querySelectorAll('tr.property-row').length === 0) {&#10;            tbody.innerHTML = this.renderPropertyRows();&#10;        }&#10;    }&#10;&#10;    clearPropertyForm() {&#10;        const fields = [&#10;            'new-prop-predicate',&#10;            'new-prop-column',&#10;            'new-prop-column-custom',&#10;            'new-prop-iri-local',&#10;            'new-prop-iri-column'&#10;        ];&#10;&#10;        fields.forEach(id =&gt; {&#10;            const el = document.getElementById(id);&#10;            if (el) el.value = '';&#10;        });&#10;&#10;        const provenanceCheck = document.getElementById('new-prop-provenance');&#10;        if (provenanceCheck) provenanceCheck.checked = false;&#10;&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        if (typeSelect) typeSelect.value = 'literal';&#10;&#10;        this.onValueTypeChange('literal');&#10;    }&#10;&#10;    renderPropertyRows() {&#10;        // Get current mapping's properties&#10;        const mappingName = Object.keys(this.mapping.mappings)[0];&#10;        const properties = this.mapping.mappings[mappingName]?.properties || [];&#10;&#10;        if (properties.length === 0) {&#10;            return `&#10;                &lt;tr class=&quot;property-row empty-row&quot;&gt;&#10;                    &lt;td colspan=&quot;5&quot; style=&quot;text-align: center; color: var(--text-secondary); padding: 20px;&quot;&gt;&#10;                        No properties mapped yet. Use the form below to add property mappings.&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            `;&#10;        }&#10;&#10;        return properties.map((p, i) =&gt; {&#10;            // Handle both old format (column) and new format (valueTemplate)&#10;            let valueDisplay;&#10;            if (p.isIri || p.dataType === 'iri') {&#10;                if (p.isIriTemplate) {&#10;                    // Template like ex:organization/$(org_id)&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;${p.valueTemplate}&lt;/code&gt;`;&#10;                } else {&#10;                    // Column containing URI&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;$(${p.valueTemplate || p.column})&lt;/code&gt;`;&#10;                }&#10;            } else {&#10;                valueDisplay = `&lt;code&gt;$(${p.valueTemplate || p.column})&lt;/code&gt;`;&#10;            }&#10;&#10;            return `&#10;                &lt;tr class=&quot;property-row&quot;&gt;&#10;                    &lt;td&gt;&lt;code&gt;${p.predicate}&lt;/code&gt;&lt;/td&gt;&#10;                    &lt;td&gt;${valueDisplay}&lt;/td&gt;&#10;                    &lt;td&gt;&lt;span class=&quot;type-badge ${p.dataType}&quot;&gt;${p.dataType}&lt;/span&gt;&lt;/td&gt;&#10;                    &lt;td&gt;${p.trackProvenance ? '&lt;span class=&quot;prov-badge&quot;&gt;Yes&lt;/span&gt;' : 'No'}&lt;/td&gt;&#10;                    &lt;td&gt;&#10;                        &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePropertyMapping('${mappingName}', ${i})&quot;&gt;&#10;                            &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                        &lt;/button&gt;&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            `;&#10;        }).join('');&#10;    }&#10;&#10;    removePropertyMapping(mappingName, index) {&#10;        if (this.mapping.mappings[mappingName]?.properties) {&#10;            this.mapping.mappings[mappingName].properties.splice(index, 1);&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    onMappingChange(mappingName) {&#10;        // Re-render property rows for selected mapping&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            const properties = this.mapping.mappings[mappingName]?.properties || [];&#10;            tbody.innerHTML = this.renderPropertyRows();&#10;        }&#10;    }&#10;&#10;    renderReviewStep() {&#10;        const yaml = this.generateYARRRML();&#10;&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 5: Review &amp; Export&lt;/h2&gt;&#10;&#10;                &lt;div class=&quot;yaml-preview&quot;&gt;&#10;                    &lt;div class=&quot;yaml-header&quot;&gt;&#10;                        &lt;span&gt;Generated YARRRML&lt;/span&gt;&#10;                        &lt;div&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.copyYAML()&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z&quot;/&gt;&lt;/svg&gt;&#10;                                Copy&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.downloadYAML()&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z&quot;/&gt;&lt;/svg&gt;&#10;                                Download&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;pre id=&quot;yaml-output&quot;&gt;${this.escapeHtml(yaml)}&lt;/pre&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Sample Triple Preview --&gt;&#10;                &lt;div class=&quot;triple-preview&quot;&gt;&#10;                    &lt;div class=&quot;triple-preview-header&quot;&gt;&#10;                        &lt;h4&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z&quot;/&gt;&lt;/svg&gt;&#10;                            Sample Output Preview&#10;                        &lt;/h4&gt;&#10;                        &lt;span class=&quot;preview-note&quot;&gt;Example triples from mapping&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;pre class=&quot;triple-output&quot;&gt;${this.generateSampleTriples()}&lt;/pre&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;validation-results&quot;&gt;&#10;                    ${this.validateMapping()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Export Options --&gt;&#10;                &lt;div class=&quot;export-options&quot;&gt;&#10;                    &lt;h4&gt;Export Options&lt;/h4&gt;&#10;                    &lt;div class=&quot;export-buttons&quot;&gt;&#10;                        &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;yarrrmlBuilder.downloadYAML()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z&quot;/&gt;&lt;/svg&gt;&#10;                            Download YARRRML&#10;                        &lt;/button&gt;&#10;                        &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.exportAsJSON()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z&quot;/&gt;&lt;/svg&gt;&#10;                            Export Session&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    generateSampleTriples() {&#10;        // Generate dynamic sample based on actual mapping configuration&#10;        let output = `# Sample RDF Output (Turtle format)&#10;# Generated from your mapping configuration&#10;&#10;`;&#10;&#10;        // Add prefixes&#10;        for (const [prefix, uri] of Object.entries(this.mapping.prefixes)) {&#10;            output += `@prefix ${prefix}: &lt;${uri}&gt; .\n`;&#10;        }&#10;        output += `\n`;&#10;&#10;        // Check if we have mappings&#10;        const mappings = Object.entries(this.mapping.mappings);&#10;        if (mappings.length === 0) {&#10;            output += `# No mappings defined yet.\n`;&#10;            output += `# Complete Steps 1-4 to see a preview.\n`;&#10;            return output;&#10;        }&#10;&#10;        // Generate sample triples for each mapping&#10;        for (const [name, config] of mappings) {&#10;            output += `# Mapping: ${name}\n`;&#10;&#10;            // Sample subject - replace $(column) with sample value&#10;            const sampleSubject = config.subject&#10;                ? config.subject.replace(/\$\(([^)]+)\)/g, 'sample_$1')&#10;                : 'ex:resource/1';&#10;&#10;            output += `${sampleSubject} a ${config.class || 'ex:Thing'} `;&#10;&#10;            // Add properties&#10;            if (config.properties &amp;&amp; config.properties.length &gt; 0) {&#10;                output += `;\n`;&#10;                config.properties.forEach((prop, i) =&gt; {&#10;                    const sampleValue = prop.dataType === 'integer' ? '42' :&#10;                                       prop.dataType === 'decimal' ? '3.14' :&#10;                                       prop.dataType === 'date' ? '&quot;2026-02-17&quot;' :&#10;                                       prop.dataType === 'dateTime' ? '&quot;2026-02-17T10:00:00Z&quot;' :&#10;                                       prop.dataType === 'boolean' ? 'true' :&#10;                                       prop.dataType === 'iri' ? `ex:ref_${prop.column}` :&#10;                                       `&quot;Sample ${prop.column}&quot;`;&#10;&#10;                    const ending = i === config.properties.length - 1 ? ' .' : ' ;';&#10;                    output += `    ${prop.predicate} ${sampleValue}${ending}\n`;&#10;                });&#10;&#10;                // Show RDF-star provenance for properties that track it&#10;                const provenanceProps = config.properties.filter(p =&gt; p.trackProvenance);&#10;                if (provenanceProps.length &gt; 0) {&#10;                    output += `\n# RDF-star Provenance Annotations:\n`;&#10;                    provenanceProps.forEach(prop =&gt; {&#10;                        const sampleValue = prop.dataType === 'integer' ? '42' : `&quot;Sample ${prop.column}&quot;`;&#10;                        output += `&lt;&lt;${sampleSubject} ${prop.predicate} ${sampleValue}&gt;&gt;\n`;&#10;                        output += `    prov:wasDerivedFrom ex:source/system ;\n`;&#10;                        output += `    prov:generatedAtTime &quot;2026-02-17T10:00:00Z&quot;^^xsd:dateTime .\n\n`;&#10;                    });&#10;                }&#10;            } else {&#10;                output += `.\n`;&#10;                output += `# No properties mapped yet. Add properties in Step 4.\n`;&#10;            }&#10;&#10;            output += `\n`;&#10;        }&#10;&#10;        return output;&#10;    }&#10;&#10;    exportAsJSON() {&#10;        const session = {&#10;            version: '1.0',&#10;            created: new Date().toISOString(),&#10;            mapping: this.mapping,&#10;            detectedColumns: this.detectedColumns || []&#10;        };&#10;&#10;        const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });&#10;        const url = URL.createObjectURL(blob);&#10;        const a = document.createElement('a');&#10;        a.href = url;&#10;        a.download = 'yarrrml-session.json';&#10;        a.click();&#10;        URL.revokeObjectURL(url);&#10;    }&#10;&#10;    generateYARRRML() {&#10;        let yaml = `# YARRRML Mapping&#10;# Generated: ${new Date().toISOString()}&#10;&#10;prefixes:\n`;&#10;&#10;        for (const [prefix, uri] of Object.entries(this.mapping.prefixes)) {&#10;            yaml += `  ${prefix}: &quot;${uri}&quot;\n`;&#10;        }&#10;&#10;        yaml += `\nsources:\n`;&#10;&#10;        if (Object.keys(this.mapping.sources).length === 0) {&#10;            yaml += `  # No sources defined yet\n`;&#10;        } else {&#10;            for (const [name, config] of Object.entries(this.mapping.sources)) {&#10;                yaml += `  ${name}:\n`;&#10;                yaml += `    access: &quot;${config.access}&quot;\n`;&#10;                yaml += `    referenceFormulation: ${config.type || 'csv'}\n`;&#10;            }&#10;        }&#10;&#10;        yaml += `\nmappings:\n`;&#10;&#10;        if (Object.keys(this.mapping.mappings).length === 0) {&#10;            yaml += `  # No mappings defined yet\n`;&#10;        } else {&#10;            for (const [name, config] of Object.entries(this.mapping.mappings)) {&#10;                yaml += `  ${name}:\n`;&#10;                yaml += `    sources: ${config.source}\n`;&#10;                yaml += `    subject: ${config.subject}\n`;&#10;                yaml += `    predicateobjects:\n`;&#10;&#10;                // Add rdf:type&#10;                yaml += `      - predicates: rdf:type\n`;&#10;                yaml += `        objects:\n`;&#10;                yaml += `          value: ${config.class}\n`;&#10;                yaml += `          type: iri\n`;&#10;&#10;                // Add property mappings&#10;                if (config.properties &amp;&amp; config.properties.length &gt; 0) {&#10;                    for (const prop of config.properties) {&#10;                        yaml += `\n      - predicates: ${prop.predicate}\n`;&#10;                        yaml += `        objects:\n`;&#10;&#10;                        // Handle IRI vs literal values&#10;                        if (prop.isIri || prop.dataType === 'iri') {&#10;                            if (prop.isIriTemplate) {&#10;                                // It's a prefixed IRI template like ex:organization/$(org_id)&#10;                                yaml += `          value: ${prop.valueTemplate}\n`;&#10;                            } else {&#10;                                // It's a column containing full URI&#10;                                yaml += `          value: &quot;$(${prop.valueTemplate})&quot;\n`;&#10;                            }&#10;                            yaml += `          type: iri\n`;&#10;                        } else {&#10;                            // Literal value&#10;                            const column = prop.valueTemplate || prop.column;&#10;                            yaml += `          value: &quot;$(${column})&quot;\n`;&#10;&#10;                            // Add datatype for non-string literals&#10;                            if (prop.dataType &amp;&amp; prop.dataType !== 'string') {&#10;                                yaml += `          datatype: xsd:${prop.dataType}\n`;&#10;                            }&#10;                        }&#10;&#10;                        // Add provenance annotations if enabled&#10;                        if (prop.trackProvenance) {&#10;                            yaml += `        annotations:\n`;&#10;                            yaml += `          - predicates: prov:wasDerivedFrom\n`;&#10;                            yaml += `            objects:\n`;&#10;                            yaml += `              value: &quot;$(source_system)&quot;\n`;&#10;                            yaml += `              type: iri\n`;&#10;                            yaml += `          - predicates: prov:generatedAtTime\n`;&#10;                            yaml += `            objects:\n`;&#10;                            yaml += `              value: &quot;$(timestamp)&quot;\n`;&#10;                            yaml += `              datatype: xsd:dateTime\n`;&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        return yaml;&#10;    }&#10;&#10;    validateMapping() {&#10;        const issues = [];&#10;        const warnings = [];&#10;&#10;        if (Object.keys(this.mapping.sources).length === 0) {&#10;            warnings.push('No data sources defined');&#10;        }&#10;&#10;        if (Object.keys(this.mapping.mappings).length === 0) {&#10;            warnings.push('No class mappings defined');&#10;        }&#10;&#10;        return `&#10;            &lt;div class=&quot;validation-summary ${issues.length &gt; 0 ? 'has-errors' : 'valid'}&quot;&gt;&#10;                &lt;h4&gt;&#10;                    ${issues.length &gt; 0&#10;                        ? '&lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z&quot;/&gt;&lt;/svg&gt; Issues Found'&#10;                        : '&lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z&quot;/&gt;&lt;/svg&gt; Ready'&#10;                    }&#10;                &lt;/h4&gt;&#10;                ${warnings.length &gt; 0 ? `&#10;                    &lt;ul class=&quot;warning-list&quot;&gt;&#10;                        ${warnings.map(w =&gt; `&lt;li class=&quot;warning&quot;&gt;${w}&lt;/li&gt;`).join('')}&#10;                    &lt;/ul&gt;&#10;                ` : ''}&#10;                &lt;p class=&quot;validation-note&quot;&gt;&#10;                    Configure your mapping using the steps above.&#10;                &lt;/p&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    // ==========================================&#10;    // ONTOLOGY BROWSER&#10;    // ==========================================&#10;&#10;    buildSearchIndex() {&#10;        this.ontologyIndex.clear();&#10;&#10;        if (!this.ontology) return;&#10;&#10;        // Index classes&#10;        this.ontology.classes.forEach(cls =&gt; {&#10;            const terms = [&#10;                cls.label.toLowerCase(),&#10;                cls.id.toLowerCase(),&#10;                cls.prefix.toLowerCase(),&#10;                (cls.prefix + ':' + cls.label).toLowerCase()&#10;            ];&#10;&#10;            terms.forEach(term =&gt; {&#10;                if (!this.ontologyIndex.has(term)) {&#10;                    this.ontologyIndex.set(term, []);&#10;                }&#10;                this.ontologyIndex.get(term).push({ type: 'class', data: cls });&#10;            });&#10;        });&#10;&#10;        // Index data properties&#10;        Object.entries(this.ontology.dataProperties).forEach(([className, props]) =&gt; {&#10;            props.forEach(prop =&gt; {&#10;                const terms = [&#10;                    prop.name.toLowerCase(),&#10;                    (prop.prefix + ':' + prop.name).toLowerCase()&#10;                ];&#10;&#10;                terms.forEach(term =&gt; {&#10;                    if (!this.ontologyIndex.has(term)) {&#10;                        this.ontologyIndex.set(term, []);&#10;                    }&#10;                    this.ontologyIndex.get(term).push({ type: 'property', data: prop, className });&#10;                });&#10;            });&#10;        });&#10;&#10;        // Index object properties&#10;        this.ontology.objectProperties.forEach(rel =&gt; {&#10;            const term = rel.label.toLowerCase();&#10;            if (!this.ontologyIndex.has(term)) {&#10;                this.ontologyIndex.set(term, []);&#10;            }&#10;            this.ontologyIndex.get(term).push({ type: 'relationship', data: rel });&#10;        });&#10;    }&#10;&#10;    searchOntology(query) {&#10;        const resultsDiv = document.getElementById('search-results');&#10;&#10;        if (!query || query.length &lt; 2) {&#10;            resultsDiv.innerHTML = '';&#10;            resultsDiv.style.display = 'none';&#10;            return;&#10;        }&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const results = [];&#10;&#10;        this.ontologyIndex.forEach((items, term) =&gt; {&#10;            if (term.includes(queryLower)) {&#10;                items.forEach(item =&gt; {&#10;                    if (!results.find(r =&gt; r.type === item.type &amp;&amp;&#10;                        (item.type === 'class' ? r.data.id === item.data.id :&#10;                         item.type === 'property' ? r.data.name === item.data.name : false))) {&#10;                        results.push(item);&#10;                    }&#10;                });&#10;            }&#10;        });&#10;&#10;        const limited = results.slice(0, 10);&#10;&#10;        if (limited.length === 0) {&#10;            resultsDiv.innerHTML = '&lt;div class=&quot;search-no-results&quot;&gt;No results found&lt;/div&gt;';&#10;        } else {&#10;            resultsDiv.innerHTML = limited.map(result =&gt; {&#10;                if (result.type === 'class') {&#10;                    const escapedId = result.data.id.replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item class&quot; onclick=&quot;yarrrmlBuilder.focusOnClass('${escapedId}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2l-5.5 9h11z M17.5 13h-11l5.5 9z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.prefix}:${result.data.label}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;Class&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                } else if (result.type === 'property') {&#10;                    const escapedClassName = result.className.replace(/'/g, &quot;\\'&quot;);&#10;                    const escapedName = result.data.name.replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item property&quot; onclick=&quot;yarrrmlBuilder.showPropertyInContext('${escapedClassName}', '${escapedName}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.prefix}:${result.data.name}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;Property of ${result.className}&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                } else {&#10;                    const escapedFrom = (result.data.from || '').replace(/'/g, &quot;\\'&quot;);&#10;                    const escapedTo = (result.data.to || '').replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item relationship&quot; onclick=&quot;yarrrmlBuilder.showRelationship('${escapedFrom}', '${escapedTo}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.label}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;${result.data.from || ''} → ${result.data.to || ''}&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                }&#10;            }).join('');&#10;        }&#10;&#10;        resultsDiv.style.display = 'block';&#10;    }&#10;&#10;    focusOnClass(classId) {&#10;        console.log('focusOnClass called with:', classId);&#10;&#10;        if (!this.ontology || !this.ontology.classes) {&#10;            console.warn('Ontology not loaded yet');&#10;            return;&#10;        }&#10;&#10;        // Validate classId exists in ontology&#10;        const classExists = this.ontology.classes.find(c =&gt; c.id === classId);&#10;        if (!classExists) {&#10;            console.warn(`Class '${classId}' not found in ontology, showing all classes`);&#10;            this.expandAll();&#10;            return;&#10;        }&#10;&#10;        const searchInput = document.getElementById('ontology-search');&#10;        const resultsDiv = document.getElementById('search-results');&#10;        if (searchInput) searchInput.value = '';&#10;        if (resultsDiv) resultsDiv.style.display = 'none';&#10;&#10;        this.visibleClasses.clear();&#10;        this.visibleClasses.add(classId);&#10;&#10;        // Add valid neighbors&#10;        const neighbors = this.getNeighbors(classId);&#10;        neighbors.forEach(id =&gt; {&#10;            if (this.ontology.classes.some(c =&gt; c.id === id)) {&#10;                this.visibleClasses.add(id);&#10;            }&#10;        });&#10;&#10;        console.log('Visible classes after focus:', Array.from(this.visibleClasses));&#10;&#10;        this.renderOntologyGraph();&#10;&#10;        this.selectOntologyClass(classExists);&#10;    }&#10;&#10;    showPropertyInContext(className, propertyName) {&#10;        this.focusOnClass(className);&#10;    }&#10;&#10;    showRelationship(fromClass, toClass) {&#10;        this.visibleClasses.clear();&#10;        this.visibleClasses.add(fromClass);&#10;        this.visibleClasses.add(toClass);&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    getNeighbors(classId) {&#10;        const neighbors = new Set();&#10;&#10;        if (!this.ontology) return neighbors;&#10;&#10;        const cls = this.ontology.classes.find(c =&gt; c.id === classId);&#10;        if (cls?.parent) {&#10;            neighbors.add(cls.parent);&#10;        }&#10;&#10;        // Find child classes&#10;        this.ontology.classes&#10;            .filter(c =&gt; c.parent === classId)&#10;            .forEach(c =&gt; neighbors.add(c.id));&#10;&#10;        // Find connected classes via object properties&#10;        if (this.ontology.objectProperties) {&#10;            this.ontology.objectProperties.forEach(rel =&gt; {&#10;                if (rel.from &amp;&amp; rel.from === classId &amp;&amp; rel.to) {&#10;                    neighbors.add(rel.to);&#10;                }&#10;                if (rel.to &amp;&amp; rel.to === classId &amp;&amp; rel.from) {&#10;                    neighbors.add(rel.from);&#10;                }&#10;            });&#10;        }&#10;&#10;        return neighbors;&#10;    }&#10;&#10;    expandClass(classId) {&#10;        console.log('expandClass called with:', classId);&#10;        console.log('Current visible classes:', Array.from(this.visibleClasses));&#10;&#10;        this.visibleClasses.add(classId);&#10;        const neighbors = this.getNeighbors(classId);&#10;        console.log('Neighbors found:', Array.from(neighbors));&#10;&#10;        // Only add neighbors that actually exist in the ontology&#10;        neighbors.forEach(id =&gt; {&#10;            const exists = this.ontology.classes.some(c =&gt; c.id === id);&#10;            if (exists) {&#10;                this.visibleClasses.add(id);&#10;            } else {&#10;                console.warn(`Neighbor '${id}' not found in ontology classes`);&#10;            }&#10;        });&#10;&#10;        console.log('Visible classes after expand:', Array.from(this.visibleClasses));&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    hideClass(classId) {&#10;        this.visibleClasses.delete(classId);&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    resetOntologyView() {&#10;        if (this.ontology &amp;&amp; this.ontology.classes.length &gt; 0) {&#10;            // Show all classes initially for real ontology&#10;            this.visibleClasses.clear();&#10;            this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;            this.renderOntologyGraph();&#10;        }&#10;    }&#10;&#10;    expandAll() {&#10;        this.visibleClasses.clear();&#10;        this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;        console.log('expandAll - visible classes:', Array.from(this.visibleClasses));&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    initOntologyGraph() {&#10;        const container = document.getElementById('ontology-graph');&#10;        if (!container) {&#10;            console.warn('Ontology graph container not found');&#10;            return;&#10;        }&#10;&#10;        // Get actual computed size&#10;        const rect = container.getBoundingClientRect();&#10;        const width = rect.width || 400;&#10;        const height = rect.height || 250;&#10;&#10;        console.log(`Initializing ontology graph: ${width}x${height}`);&#10;&#10;        const svg = d3.select('#ontology-canvas')&#10;            .attr('width', width)&#10;            .attr('height', height);&#10;&#10;        // Clear any existing content&#10;        svg.selectAll('*').remove();&#10;&#10;        const zoom = d3.zoom()&#10;            .scaleExtent([0.3, 3])&#10;            .on('zoom', (event) =&gt; {&#10;                svg.select('g.ontology-content').attr('transform', event.transform);&#10;            });&#10;&#10;        svg.call(zoom);&#10;        svg.append('g').attr('class', 'ontology-content');&#10;&#10;        svg.append('defs').append('marker')&#10;            .attr('id', 'ont-arrow')&#10;            .attr('viewBox', '-0 -5 10 10')&#10;            .attr('refX', 20)&#10;            .attr('refY', 0)&#10;            .attr('orient', 'auto')&#10;            .attr('markerWidth', 6)&#10;            .attr('markerHeight', 6)&#10;            .append('path')&#10;            .attr('d', 'M 0,-5 L 10,0 L 0,5')&#10;            .attr('fill', '#7c7c9c');&#10;    }&#10;&#10;    renderOntologyGraph() {&#10;        const svg = d3.select('#ontology-canvas');&#10;        let g = svg.select('g.ontology-content');&#10;&#10;        if (!g.node()) {&#10;            console.warn('SVG group not found, reinitializing graph');&#10;            this.initOntologyGraph();&#10;            g = d3.select('#ontology-canvas').select('g.ontology-content');&#10;            if (!g.node()) {&#10;                console.error('Failed to create SVG group');&#10;                return;&#10;            }&#10;        }&#10;&#10;        // Ensure arrow marker exists&#10;        if (!svg.select('#ont-arrow').node()) {&#10;            svg.append('defs').append('marker')&#10;                .attr('id', 'ont-arrow')&#10;                .attr('viewBox', '-0 -5 10 10')&#10;                .attr('refX', 20)&#10;                .attr('refY', 0)&#10;                .attr('orient', 'auto')&#10;                .attr('markerWidth', 6)&#10;                .attr('markerHeight', 6)&#10;                .append('path')&#10;                .attr('d', 'M 0,-5 L 10,0 L 0,5')&#10;                .attr('fill', '#7c7c9c');&#10;        }&#10;&#10;        g.selectAll('*').remove();&#10;&#10;        if (!this.ontology || this.ontology.classes.length === 0) {&#10;            console.log('No ontology classes to render');&#10;            return;&#10;        }&#10;&#10;        const width = parseInt(svg.attr('width')) || 400;&#10;        const height = parseInt(svg.attr('height')) || 250;&#10;&#10;        const visibleClassIds = Array.from(this.visibleClasses);&#10;        console.log(`Rendering ${visibleClassIds.length} visible classes out of ${this.ontology.classes.length} total`);&#10;&#10;        if (visibleClassIds.length === 0) {&#10;            console.log('No visible classes - showing first class');&#10;            if (this.ontology.classes.length &gt; 0) {&#10;                this.visibleClasses.add(this.ontology.classes[0].id);&#10;                return this.renderOntologyGraph();&#10;            }&#10;            return;&#10;        }&#10;&#10;        const nodes = this.ontology.classes&#10;            .filter(c =&gt; visibleClassIds.includes(c.id))&#10;            .map(c =&gt; ({...c}));&#10;&#10;        const links = [];&#10;&#10;        // Add object property links (check for null/undefined)&#10;        if (this.ontology.objectProperties &amp;&amp; Array.isArray(this.ontology.objectProperties)) {&#10;            this.ontology.objectProperties.forEach(rel =&gt; {&#10;                if (rel &amp;&amp; rel.from &amp;&amp; rel.to &amp;&amp;&#10;                    visibleClassIds.includes(rel.from) &amp;&amp; visibleClassIds.includes(rel.to)) {&#10;                    links.push({&#10;                        source: rel.from,&#10;                        target: rel.to,&#10;                        label: rel.label || 'relatedTo',&#10;                        type: 'object'&#10;                    });&#10;                }&#10;            });&#10;        }&#10;&#10;        // Add inheritance links&#10;        nodes.forEach(node =&gt; {&#10;            if (node.parent &amp;&amp; visibleClassIds.includes(node.parent)) {&#10;                links.push({&#10;                    source: node.id,&#10;                    target: node.parent,&#10;                    label: 'subClassOf',&#10;                    type: 'inheritance'&#10;                });&#10;            }&#10;        });&#10;&#10;        console.log(`Rendering graph with ${nodes.length} nodes and ${links.length} links at ${width}x${height}`);&#10;&#10;        if (nodes.length === 0) {&#10;            console.warn('No nodes to render');&#10;            return;&#10;        }&#10;&#10;        // Adjust force simulation based on number of nodes&#10;        const nodeCount = nodes.length;&#10;        const linkDistance = nodeCount &lt;= 3 ? 100 : nodeCount &lt;= 6 ? 80 : 60;&#10;        const chargeStrength = nodeCount &lt;= 3 ? -200 : nodeCount &lt;= 6 ? -150 : -100;&#10;&#10;        const simulation = d3.forceSimulation(nodes)&#10;            .force('link', d3.forceLink(links).id(d =&gt; d.id).distance(linkDistance))&#10;            .force('charge', d3.forceManyBody().strength(chargeStrength))&#10;            .force('center', d3.forceCenter(width / 2, height / 2))&#10;            .force('collision', d3.forceCollide().radius(55))&#10;            .force('x', d3.forceX(width / 2).strength(0.1))&#10;            .force('y', d3.forceY(height / 2).strength(0.1))&#10;            .alphaDecay(0.05); // Faster stabilization&#10;&#10;        // Stop simulation after stabilizing&#10;        simulation.on('end', () =&gt; {&#10;            console.log('Simulation stabilized');&#10;        });&#10;&#10;        const link = g.append('g')&#10;            .selectAll('line')&#10;            .data(links)&#10;            .enter()&#10;            .append('line')&#10;            .attr('stroke', d =&gt; d.type === 'inheritance' ? '#9c27b0' : '#7c7c9c')&#10;            .attr('stroke-width', d =&gt; d.type === 'inheritance' ? 2 : 1.5)&#10;            .attr('stroke-dasharray', d =&gt; d.type === 'inheritance' ? '5,3' : 'none')&#10;            .attr('marker-end', 'url(#ont-arrow)');&#10;&#10;        const linkLabel = g.append('g')&#10;            .selectAll('text')&#10;            .data(links)&#10;            .enter()&#10;            .append('text')&#10;            .attr('font-size', 9)&#10;            .attr('fill', '#9e9e9e')&#10;            .attr('text-anchor', 'middle')&#10;            .text(d =&gt; d.label);&#10;&#10;        const node = g.append('g')&#10;            .selectAll('g')&#10;            .data(nodes)&#10;            .enter()&#10;            .append('g')&#10;            .style('cursor', 'pointer')&#10;            .call(d3.drag()&#10;                .on('start', (event, d) =&gt; {&#10;                    if (!event.active) simulation.alphaTarget(0.3).restart();&#10;                    d.fx = d.x;&#10;                    d.fy = d.y;&#10;                })&#10;                .on('drag', (event, d) =&gt; {&#10;                    d.fx = event.x;&#10;                    d.fy = event.y;&#10;                })&#10;                .on('end', (event, d) =&gt; {&#10;                    if (!event.active) simulation.alphaTarget(0);&#10;                    // Keep the node fixed where it was dropped&#10;                    // d.fx = null; d.fy = null; // Don't release - keeps graph stable&#10;                }))&#10;            .on('click', (event, d) =&gt; {&#10;                event.stopPropagation();&#10;                // Don't restart simulation on click&#10;                this.selectOntologyClass(d);&#10;            })&#10;            .on('contextmenu', (event, d) =&gt; {&#10;                event.preventDefault();&#10;                this.showContextMenu(event, d);&#10;            });&#10;&#10;        node.append('rect')&#10;            .attr('width', 90)&#10;            .attr('height', 32)&#10;            .attr('x', -45)&#10;            .attr('y', -16)&#10;            .attr('rx', 5)&#10;            .attr('fill', d =&gt; this.getClassColor(d))&#10;            .attr('stroke', '#fff')&#10;            .attr('stroke-width', 2);&#10;&#10;        node.append('text')&#10;            .attr('text-anchor', 'middle')&#10;            .attr('dy', 4)&#10;            .attr('fill', '#fff')&#10;            .attr('font-size', 10)&#10;            .attr('font-weight', 'bold')&#10;            .text(d =&gt; d.label.length &gt; 12 ? d.label.substring(0, 10) + '...' : d.label);&#10;&#10;        simulation.on('tick', () =&gt; {&#10;            link&#10;                .attr('x1', d =&gt; d.source.x)&#10;                .attr('y1', d =&gt; d.source.y)&#10;                .attr('x2', d =&gt; d.target.x)&#10;                .attr('y2', d =&gt; d.target.y);&#10;&#10;            linkLabel&#10;                .attr('x', d =&gt; (d.source.x + d.target.x) / 2)&#10;                .attr('y', d =&gt; (d.source.y + d.target.y) / 2 - 5);&#10;&#10;            node.attr('transform', d =&gt; `translate(${d.x},${d.y})`);&#10;        });&#10;    }&#10;&#10;    getClassColor(cls) {&#10;        const colors = {&#10;            'owl': '#9c27b0',&#10;            'schema': '#2196f3',&#10;            'foaf': '#4caf50',&#10;            'prov': '#ff9800',&#10;            'ex': '#00bcd4',&#10;            'dcat': '#e91e63',&#10;            'dct': '#795548'&#10;        };&#10;        return colors[cls.prefix] || '#607d8b';&#10;    }&#10;&#10;    // Context Menu&#10;    bindContextMenu() {&#10;        document.addEventListener('click', () =&gt; {&#10;            const menu = document.getElementById('context-menu');&#10;            if (menu) menu.style.display = 'none';&#10;        });&#10;    }&#10;&#10;    showContextMenu(event, classData) {&#10;        this.contextMenuTarget = classData;&#10;        const menu = document.getElementById('context-menu');&#10;&#10;        menu.style.left = event.pageX + 'px';&#10;        menu.style.top = event.pageY + 'px';&#10;        menu.style.display = 'block';&#10;&#10;        menu.querySelectorAll('.context-menu-item').forEach(item =&gt; {&#10;            item.onclick = (e) =&gt; {&#10;                e.stopPropagation();&#10;                const action = item.dataset.action;&#10;                this.handleContextMenuAction(action);&#10;                menu.style.display = 'none';&#10;            };&#10;        });&#10;    }&#10;&#10;    handleContextMenuAction(action) {&#10;        const cls = this.contextMenuTarget;&#10;        if (!cls) return;&#10;&#10;        switch(action) {&#10;            case 'expand':&#10;                this.expandClass(cls.id);&#10;                break;&#10;            case 'focus':&#10;                this.focusOnClass(cls.id);&#10;                break;&#10;            case 'hide':&#10;                this.hideClass(cls.id);&#10;                break;&#10;            case 'use-mapping':&#10;                this.useClassForMapping(`${cls.prefix}:${cls.label}`);&#10;                break;&#10;        }&#10;    }&#10;&#10;    selectOntologyClass(classData) {&#10;        this.selectedClass = classData;&#10;        const details = document.getElementById('ontology-details');&#10;&#10;        const allProps = this.getAllPropertiesForClass(classData.id);&#10;        const neighbors = this.getNeighbors(classData.id);&#10;&#10;        details.innerHTML = `&#10;            &lt;div class=&quot;class-details&quot;&gt;&#10;                &lt;div class=&quot;class-header-detail&quot;&gt;&#10;                    &lt;span class=&quot;class-badge&quot; style=&quot;background: ${this.getClassColor(classData)}&quot;&gt;${classData.prefix}:${classData.label}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;p class=&quot;class-uri&quot;&gt;${classData.uri || ''}&lt;/p&gt;&#10;                ${classData.comment ? `&lt;p class=&quot;class-comment&quot;&gt;${classData.comment}&lt;/p&gt;` : ''}&#10;&#10;                ${classData.parent ? `&lt;p class=&quot;class-parent&quot;&gt;Extends: &lt;strong&gt;${classData.parent}&lt;/strong&gt;&lt;/p&gt;` : ''}&#10;&#10;                &lt;h5&gt;Data Properties (${allProps.length})&lt;/h5&gt;&#10;                &lt;ul class=&quot;property-list&quot;&gt;&#10;                    ${allProps.length &gt; 0 ? allProps.map(p =&gt; `&#10;                        &lt;li class=&quot;property-item-small&quot; onclick=&quot;yarrrmlBuilder.useProperty('${p.prefix}:${p.name}', '${p.type}')&quot;&gt;&#10;                            &lt;span class=&quot;prop-name&quot;&gt;${p.prefix}:${p.name}&lt;/span&gt;&#10;                            &lt;span class=&quot;prop-type&quot;&gt;${p.type}&lt;/span&gt;&#10;                        &lt;/li&gt;&#10;                    `).join('') : '&lt;li class=&quot;no-props&quot;&gt;No data properties defined&lt;/li&gt;'}&#10;                &lt;/ul&gt;&#10;&#10;                &lt;h5&gt;Relationships&lt;/h5&gt;&#10;                &lt;ul class=&quot;relationship-list&quot;&gt;&#10;                    ${this.ontology.objectProperties&#10;                        .filter(r =&gt; r.from === classData.id || r.to === classData.id)&#10;                        .map(r =&gt; `&#10;                            &lt;li class=&quot;rel-item&quot; onclick=&quot;yarrrmlBuilder.showRelationship('${r.from}', '${r.to}')&quot;&gt;&#10;                                ${r.from === classData.id&#10;                                    ? `&lt;span class=&quot;rel-arrow&quot;&gt;→&lt;/span&gt; &lt;strong&gt;${r.label}&lt;/strong&gt; → ${r.to}`&#10;                                    : `${r.from} → &lt;strong&gt;${r.label}&lt;/strong&gt; &lt;span class=&quot;rel-arrow&quot;&gt;→&lt;/span&gt;`&#10;                                }&#10;                            &lt;/li&gt;&#10;                        `).join('') || '&lt;li class=&quot;no-rels&quot;&gt;No relationships defined&lt;/li&gt;'}&#10;                &lt;/ul&gt;&#10;&#10;                &lt;div class=&quot;class-actions&quot;&gt;&#10;                    &lt;button class=&quot;btn btn-small btn-primary&quot; onclick=&quot;yarrrmlBuilder.useClassForMapping('${classData.prefix}:${classData.label}')&quot;&gt;&#10;                        Use in Mapping&#10;                    &lt;/button&gt;&#10;                    &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.expandClass('${classData.id}')&quot;&gt;&#10;                        Expand Neighbors&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    getAllPropertiesForClass(classId) {&#10;        const props = [];&#10;        const visited = new Set();&#10;&#10;        const collectProps = (id) =&gt; {&#10;            if (visited.has(id)) return;&#10;            visited.add(id);&#10;&#10;            const classProps = this.ontology.dataProperties[id] || [];&#10;            props.push(...classProps);&#10;&#10;            const cls = this.ontology.classes.find(c =&gt; c.id === id);&#10;            if (cls?.parent) {&#10;                collectProps(cls.parent);&#10;            }&#10;        };&#10;&#10;        collectProps(classId);&#10;        return props;&#10;    }&#10;&#10;    useClassForMapping(classUri) {&#10;        const classInput = document.getElementById('new-mapping-class');&#10;        const classSearchInput = document.getElementById('new-mapping-class-search');&#10;        if (classInput) {&#10;            classInput.value = classUri;&#10;        }&#10;        if (classSearchInput) {&#10;            classSearchInput.value = classUri;&#10;        }&#10;    }&#10;&#10;    useProperty(propertyUri, propType) {&#10;        // If we're on step 4, fill in the form&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;&#10;        if (predicateInput) {&#10;            predicateInput.value = propertyUri;&#10;        }&#10;&#10;        if (typeSelect &amp;&amp; propType) {&#10;            const typeMap = {&#10;                'string': 'string',&#10;                'integer': 'integer',&#10;                'decimal': 'decimal',&#10;                'date': 'date',&#10;                'dateTime': 'dateTime',&#10;                'boolean': 'boolean',&#10;                'iri': 'iri'&#10;            };&#10;            typeSelect.value = typeMap[propType] || 'string';&#10;        }&#10;&#10;        // If not on step 4, switch to it&#10;        if (this.currentStep !== 3) {&#10;            this.currentStep = 3;&#10;            this.renderBuilder();&#10;            // Re-fill after render&#10;            setTimeout(() =&gt; {&#10;                const input = document.getElementById('new-prop-predicate');&#10;                const select = document.getElementById('new-prop-type');&#10;                if (input) input.value = propertyUri;&#10;                if (select) select.value = propType || 'string';&#10;            }, 100);&#10;        }&#10;    }&#10;&#10;    // Event handlers&#10;    bindWizardEvents() {&#10;        document.getElementById('wizard-prev')?.addEventListener('click', () =&gt; this.prevStep());&#10;        document.getElementById('wizard-next')?.addEventListener('click', () =&gt; this.nextStep());&#10;    }&#10;&#10;    prevStep() {&#10;        if (this.currentStep &gt; 0) {&#10;            this.currentStep--;&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    nextStep() {&#10;        this.saveCurrentStep();&#10;        if (this.currentStep &lt; this.steps.length - 1) {&#10;            this.currentStep++;&#10;            this.renderBuilder();&#10;        } else {&#10;            this.downloadYAML();&#10;        }&#10;    }&#10;&#10;    saveCurrentStep() {&#10;        const step = this.steps[this.currentStep];&#10;&#10;        if (step === 'sources') {&#10;            const name = document.getElementById('new-source-name')?.value;&#10;            const type = document.getElementById('new-source-type')?.value;&#10;            const access = document.getElementById('new-source-access')?.value;&#10;            if (name &amp;&amp; access) {&#10;                this.mapping.sources[name] = { type, access, columns: this.detectedColumns };&#10;            }&#10;        } else if (step === 'classes') {&#10;            const mappingName = document.getElementById('new-mapping-name')?.value;&#10;            const source = document.getElementById('new-mapping-source')?.value;&#10;            const subject = document.getElementById('new-mapping-subject')?.value;&#10;            const rdfClass = document.getElementById('new-mapping-class')?.value;&#10;            if (mappingName &amp;&amp; subject &amp;&amp; rdfClass) {&#10;                this.mapping.mappings[mappingName] = {&#10;                    source: source,&#10;                    subject,&#10;                    class: rdfClass,&#10;                    properties: []&#10;                };&#10;            }&#10;        }&#10;    }&#10;&#10;    addSource() {&#10;        this.saveCurrentStep();&#10;        this.renderBuilder();&#10;    }&#10;&#10;    removeSource(name) {&#10;        delete this.mapping.sources[name];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addPrefix() {&#10;        const key = document.getElementById('new-prefix-key')?.value;&#10;        const uri = document.getElementById('new-prefix-uri')?.value;&#10;        if (key &amp;&amp; uri) {&#10;            this.mapping.prefixes[key] = uri;&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    removePrefix(key) {&#10;        delete this.mapping.prefixes[key];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addClassMapping() {&#10;        this.saveCurrentStep();&#10;        this.renderBuilder();&#10;    }&#10;&#10;    removeMapping(name) {&#10;        delete this.mapping.mappings[name];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addPropertyMapping() {&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            const emptyRow = tbody.querySelector('.empty-row');&#10;            if (emptyRow) emptyRow.remove();&#10;&#10;            const newRow = document.createElement('tr');&#10;            newRow.className = 'property-row';&#10;            newRow.innerHTML = `&#10;                &lt;td&gt;&lt;input type=&quot;text&quot; class=&quot;col-source&quot; placeholder=&quot;column&quot;&gt;&lt;/td&gt;&#10;                &lt;td&gt;&lt;input type=&quot;text&quot; class=&quot;col-predicate&quot; placeholder=&quot;prefix:property&quot;&gt;&lt;/td&gt;&#10;                &lt;td&gt;&#10;                    &lt;select class=&quot;col-type&quot;&gt;&#10;                        &lt;option value=&quot;literal&quot;&gt;string&lt;/option&gt;&#10;                        &lt;option value=&quot;integer&quot;&gt;integer&lt;/option&gt;&#10;                        &lt;option value=&quot;date&quot;&gt;date&lt;/option&gt;&#10;                        &lt;option value=&quot;uri&quot;&gt;URI&lt;/option&gt;&#10;                    &lt;/select&gt;&#10;                &lt;/td&gt;&#10;                &lt;td&gt;&lt;input type=&quot;checkbox&quot; class=&quot;col-provenance&quot;&gt;&lt;/td&gt;&#10;            `;&#10;            tbody.appendChild(newRow);&#10;        }&#10;    }&#10;&#10;    copyYAML() {&#10;        const yaml = document.getElementById('yaml-output')?.textContent;&#10;        navigator.clipboard.writeText(yaml);&#10;    }&#10;&#10;    downloadYAML() {&#10;        const yaml = this.generateYARRRML();&#10;        const blob = new Blob([yaml], { type: 'text/yaml' });&#10;        const url = URL.createObjectURL(blob);&#10;        const a = document.createElement('a');&#10;        a.href = url;&#10;        a.download = 'mapping.yarrrml.yaml';&#10;        a.click();&#10;        URL.revokeObjectURL(url);&#10;    }&#10;&#10;    escapeHtml(text) {&#10;        const div = document.createElement('div');&#10;        div.textContent = text;&#10;        return div.innerHTML;&#10;    }&#10;}&#10;&#10;// Initialize&#10;const yarrrmlBuilder = new YARRRMLBuilder();&#10;&#10;" />
              <option name="updatedContent" value="/**&#10; * YARRRML Builder - Visual Mapping Designer&#10; * Guides knowledge engineers through creating YARRRML mappings&#10; * Loads ontology from server-indexed classes and properties&#10; */&#10;&#10;class YARRRMLBuilder {&#10;    constructor() {&#10;        this.mapping = {&#10;            prefixes: {},&#10;            sources: {},&#10;            mappings: {}&#10;        };&#10;        this.currentStep = 0;&#10;        this.steps = ['sources', 'prefixes', 'classes', 'properties', 'review'];&#10;        this.ontology = null;&#10;        this.selectedClass = null;&#10;        this.visibleClasses = new Set();&#10;        this.ontologyIndex = new Map();&#10;        this.contextMenu = null;&#10;        this.detectedColumns = [];&#10;    }&#10;&#10;    init() {&#10;        console.log('YARRRMLBuilder.init() called');&#10;        this.renderBuilder();&#10;        this.loadDefaultPrefixes();&#10;&#10;        // Defer ontology loading until after container is visible&#10;        // The mode switch shows the container, then this runs&#10;        requestAnimationFrame(() =&gt; {&#10;            this.loadOntologyFromServer();&#10;        });&#10;    }&#10;&#10;    loadDefaultPrefixes() {&#10;        this.mapping.prefixes = {&#10;            'ex': 'http://example.org/',&#10;            'schema': 'http://schema.org/',&#10;            'foaf': 'http://xmlns.com/foaf/0.1/',&#10;            'prov': 'http://www.w3.org/ns/prov#',&#10;            'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',&#10;            'rdfs': 'http://www.w3.org/2000/01/rdf-schema#',&#10;            'xsd': 'http://www.w3.org/2001/XMLSchema#',&#10;            'dct': 'http://purl.org/dc/terms/',&#10;            'dcat': 'http://www.w3.org/ns/dcat#',&#10;            'owl': 'http://www.w3.org/2002/07/owl#'&#10;        };&#10;    }&#10;&#10;    /**&#10;     * Load ontology classes and properties from the server's /ontologies endpoint&#10;     */&#10;    async loadOntologyFromServer() {&#10;        try {&#10;            // Add cache-busting parameter to ensure fresh data&#10;            const cacheBuster = Date.now();&#10;            const response = await fetch(`/ontologies?_=${cacheBuster}`, {&#10;                cache: 'no-store',&#10;                headers: {&#10;                    'Cache-Control': 'no-cache'&#10;                }&#10;            });&#10;            if (!response.ok) {&#10;                throw new Error(`Failed to load ontology from server: ${response.status}`);&#10;            }&#10;&#10;            const data = await response.json();&#10;            console.log('Raw ontology response from server:', data);&#10;&#10;            // Check if we got any classes&#10;            if (!data.classes || data.classes.length === 0) {&#10;                console.warn('Server returned no ontology classes');&#10;                this.showOntologyError('No ontology classes found. Make sure your ontology files are loaded on the server.');&#10;                this.ontology = { classes: [], objectProperties: [], dataProperties: {} };&#10;                this.updateOntologyStats();&#10;                return;&#10;            }&#10;&#10;            // Deduplicate classes by URI&#10;            const uniqueClasses = new Map();&#10;            data.classes.forEach(c =&gt; {&#10;                if (!uniqueClasses.has(c.uri)) {&#10;                    uniqueClasses.set(c.uri, c);&#10;                }&#10;            });&#10;            const deduplicatedClasses = Array.from(uniqueClasses.values());&#10;            console.log(`Deduplicated ${data.classes.length} classes to ${deduplicatedClasses.length}`);&#10;&#10;            // Transform server response to our internal format&#10;            this.ontology = {&#10;                classes: deduplicatedClasses.map(c =&gt; ({&#10;                    id: this.extractLocalName(c.uri),&#10;                    label: this.cleanLabel(c.label),&#10;                    uri: c.uri,&#10;                    prefix: this.getPrefix(c.uri),&#10;                    // Ignore blank node parents (start with _:)&#10;                    parent: (c.parent &amp;&amp; !c.parent.startsWith('_:')) ? this.extractLocalName(c.parent) : null,&#10;                    comment: this.cleanLabel(c.comment)&#10;                })),&#10;                // Filter out object properties with null domain or range&#10;                objectProperties: data.objectProperties&#10;                    .filter(p =&gt; p.domain &amp;&amp; p.range &amp;&amp; !p.domain.startsWith('_:') &amp;&amp; !p.range.startsWith('_:'))&#10;                    .map(p =&gt; ({&#10;                        uri: p.uri,&#10;                        label: this.cleanLabel(p.label),&#10;                        from: this.extractLocalName(p.domain),&#10;                        to: this.extractLocalName(p.range),&#10;                        prefix: this.getPrefix(p.uri)&#10;                    })),&#10;                dataProperties: {}&#10;            };&#10;&#10;            // Group datatype properties by domain class&#10;            data.datatypeProperties.forEach(p =&gt; {&#10;                // Skip if domain is blank node or null&#10;                if (!p.domain || p.domain.startsWith('_:')) return;&#10;&#10;                const domain = this.extractLocalName(p.domain);&#10;                if (!this.ontology.dataProperties[domain]) {&#10;                    this.ontology.dataProperties[domain] = [];&#10;                }&#10;                this.ontology.dataProperties[domain].push({&#10;                    name: this.cleanLabel(p.label),&#10;                    uri: p.uri,&#10;                    type: this.extractDatatype(p.range),&#10;                    prefix: this.getPrefix(p.uri)&#10;                });&#10;            });&#10;&#10;            console.log(`Loaded ontology: ${data.counts.classes} classes, ${data.counts.objectProperties} object properties, ${data.counts.datatypeProperties} datatype properties`);&#10;            console.log('Transformed classes:', this.ontology.classes.map(c =&gt; c.id));&#10;            console.log('Transformed object properties:', this.ontology.objectProperties.length,&#10;                this.ontology.objectProperties.map(p =&gt; `${p.from} --${p.label}--&gt; ${p.to}`));&#10;&#10;            this.buildSearchIndex();&#10;            this.updateOntologyStats();&#10;&#10;            // Show all classes initially - with delay to ensure DOM is laid out&#10;            if (this.ontology.classes.length &gt; 0) {&#10;                setTimeout(() =&gt; {&#10;                    console.log('Initializing graph after ontology load');&#10;                    const container = document.getElementById('ontology-graph');&#10;                    if (!container) {&#10;                        console.error('Container not found');&#10;                        return;&#10;                    }&#10;                    console.log('Container size:', container.getBoundingClientRect());&#10;                    this.initOntologyGraph();&#10;&#10;                    // Show all classes - don't try to focus on just one&#10;                    this.visibleClasses.clear();&#10;                    this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;                    console.log('Initial visible classes:', Array.from(this.visibleClasses));&#10;&#10;                    this.renderOntologyGraph();&#10;                }, 200);&#10;            }&#10;&#10;        } catch (error) {&#10;            console.error('Error loading ontology:', error);&#10;            this.showOntologyError(`Failed to load ontology: ${error.message}. Is the server running?`);&#10;            this.ontology = { classes: [], objectProperties: [], dataProperties: {} };&#10;            this.updateOntologyStats();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Show an error message in the ontology panel&#10;     */&#10;    showOntologyError(message) {&#10;        const details = document.getElementById('ontology-details');&#10;        if (details) {&#10;            details.innerHTML = `&#10;                &lt;div class=&quot;empty-state error&quot;&gt;&#10;                    &lt;svg width=&quot;24&quot; height=&quot;24&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&#10;                        &lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z&quot;/&gt;&#10;                    &lt;/svg&gt;&#10;                    &lt;p&gt;${message}&lt;/p&gt;&#10;                    &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.loadOntologyFromServer()&quot;&gt;&#10;                        Retry&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        // Also clear the graph&#10;        const svg = d3.select('#ontology-canvas');&#10;        const g = svg.select('g.ontology-content');&#10;        if (g.node()) {&#10;            g.selectAll('*').remove();&#10;        }&#10;    }&#10;&#10;    extractLocalName(uri) {&#10;        if (!uri) return '';&#10;        const hashIdx = uri.lastIndexOf('#');&#10;        const slashIdx = uri.lastIndexOf('/');&#10;        const idx = Math.max(hashIdx, slashIdx);&#10;        return idx &gt;= 0 ? uri.substring(idx + 1) : uri;&#10;    }&#10;&#10;    /**&#10;     * Clean label by removing language tags, quotes, and extra whitespace&#10;     * e.g., '&quot;Activity&quot;@en' becomes 'Activity'&#10;     */&#10;    cleanLabel(label) {&#10;        if (!label) return '';&#10;        let cleaned = label;&#10;        // Remove language tags like @en, @de&#10;        cleaned = cleaned.replace(/@[a-z]{2,}(-[A-Z]{2,})?$/i, '');&#10;        // Remove surrounding quotes&#10;        cleaned = cleaned.replace(/^[&quot;']|[&quot;']$/g, '');&#10;        // Trim whitespace&#10;        cleaned = cleaned.trim();&#10;        return cleaned || label;&#10;    }&#10;&#10;    getPrefix(uri) {&#10;        if (!uri) return 'ex';&#10;        for (const [prefix, ns] of Object.entries(this.mapping.prefixes)) {&#10;            if (uri.startsWith(ns)) {&#10;                return prefix;&#10;            }&#10;        }&#10;        // Try to extract prefix from common patterns&#10;        if (uri.includes('schema.org')) return 'schema';&#10;        if (uri.includes('foaf')) return 'foaf';&#10;        if (uri.includes('prov')) return 'prov';&#10;        if (uri.includes('dcat')) return 'dcat';&#10;        if (uri.includes('dc/terms')) return 'dct';&#10;        if (uri.includes('owl')) return 'owl';&#10;        if (uri.includes('rdfs')) return 'rdfs';&#10;        if (uri.includes('rdf')) return 'rdf';&#10;        return 'ex';&#10;    }&#10;&#10;    extractDatatype(rangeUri) {&#10;        if (!rangeUri) return 'string';&#10;        const local = this.extractLocalName(rangeUri);&#10;        if (local.includes('int') || local.includes('Int')) return 'integer';&#10;        if (local.includes('decimal') || local.includes('float') || local.includes('double')) return 'decimal';&#10;        if (local.includes('date') &amp;&amp; local.includes('Time')) return 'dateTime';&#10;        if (local.includes('date') || local.includes('Date')) return 'date';&#10;        if (local.includes('bool')) return 'boolean';&#10;        return 'string';&#10;    }&#10;&#10;    renderBuilder() {&#10;        const container = document.getElementById('yarrrml-builder');&#10;&#10;        container.innerHTML = `&#10;            &lt;div class=&quot;yarrrml-layout&quot;&gt;&#10;                &lt;!-- Left: Wizard Panel --&gt;&#10;                &lt;div class=&quot;wizard-panel&quot;&gt;&#10;                    &lt;div class=&quot;yarrrml-wizard&quot;&gt;&#10;                        &lt;!-- Progress Steps --&gt;&#10;                        &lt;div class=&quot;wizard-progress&quot;&gt;&#10;                            ${this.steps.map((step, i) =&gt; `&#10;                                &lt;div class=&quot;progress-step ${i === this.currentStep ? 'active' : ''} ${i &lt; this.currentStep ? 'completed' : ''}&quot; data-step=&quot;${i}&quot;&gt;&#10;                                    &lt;div class=&quot;step-number&quot;&gt;${i + 1}&lt;/div&gt;&#10;                                    &lt;div class=&quot;step-label&quot;&gt;${this.getStepLabel(step)}&lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            `).join('&lt;div class=&quot;progress-line&quot;&gt;&lt;/div&gt;')}&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Wizard Content --&gt;&#10;                        &lt;div class=&quot;wizard-content&quot;&gt;&#10;                            ${this.renderCurrentStep()}&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Navigation --&gt;&#10;                        &lt;div class=&quot;wizard-nav&quot;&gt;&#10;                            &lt;button class=&quot;btn btn-secondary&quot; id=&quot;wizard-prev&quot; ${this.currentStep === 0 ? 'disabled' : ''}&gt;&#10;                                &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z&quot;/&gt;&lt;/svg&gt;&#10;                                Previous&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-primary&quot; id=&quot;wizard-next&quot;&gt;&#10;                                ${this.currentStep === this.steps.length - 1 ? 'Generate YARRRML' : 'Next'}&#10;                                &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Right: Ontology Browser Panel --&gt;&#10;                &lt;div class=&quot;ontology-browser&quot;&gt;&#10;                    &lt;div class=&quot;ontology-header&quot;&gt;&#10;                        &lt;h3&gt;&#10;                            &lt;svg width=&quot;18&quot; height=&quot;18&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&#10;                                &lt;path d=&quot;M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z&quot;/&gt;&#10;                            &lt;/svg&gt;&#10;                            Ontology Browser&#10;                        &lt;/h3&gt;&#10;                        &lt;span class=&quot;ontology-stats&quot; id=&quot;ontology-stats&quot;&gt;&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Search Box --&gt;&#10;                    &lt;div class=&quot;ontology-search&quot;&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;ontology-search&quot; placeholder=&quot;Search classes, properties...&quot;&#10;                               onkeyup=&quot;yarrrmlBuilder.searchOntology(this.value)&quot;&gt;&#10;                        &lt;div class=&quot;search-results&quot; id=&quot;search-results&quot;&gt;&lt;/div&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Graph Area --&gt;&#10;                    &lt;div class=&quot;ontology-graph-area&quot;&gt;&#10;                        &lt;div class=&quot;graph-toolbar&quot;&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.resetOntologyView()&quot; title=&quot;Reset View&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z&quot;/&gt;&lt;/svg&gt;&#10;                                Reset&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.expandAll()&quot; title=&quot;Expand All&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z&quot;/&gt;&lt;/svg&gt;&#10;                                Expand&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.loadOntologyFromServer()&quot; title=&quot;Reload from Server&quot;&gt;&#10;                                &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z&quot;/&gt;&lt;/svg&gt;&#10;                                Reload&#10;                            &lt;/button&gt;&#10;                            &lt;span class=&quot;graph-hint&quot;&gt;Right-click to expand&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;ontology-graph&quot; id=&quot;ontology-graph&quot;&gt;&#10;                            &lt;svg id=&quot;ontology-canvas&quot;&gt;&lt;/svg&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;!-- Class Details Panel --&gt;&#10;                    &lt;div class=&quot;ontology-details&quot; id=&quot;ontology-details&quot;&gt;&#10;                        &lt;div class=&quot;empty-state small&quot;&gt;&#10;                            &lt;p&gt;Search for a class or click one in the graph&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;!-- Context Menu (hidden by default) --&gt;&#10;            &lt;div class=&quot;context-menu&quot; id=&quot;context-menu&quot; style=&quot;display: none;&quot;&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;expand&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z&quot;/&gt;&lt;/svg&gt;&#10;                    Expand Neighbors&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;focus&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z&quot;/&gt;&lt;/svg&gt;&#10;                    Focus on This Class&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;hide&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27z&quot;/&gt;&lt;/svg&gt;&#10;                    Hide This Class&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-divider&quot;&gt;&lt;/div&gt;&#10;                &lt;div class=&quot;context-menu-item&quot; data-action=&quot;use-mapping&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Use in Mapping&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;&#10;        this.bindWizardEvents();&#10;        // Don't init graph here - it's done after ontology loads when container is visible&#10;        this.bindContextMenu();&#10;        this.bindDropdownHandlers();&#10;        this.updateOntologyStats();&#10;        console.log('renderBuilder() complete, ontology-graph element:', document.getElementById('ontology-graph'));&#10;    }&#10;&#10;    bindDropdownHandlers() {&#10;        // Close dropdowns when clicking outside&#10;        document.addEventListener('click', (e) =&gt; {&#10;            const classDropdown = document.getElementById('class-dropdown');&#10;            const predicateDropdown = document.getElementById('predicate-dropdown');&#10;&#10;            if (classDropdown &amp;&amp; !e.target.closest('.class-search-wrapper')) {&#10;                classDropdown.style.display = 'none';&#10;            }&#10;            if (predicateDropdown &amp;&amp; !e.target.closest('.predicate-search-wrapper')) {&#10;                predicateDropdown.style.display = 'none';&#10;            }&#10;        });&#10;    }&#10;&#10;    updateOntologyStats() {&#10;        const statsEl = document.getElementById('ontology-stats');&#10;        if (statsEl &amp;&amp; this.ontology) {&#10;            const classCount = this.ontology.classes?.length || 0;&#10;            const propCount = (this.ontology.objectProperties?.length || 0) +&#10;                Object.values(this.ontology.dataProperties || {}).reduce((sum, arr) =&gt; sum + arr.length, 0);&#10;            statsEl.textContent = `${classCount} classes, ${propCount} properties`;&#10;        }&#10;    }&#10;&#10;    getStepLabel(step) {&#10;        const labels = {&#10;            'sources': 'Data Sources',&#10;            'prefixes': 'Prefixes',&#10;            'classes': 'Class Mappings',&#10;            'properties': 'Properties',&#10;            'review': 'Review &amp; Export'&#10;        };&#10;        return labels[step];&#10;    }&#10;&#10;    renderCurrentStep() {&#10;        const step = this.steps[this.currentStep];&#10;&#10;        switch(step) {&#10;            case 'sources':&#10;                return this.renderSourcesStep();&#10;            case 'prefixes':&#10;                return this.renderPrefixesStep();&#10;            case 'classes':&#10;                return this.renderClassesStep();&#10;            case 'properties':&#10;                return this.renderPropertiesStep();&#10;            case 'review':&#10;                return this.renderReviewStep();&#10;            default:&#10;                return '&lt;p&gt;Unknown step&lt;/p&gt;';&#10;        }&#10;    }&#10;&#10;    renderSourcesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 1: Define Data Sources&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Specify the data sources that will be transformed into RDF.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;sources-list&quot; id=&quot;sources-list&quot;&gt;&#10;                    ${this.renderSourcesList()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addSource()&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Add Source&#10;                &lt;/button&gt;&#10;&#10;                &lt;!-- CSV Preview Section --&gt;&#10;                &lt;div class=&quot;csv-preview-section&quot; id=&quot;csv-preview-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z&quot;/&gt;&lt;/svg&gt;&#10;                        Detected Columns&#10;                    &lt;/h4&gt;&#10;                    &lt;div class=&quot;csv-columns&quot; id=&quot;csv-columns&quot;&gt;&lt;/div&gt;&#10;                    &lt;div class=&quot;csv-sample&quot; id=&quot;csv-sample&quot;&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- File Upload --&gt;&#10;                &lt;div class=&quot;file-upload-section&quot;&gt;&#10;                    &lt;label class=&quot;file-upload-label&quot;&gt;&#10;                        &lt;input type=&quot;file&quot; id=&quot;csv-file-input&quot; accept=&quot;.csv&quot; onchange=&quot;yarrrmlBuilder.handleCSVUpload(event)&quot; style=&quot;display:none;&quot;&gt;&#10;                        &lt;span class=&quot;btn btn-secondary&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z&quot;/&gt;&lt;/svg&gt;&#10;                            Upload CSV to Preview Columns&#10;                        &lt;/span&gt;&#10;                    &lt;/label&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Supported Sources&#10;                    &lt;/h4&gt;&#10;                    &lt;ul&gt;&#10;                        &lt;li&gt;&lt;strong&gt;CSV/JSON/XML:&lt;/strong&gt; File path or URL&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Databases:&lt;/strong&gt; PostgreSQL, MySQL, Oracle, SQL Server&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;SPARQL:&lt;/strong&gt; Query remote endpoints&lt;/li&gt;&#10;                    &lt;/ul&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    handleCSVUpload(event) {&#10;        const file = event.target.files[0];&#10;        if (!file) return;&#10;&#10;        const reader = new FileReader();&#10;        reader.onload = (e) =&gt; {&#10;            const text = e.target.result;&#10;            this.parseCSVPreview(text, file.name);&#10;        };&#10;        reader.readAsText(file);&#10;    }&#10;&#10;    parseCSVPreview(csvText, fileName) {&#10;        const lines = csvText.split('\n').filter(l =&gt; l.trim());&#10;        if (lines.length === 0) return;&#10;&#10;        const headers = this.parseCSVLine(lines[0]);&#10;        this.detectedColumns = headers;&#10;&#10;        const sampleRows = [];&#10;        for (let i = 1; i &lt; Math.min(4, lines.length); i++) {&#10;            sampleRows.push(this.parseCSVLine(lines[i]));&#10;        }&#10;&#10;        const accessInput = document.getElementById('new-source-access');&#10;        if (accessInput) {&#10;            accessInput.value = `data/${fileName}`;&#10;        }&#10;&#10;        const previewSection = document.getElementById('csv-preview-section');&#10;        const columnsDiv = document.getElementById('csv-columns');&#10;        const sampleDiv = document.getElementById('csv-sample');&#10;&#10;        if (previewSection &amp;&amp; columnsDiv) {&#10;            previewSection.style.display = 'block';&#10;&#10;            columnsDiv.innerHTML = `&#10;                &lt;div class=&quot;column-chips&quot;&gt;&#10;                    ${headers.map(h =&gt; `&lt;span class=&quot;column-chip&quot;&gt;${h}&lt;/span&gt;`).join('')}&#10;                &lt;/div&gt;&#10;            `;&#10;&#10;            if (sampleRows.length &gt; 0) {&#10;                sampleDiv.innerHTML = `&#10;                    &lt;table class=&quot;csv-sample-table&quot;&gt;&#10;                        &lt;thead&gt;&#10;                            &lt;tr&gt;${headers.map(h =&gt; `&lt;th&gt;${h}&lt;/th&gt;`).join('')}&lt;/tr&gt;&#10;                        &lt;/thead&gt;&#10;                        &lt;tbody&gt;&#10;                            ${sampleRows.map(row =&gt; `&#10;                                &lt;tr&gt;${row.map(cell =&gt; `&lt;td&gt;${cell || ''}&lt;/td&gt;`).join('')}&lt;/tr&gt;&#10;                            `).join('')}&#10;                        &lt;/tbody&gt;&#10;                    &lt;/table&gt;&#10;                `;&#10;            }&#10;        }&#10;    }&#10;&#10;    parseCSVLine(line) {&#10;        const result = [];&#10;        let current = '';&#10;        let inQuotes = false;&#10;&#10;        for (let i = 0; i &lt; line.length; i++) {&#10;            const char = line[i];&#10;            if (char === '&quot;') {&#10;                inQuotes = !inQuotes;&#10;            } else if (char === ',' &amp;&amp; !inQuotes) {&#10;                result.push(current.trim());&#10;                current = '';&#10;            } else {&#10;                current += char;&#10;            }&#10;        }&#10;        result.push(current.trim());&#10;        return result;&#10;    }&#10;&#10;    renderSourcesList() {&#10;        const sources = Object.entries(this.mapping.sources);&#10;&#10;        if (sources.length === 0) {&#10;            return `&#10;                &lt;div class=&quot;source-item new&quot;&gt;&#10;                    &lt;div class=&quot;form-row&quot;&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Source Name&lt;/label&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-source-name&quot; placeholder=&quot;e.g., source1&quot; value=&quot;&quot;&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Type&lt;/label&gt;&#10;                            &lt;select id=&quot;new-source-type&quot; onchange=&quot;yarrrmlBuilder.onSourceTypeChange(this.value)&quot;&gt;&#10;                                &lt;option value=&quot;csv&quot;&gt;CSV&lt;/option&gt;&#10;                                &lt;option value=&quot;json&quot;&gt;JSON&lt;/option&gt;&#10;                                &lt;option value=&quot;xml&quot;&gt;XML&lt;/option&gt;&#10;                                &lt;option value=&quot;postgresql&quot;&gt;PostgreSQL&lt;/option&gt;&#10;                                &lt;option value=&quot;mysql&quot;&gt;MySQL&lt;/option&gt;&#10;                                &lt;option value=&quot;sparql&quot;&gt;SPARQL&lt;/option&gt;&#10;                            &lt;/select&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;Access Path / Connection&lt;/label&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;new-source-access&quot; placeholder=&quot;data/source.csv&quot; value=&quot;&quot;&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group db-options&quot; id=&quot;db-options&quot; style=&quot;display:none;&quot;&gt;&#10;                        &lt;label&gt;Query&lt;/label&gt;&#10;                        &lt;textarea id=&quot;new-source-query&quot; placeholder=&quot;SELECT * FROM table&quot;&gt;&lt;/textarea&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        return sources.map(([name, config]) =&gt; `&#10;            &lt;div class=&quot;source-item&quot;&gt;&#10;                &lt;div class=&quot;source-header&quot;&gt;&#10;                    &lt;span class=&quot;source-name&quot;&gt;${name}&lt;/span&gt;&#10;                    &lt;span class=&quot;source-type-badge&quot;&gt;${config.type || 'csv'}&lt;/span&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removeSource('${name}')&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;source-details&quot;&gt;&#10;                    &lt;code&gt;${config.access}&lt;/code&gt;&#10;                    ${config.columns ? `&lt;div class=&quot;source-columns&quot;&gt;${config.columns.length} columns detected&lt;/div&gt;` : ''}&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    onSourceTypeChange(type) {&#10;        const dbOptions = document.getElementById('db-options');&#10;        if (dbOptions) {&#10;            dbOptions.style.display = ['postgresql', 'mysql', 'oracle', 'sparql'].includes(type) ? 'block' : 'none';&#10;        }&#10;    }&#10;&#10;    renderPrefixesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 2: Configure Prefixes&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Define namespace prefixes for your ontology.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;prefixes-grid&quot; id=&quot;prefixes-grid&quot;&gt;&#10;                    ${Object.entries(this.mapping.prefixes).map(([prefix, uri]) =&gt; `&#10;                        &lt;div class=&quot;prefix-item&quot;&gt;&#10;                            &lt;input type=&quot;text&quot; class=&quot;prefix-key&quot; value=&quot;${prefix}&quot; readonly&gt;&#10;                            &lt;input type=&quot;text&quot; class=&quot;prefix-uri&quot; value=&quot;${uri}&quot;&gt;&#10;                            &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePrefix('${prefix}')&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    `).join('')}&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;add-prefix-form&quot;&gt;&#10;                    &lt;input type=&quot;text&quot; id=&quot;new-prefix-key&quot; placeholder=&quot;prefix&quot;&gt;&#10;                    &lt;input type=&quot;text&quot; id=&quot;new-prefix-uri&quot; placeholder=&quot;http://example.org/ontology#&quot;&gt;&#10;                    &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addPrefix()&quot;&gt;Add&lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    renderClassesStep() {&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 3: Define Class Mappings&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Map source rows to RDF classes. Use the ontology browser to find classes.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;class-mappings&quot; id=&quot;class-mappings&quot;&gt;&#10;                    ${this.renderClassMappings()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.addClassMapping()&quot;&gt;&#10;                    &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                    Add Class Mapping&#10;                &lt;/button&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Subject Template&#10;                    &lt;/h4&gt;&#10;                    &lt;p&gt;Use &lt;code&gt;$(column)&lt;/code&gt; for source columns.&lt;/p&gt;&#10;                    &lt;p&gt;Example: &lt;code&gt;http://example.org/resource/$(id)&lt;/code&gt;&lt;/p&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    renderClassMappings() {&#10;        const mappings = Object.entries(this.mapping.mappings);&#10;        const sourceOptions = Object.keys(this.mapping.sources).length &gt; 0&#10;            ? Object.keys(this.mapping.sources).map(s =&gt; `&lt;option value=&quot;${s}&quot;&gt;${s}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Define a source first --&lt;/option&gt;';&#10;&#10;        // Build class options from ontology&#10;        const classOptions = this.ontology?.classes?.length &gt; 0&#10;            ? this.ontology.classes.map(c =&gt; `&lt;option value=&quot;${c.prefix}:${c.label}&quot;&gt;${c.prefix}:${c.label}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Load ontology first --&lt;/option&gt;';&#10;&#10;        if (mappings.length === 0) {&#10;            return `&#10;                &lt;div class=&quot;class-mapping-item new&quot;&gt;&#10;                    &lt;div class=&quot;form-row&quot;&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Mapping Name&lt;/label&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-mapping-name&quot; placeholder=&quot;e.g., DatasetMapping&quot; value=&quot;&quot;&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div class=&quot;form-group&quot;&gt;&#10;                            &lt;label&gt;Source&lt;/label&gt;&#10;                            &lt;select id=&quot;new-mapping-source&quot;&gt;&#10;                                ${sourceOptions}&#10;                            &lt;/select&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;Subject Template&lt;/label&gt;&#10;                        &lt;input type=&quot;text&quot; id=&quot;new-mapping-subject&quot; placeholder=&quot;http://example.org/resource/$(id)&quot; value=&quot;&quot;&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;form-group&quot;&gt;&#10;                        &lt;label&gt;RDF Class&lt;/label&gt;&#10;                        &lt;div class=&quot;class-search-wrapper&quot;&gt;&#10;                            &lt;input type=&quot;text&quot; id=&quot;new-mapping-class-search&quot;&#10;                                   placeholder=&quot;Type to search classes...&quot;&#10;                                   oninput=&quot;yarrrmlBuilder.filterClassOptions(this.value)&quot;&#10;                                   onfocus=&quot;yarrrmlBuilder.showClassDropdown()&quot;&gt;&#10;                            &lt;input type=&quot;hidden&quot; id=&quot;new-mapping-class&quot; value=&quot;&quot;&gt;&#10;                            &lt;div class=&quot;class-dropdown&quot; id=&quot;class-dropdown&quot; style=&quot;display: none;&quot;&gt;&#10;                                ${this.ontology?.classes?.map(c =&gt; `&#10;                                    &lt;div class=&quot;class-option&quot; onclick=&quot;yarrrmlBuilder.selectClassOption('${c.prefix}:${c.label}', '${c.id}')&quot;&gt;&#10;                                        &lt;span class=&quot;class-option-label&quot;&gt;${c.prefix}:${c.label}&lt;/span&gt;&#10;                                        &lt;span class=&quot;class-option-uri&quot;&gt;${c.uri}&lt;/span&gt;&#10;                                    &lt;/div&gt;&#10;                                `).join('') || '&lt;div class=&quot;class-option disabled&quot;&gt;No classes loaded&lt;/div&gt;'}&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            `;&#10;        }&#10;&#10;        return mappings.map(([name, config]) =&gt; `&#10;            &lt;div class=&quot;class-mapping-item&quot;&gt;&#10;                &lt;div class=&quot;mapping-header&quot;&gt;&#10;                    &lt;span class=&quot;mapping-name&quot;&gt;${name}&lt;/span&gt;&#10;                    &lt;span class=&quot;mapping-class-badge&quot;&gt;${config.class || 'No class'}&lt;/span&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removeMapping('${name}')&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;mapping-details&quot;&gt;&#10;                    &lt;div&gt;Source: &lt;code&gt;${config.source}&lt;/code&gt;&lt;/div&gt;&#10;                    &lt;div&gt;Subject: &lt;code&gt;${config.subject}&lt;/code&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    showClassDropdown() {&#10;        const dropdown = document.getElementById('class-dropdown');&#10;        if (dropdown) {&#10;            dropdown.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    filterClassOptions(query) {&#10;        const dropdown = document.getElementById('class-dropdown');&#10;        if (!dropdown || !this.ontology?.classes) return;&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const filtered = this.ontology.classes.filter(c =&gt;&#10;            c.label.toLowerCase().includes(queryLower) ||&#10;            c.id.toLowerCase().includes(queryLower) ||&#10;            c.prefix.toLowerCase().includes(queryLower)&#10;        );&#10;&#10;        dropdown.innerHTML = filtered.length &gt; 0&#10;            ? filtered.map(c =&gt; `&#10;                &lt;div class=&quot;class-option&quot; onclick=&quot;yarrrmlBuilder.selectClassOption('${c.prefix}:${c.label}', '${c.id}')&quot;&gt;&#10;                    &lt;span class=&quot;class-option-label&quot;&gt;${c.prefix}:${c.label}&lt;/span&gt;&#10;                    &lt;span class=&quot;class-option-uri&quot;&gt;${c.uri}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            `).join('')&#10;            : '&lt;div class=&quot;class-option disabled&quot;&gt;No matching classes&lt;/div&gt;';&#10;&#10;        dropdown.style.display = 'block';&#10;    }&#10;&#10;    selectClassOption(classUri, classId) {&#10;        const searchInput = document.getElementById('new-mapping-class-search');&#10;        const hiddenInput = document.getElementById('new-mapping-class');&#10;        const dropdown = document.getElementById('class-dropdown');&#10;&#10;        if (searchInput) searchInput.value = classUri;&#10;        if (hiddenInput) hiddenInput.value = classUri;&#10;        if (dropdown) dropdown.style.display = 'none';&#10;&#10;        // Also focus on this class in the ontology browser&#10;        this.focusOnClass(classId);&#10;    }&#10;&#10;    renderPropertiesStep() {&#10;        const mappingOptions = Object.keys(this.mapping.mappings).length &gt; 0&#10;            ? Object.keys(this.mapping.mappings).map(m =&gt; `&lt;option value=&quot;${m}&quot;&gt;${m}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Define a mapping first --&lt;/option&gt;';&#10;&#10;        // Get detected columns from source&#10;        const columns = this.detectedColumns || [];&#10;        const columnOptions = columns.length &gt; 0&#10;            ? columns.map(c =&gt; `&lt;option value=&quot;${c}&quot;&gt;${c}&lt;/option&gt;`).join('')&#10;            : '&lt;option value=&quot;&quot;&gt;-- Upload CSV to detect columns --&lt;/option&gt;';&#10;&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 4: Map Properties&lt;/h2&gt;&#10;                &lt;p class=&quot;step-description&quot;&gt;&#10;                    Map source columns to RDF predicates. For object properties (IRI references), you can construct URIs from prefix + column values.&#10;                &lt;/p&gt;&#10;&#10;                &lt;div class=&quot;property-mapping-section&quot;&gt;&#10;                    &lt;div class=&quot;mapping-selector&quot;&gt;&#10;                        &lt;label&gt;Target Mapping:&lt;/label&gt;&#10;                        &lt;select id=&quot;property-mapping-select&quot; onchange=&quot;yarrrmlBuilder.onMappingChange(this.value)&quot;&gt;&#10;                            ${mappingOptions}&#10;                        &lt;/select&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;properties-table&quot;&gt;&#10;                        &lt;table&gt;&#10;                            &lt;thead&gt;&#10;                                &lt;tr&gt;&#10;                                    &lt;th style=&quot;width: 30%;&quot;&gt;RDF Predicate&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 35%;&quot;&gt;Value Template&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 15%;&quot;&gt;Type&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 10%;&quot;&gt;Provenance&lt;/th&gt;&#10;                                    &lt;th style=&quot;width: 10%;&quot;&gt;&lt;/th&gt;&#10;                                &lt;/tr&gt;&#10;                            &lt;/thead&gt;&#10;                            &lt;tbody id=&quot;properties-tbody&quot;&gt;&#10;                                ${this.renderPropertyRows()}&#10;                            &lt;/tbody&gt;&#10;                        &lt;/table&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;add-property-form&quot;&gt;&#10;                        &lt;h4&gt;Add Property Mapping&lt;/h4&gt;&#10;&#10;                        &lt;div class=&quot;form-row&quot;&gt;&#10;                            &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                &lt;label&gt;RDF Predicate&lt;/label&gt;&#10;                                &lt;div class=&quot;predicate-search-wrapper&quot;&gt;&#10;                                    &lt;input type=&quot;text&quot; id=&quot;new-prop-predicate&quot;&#10;                                           placeholder=&quot;Type to search properties...&quot;&#10;                                           oninput=&quot;yarrrmlBuilder.filterPredicateOptions(this.value)&quot;&#10;                                           onfocus=&quot;yarrrmlBuilder.showPredicateDropdown()&quot;&gt;&#10;                                    &lt;div class=&quot;predicate-dropdown&quot; id=&quot;predicate-dropdown&quot; style=&quot;display: none;&quot;&gt;&#10;                                        ${this.renderPredicateOptions()}&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.8;&quot;&gt;&#10;                                &lt;label&gt;Value Type&lt;/label&gt;&#10;                                &lt;select id=&quot;new-prop-type&quot; onchange=&quot;yarrrmlBuilder.onValueTypeChange(this.value)&quot;&gt;&#10;                                    &lt;option value=&quot;literal&quot;&gt;Literal (Data Property)&lt;/option&gt;&#10;                                    &lt;option value=&quot;iri&quot;&gt;IRI (Object Property)&lt;/option&gt;&#10;                                &lt;/select&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- Literal Value Section --&gt;&#10;                        &lt;div id=&quot;literal-value-section&quot;&gt;&#10;                            &lt;div class=&quot;form-row&quot;&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                    &lt;label&gt;Source Column&lt;/label&gt;&#10;                                    &lt;select id=&quot;new-prop-column&quot;&gt;&#10;                                        &lt;option value=&quot;&quot;&gt;Select column...&lt;/option&gt;&#10;                                        ${columnOptions}&#10;                                    &lt;/select&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                    &lt;label&gt;Or Custom Value&lt;/label&gt;&#10;                                    &lt;input type=&quot;text&quot; id=&quot;new-prop-column-custom&quot; placeholder=&quot;column_name or static value&quot;&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.8;&quot;&gt;&#10;                                    &lt;label&gt;Datatype&lt;/label&gt;&#10;                                    &lt;select id=&quot;new-prop-datatype&quot;&gt;&#10;                                        &lt;option value=&quot;string&quot;&gt;String&lt;/option&gt;&#10;                                        &lt;option value=&quot;integer&quot;&gt;Integer&lt;/option&gt;&#10;                                        &lt;option value=&quot;decimal&quot;&gt;Decimal&lt;/option&gt;&#10;                                        &lt;option value=&quot;date&quot;&gt;Date&lt;/option&gt;&#10;                                        &lt;option value=&quot;dateTime&quot;&gt;DateTime&lt;/option&gt;&#10;                                        &lt;option value=&quot;boolean&quot;&gt;Boolean&lt;/option&gt;&#10;                                    &lt;/select&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;!-- IRI Value Section (for Object Properties) --&gt;&#10;                        &lt;div id=&quot;iri-value-section&quot; style=&quot;display: none;&quot;&gt;&#10;                            &lt;div class=&quot;iri-builder&quot;&gt;&#10;                                &lt;div class=&quot;iri-mode-selector&quot;&gt;&#10;                                    &lt;label class=&quot;radio-option&quot;&gt;&#10;                                        &lt;input type=&quot;radio&quot; name=&quot;iri-mode&quot; value=&quot;template&quot; checked onchange=&quot;yarrrmlBuilder.onIriModeChange('template')&quot;&gt;&#10;                                        &lt;span&gt;Build IRI from prefix + template&lt;/span&gt;&#10;                                    &lt;/label&gt;&#10;                                    &lt;label class=&quot;radio-option&quot;&gt;&#10;                                        &lt;input type=&quot;radio&quot; name=&quot;iri-mode&quot; value=&quot;column&quot; onchange=&quot;yarrrmlBuilder.onIriModeChange('column')&quot;&gt;&#10;                                        &lt;span&gt;Use column containing full URI&lt;/span&gt;&#10;                                    &lt;/label&gt;&#10;                                &lt;/div&gt;&#10;&#10;                                &lt;div id=&quot;iri-template-section&quot;&gt;&#10;                                    &lt;p class=&quot;form-hint&quot;&gt;Construct an IRI using a prefix and column value(s). Use $(column) syntax.&lt;/p&gt;&#10;&#10;                                    &lt;div class=&quot;form-row&quot;&gt;&#10;                                        &lt;div class=&quot;form-group&quot; style=&quot;flex: 0.5;&quot;&gt;&#10;                                            &lt;label&gt;Prefix&lt;/label&gt;&#10;                                            &lt;select id=&quot;new-prop-iri-prefix&quot; onchange=&quot;yarrrmlBuilder.updateIriPreview()&quot;&gt;&#10;                                                ${Object.keys(this.mapping.prefixes).map(p =&gt;&#10;                                                    `&lt;option value=&quot;${p}&quot;&gt;${p}:&lt;/option&gt;`&#10;                                                ).join('')}&#10;                                            &lt;/select&gt;&#10;                                        &lt;/div&gt;&#10;                                        &lt;div class=&quot;form-group&quot; style=&quot;flex: 1;&quot;&gt;&#10;                                            &lt;label&gt;Local Part (use $(column) for dynamic values)&lt;/label&gt;&#10;                                            &lt;input type=&quot;text&quot; id=&quot;new-prop-iri-local&quot;&#10;                                                   placeholder=&quot;e.g., organization/$(org_id) or theme/$(theme_code)&quot;&#10;                                                   oninput=&quot;yarrrmlBuilder.updateIriPreview()&quot;&gt;&#10;                                        &lt;/div&gt;&#10;                                    &lt;/div&gt;&#10;&#10;                                    &lt;div class=&quot;iri-preview&quot;&gt;&#10;                                        &lt;label&gt;Preview:&lt;/label&gt;&#10;                                        &lt;code id=&quot;iri-preview-value&quot;&gt;ex:resource/$(column)&lt;/code&gt;&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;&#10;                                &lt;div id=&quot;iri-column-section&quot; style=&quot;display: none;&quot;&gt;&#10;                                    &lt;p class=&quot;form-hint&quot;&gt;Select a column that contains the complete URI value.&lt;/p&gt;&#10;                                    &lt;div class=&quot;form-group&quot;&gt;&#10;                                        &lt;label&gt;Column with URI&lt;/label&gt;&#10;                                        &lt;select id=&quot;new-prop-iri-column&quot;&gt;&#10;                                            &lt;option value=&quot;&quot;&gt;Select column...&lt;/option&gt;&#10;                                            ${columnOptions}&#10;                                        &lt;/select&gt;&#10;                                    &lt;/div&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;form-row&quot; style=&quot;margin-top: 15px;&quot;&gt;&#10;                            &lt;div class=&quot;form-group&quot;&gt;&#10;                                &lt;label class=&quot;checkbox-wrapper&quot;&gt;&#10;                                    &lt;input type=&quot;checkbox&quot; id=&quot;new-prop-provenance&quot;&gt;&#10;                                    Track Provenance (adds RDF-star annotations)&#10;                                &lt;/label&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;yarrrmlBuilder.addPropertyFromForm()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z&quot;/&gt;&lt;/svg&gt;&#10;                            Add Property Mapping&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;step-help&quot;&gt;&#10;                    &lt;h4&gt;&#10;                        &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z&quot;/&gt;&lt;/svg&gt;&#10;                        Examples&#10;                    &lt;/h4&gt;&#10;                    &lt;ul&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Data Property:&lt;/strong&gt; &lt;code&gt;dct:title&lt;/code&gt; → &lt;code&gt;$(title_column)&lt;/code&gt; as String&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Object Property (template):&lt;/strong&gt; &lt;code&gt;dct:publisher&lt;/code&gt; → &lt;code&gt;ex:organization/$(org_id)&lt;/code&gt; as IRI&lt;/li&gt;&#10;                        &lt;li&gt;&lt;strong&gt;Object Property (column):&lt;/strong&gt; &lt;code&gt;dcat:theme&lt;/code&gt; → column &lt;code&gt;theme_uri&lt;/code&gt; containing full URI&lt;/li&gt;&#10;                    &lt;/ul&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    onValueTypeChange(valueType) {&#10;        const literalSection = document.getElementById('literal-value-section');&#10;        const iriSection = document.getElementById('iri-value-section');&#10;&#10;        if (valueType === 'iri') {&#10;            literalSection.style.display = 'none';&#10;            iriSection.style.display = 'block';&#10;        } else {&#10;            literalSection.style.display = 'block';&#10;            iriSection.style.display = 'none';&#10;        }&#10;&#10;        this.updateIriPreview();&#10;    }&#10;&#10;    onIriModeChange(mode) {&#10;        const templateSection = document.getElementById('iri-template-section');&#10;        const columnSection = document.getElementById('iri-column-section');&#10;&#10;        if (mode === 'template') {&#10;            templateSection.style.display = 'block';&#10;            columnSection.style.display = 'none';&#10;        } else {&#10;            templateSection.style.display = 'none';&#10;            columnSection.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    updateIriPreview() {&#10;        const prefix = document.getElementById('new-prop-iri-prefix')?.value || 'ex';&#10;        const local = document.getElementById('new-prop-iri-local')?.value || 'resource/$(id)';&#10;        const preview = document.getElementById('iri-preview-value');&#10;&#10;        if (preview) {&#10;            preview.textContent = `${prefix}:${local}`;&#10;        }&#10;    }&#10;&#10;    renderPredicateOptions() {&#10;        if (!this.ontology) return '&lt;div class=&quot;predicate-option disabled&quot;&gt;No ontology loaded&lt;/div&gt;';&#10;&#10;        const allProps = [];&#10;&#10;        // Add data properties&#10;        Object.entries(this.ontology.dataProperties || {}).forEach(([className, props]) =&gt; {&#10;            props.forEach(p =&gt; {&#10;                allProps.push({&#10;                    uri: `${p.prefix}:${p.name}`,&#10;                    label: p.name,&#10;                    prefix: p.prefix,&#10;                    type: p.type,&#10;                    domain: className&#10;                });&#10;            });&#10;        });&#10;&#10;        // Add object properties&#10;        (this.ontology.objectProperties || []).forEach(p =&gt; {&#10;            allProps.push({&#10;                uri: `${p.prefix}:${p.label}`,&#10;                label: p.label,&#10;                prefix: p.prefix,&#10;                type: 'iri',&#10;                domain: p.from&#10;            });&#10;        });&#10;&#10;        if (allProps.length === 0) {&#10;            return '&lt;div class=&quot;predicate-option disabled&quot;&gt;No properties in ontology&lt;/div&gt;';&#10;        }&#10;&#10;        return allProps.map(p =&gt; `&#10;            &lt;div class=&quot;predicate-option&quot; onclick=&quot;yarrrmlBuilder.selectPredicateOption('${p.uri}', '${p.type}')&quot;&gt;&#10;                &lt;span class=&quot;predicate-option-label&quot;&gt;${p.uri}&lt;/span&gt;&#10;                &lt;span class=&quot;predicate-option-meta&quot;&gt;${p.type} ${p.domain ? '(from ' + p.domain + ')' : ''}&lt;/span&gt;&#10;            &lt;/div&gt;&#10;        `).join('');&#10;    }&#10;&#10;    showPredicateDropdown() {&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;        if (dropdown) {&#10;            dropdown.style.display = 'block';&#10;        }&#10;    }&#10;&#10;    filterPredicateOptions(query) {&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;        if (!dropdown) return;&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const allProps = [];&#10;&#10;        // Collect all properties&#10;        Object.entries(this.ontology?.dataProperties || {}).forEach(([className, props]) =&gt; {&#10;            props.forEach(p =&gt; {&#10;                if (p.name.toLowerCase().includes(queryLower) ||&#10;                    p.prefix.toLowerCase().includes(queryLower)) {&#10;                    allProps.push({&#10;                        uri: `${p.prefix}:${p.name}`,&#10;                        label: p.name,&#10;                        prefix: p.prefix,&#10;                        type: p.type,&#10;                        domain: className&#10;                    });&#10;                }&#10;            });&#10;        });&#10;&#10;        (this.ontology?.objectProperties || []).forEach(p =&gt; {&#10;            if (p.label.toLowerCase().includes(queryLower) ||&#10;                p.prefix.toLowerCase().includes(queryLower)) {&#10;                allProps.push({&#10;                    uri: `${p.prefix}:${p.label}`,&#10;                    label: p.label,&#10;                    prefix: p.prefix,&#10;                    type: 'iri',&#10;                    domain: p.from&#10;                });&#10;            }&#10;        });&#10;&#10;        dropdown.innerHTML = allProps.length &gt; 0&#10;            ? allProps.map(p =&gt; `&#10;                &lt;div class=&quot;predicate-option&quot; onclick=&quot;yarrrmlBuilder.selectPredicateOption('${p.uri}', '${p.type}')&quot;&gt;&#10;                    &lt;span class=&quot;predicate-option-label&quot;&gt;${p.uri}&lt;/span&gt;&#10;                    &lt;span class=&quot;predicate-option-meta&quot;&gt;${p.type} ${p.domain ? '(from ' + p.domain + ')' : ''}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            `).join('')&#10;            : `&lt;div class=&quot;predicate-option disabled&quot;&gt;No matching properties&lt;/div&gt;`;&#10;&#10;        dropdown.style.display = 'block';&#10;    }&#10;&#10;    selectPredicateOption(predicateUri, dataType) {&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        const dropdown = document.getElementById('predicate-dropdown');&#10;&#10;        if (predicateInput) predicateInput.value = predicateUri;&#10;&#10;        // Auto-switch between literal and IRI mode based on property type&#10;        if (typeSelect) {&#10;            if (dataType === 'iri') {&#10;                typeSelect.value = 'iri';&#10;                this.onValueTypeChange('iri');&#10;            } else {&#10;                typeSelect.value = 'literal';&#10;                this.onValueTypeChange('literal');&#10;&#10;                // Also set the datatype dropdown&#10;                const datatypeSelect = document.getElementById('new-prop-datatype');&#10;                if (datatypeSelect &amp;&amp; dataType) {&#10;                    datatypeSelect.value = dataType;&#10;                }&#10;            }&#10;        }&#10;&#10;        if (dropdown) dropdown.style.display = 'none';&#10;    }&#10;&#10;    addPropertyFromForm() {&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        const provenanceCheck = document.getElementById('new-prop-provenance');&#10;&#10;        const predicate = predicateInput?.value;&#10;        const valueType = typeSelect?.value || 'literal';&#10;        const trackProvenance = provenanceCheck?.checked || false;&#10;&#10;        if (!predicate) {&#10;            alert('Please specify an RDF predicate');&#10;            return;&#10;        }&#10;&#10;        let valueTemplate = '';&#10;        let dataType = 'string';&#10;        let isIriTemplate = false; // true if it's a prefix:local template&#10;&#10;        if (valueType === 'iri') {&#10;            // Check which IRI mode is selected (template or column)&#10;            const iriModeRadio = document.querySelector('input[name=&quot;iri-mode&quot;]:checked');&#10;            const iriMode = iriModeRadio?.value || 'template';&#10;&#10;            console.log('IRI mode:', iriMode);&#10;&#10;            if (iriMode === 'column') {&#10;                // Use column containing full URI&#10;                const iriColumn = document.getElementById('new-prop-iri-column')?.value;&#10;&#10;                if (!iriColumn) {&#10;                    alert('Please select a column containing the full URI');&#10;                    return;&#10;                }&#10;&#10;                valueTemplate = iriColumn;&#10;                isIriTemplate = false;&#10;                console.log('Using IRI from column:', iriColumn);&#10;            } else {&#10;                // Build from prefix + local template&#10;                const iriPrefix = document.getElementById('new-prop-iri-prefix')?.value || 'ex';&#10;                const iriLocal = document.getElementById('new-prop-iri-local')?.value;&#10;&#10;                console.log('Building IRI template - prefix:', iriPrefix, 'local:', iriLocal);&#10;&#10;                if (!iriLocal) {&#10;                    alert('Please specify the IRI local part (e.g., organization/$(org_id))');&#10;                    return;&#10;                }&#10;&#10;                valueTemplate = `${iriPrefix}:${iriLocal}`;&#10;                isIriTemplate = true;&#10;                console.log('Created IRI template:', valueTemplate);&#10;            }&#10;            dataType = 'iri';&#10;        } else {&#10;            // Get literal value&#10;            const columnSelect = document.getElementById('new-prop-column');&#10;            const columnCustom = document.getElementById('new-prop-column-custom');&#10;            const datatypeSelect = document.getElementById('new-prop-datatype');&#10;&#10;            const column = columnCustom?.value || columnSelect?.value;&#10;            dataType = datatypeSelect?.value || 'string';&#10;&#10;            if (!column) {&#10;                alert('Please specify a source column');&#10;                return;&#10;            }&#10;&#10;            valueTemplate = column;&#10;        }&#10;&#10;        // Add to the table&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            // Remove empty row if present&#10;            const emptyRow = tbody.querySelector('.empty-row');&#10;            if (emptyRow) emptyRow.remove();&#10;&#10;            const newRow = document.createElement('tr');&#10;            newRow.className = 'property-row';&#10;&#10;            // Format display based on type&#10;            let valueDisplay;&#10;            if (valueType === 'iri') {&#10;                if (isIriTemplate) {&#10;                    // Template like ex:organization/$(org_id)&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;${valueTemplate}&lt;/code&gt;`;&#10;                } else {&#10;                    // Column containing URI&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;$(${valueTemplate})&lt;/code&gt;`;&#10;                }&#10;            } else {&#10;                valueDisplay = `&lt;code&gt;$(${valueTemplate})&lt;/code&gt;`;&#10;            }&#10;&#10;            newRow.innerHTML = `&#10;                &lt;td&gt;&lt;code&gt;${predicate}&lt;/code&gt;&lt;/td&gt;&#10;                &lt;td&gt;${valueDisplay}&lt;/td&gt;&#10;                &lt;td&gt;&lt;span class=&quot;type-badge ${dataType}&quot;&gt;${dataType}&lt;/span&gt;&lt;/td&gt;&#10;                &lt;td&gt;${trackProvenance ? '&lt;span class=&quot;prov-badge&quot;&gt;Yes&lt;/span&gt;' : 'No'}&lt;/td&gt;&#10;                &lt;td&gt;&#10;                    &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePropertyRow(this)&quot;&gt;&#10;                        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                    &lt;/button&gt;&#10;                &lt;/td&gt;&#10;            `;&#10;            tbody.appendChild(newRow);&#10;        }&#10;&#10;        // Store in mapping&#10;        const mappingName = document.getElementById('property-mapping-select')?.value;&#10;        if (mappingName &amp;&amp; this.mapping.mappings[mappingName]) {&#10;            if (!this.mapping.mappings[mappingName].properties) {&#10;                this.mapping.mappings[mappingName].properties = [];&#10;            }&#10;            this.mapping.mappings[mappingName].properties.push({&#10;                predicate,&#10;                valueTemplate,&#10;                dataType,&#10;                isIri: valueType === 'iri',&#10;                isIriTemplate: isIriTemplate,&#10;                trackProvenance&#10;            });&#10;        }&#10;&#10;        // Clear form&#10;        this.clearPropertyForm();&#10;    }&#10;&#10;    removePropertyRow(button) {&#10;        const row = button.closest('tr');&#10;        const tbody = document.getElementById('properties-tbody');&#10;        const mappingName = document.getElementById('property-mapping-select')?.value;&#10;&#10;        if (row &amp;&amp; mappingName &amp;&amp; this.mapping.mappings[mappingName]?.properties) {&#10;            const rowIndex = Array.from(tbody.querySelectorAll('tr.property-row')).indexOf(row);&#10;            if (rowIndex &gt;= 0) {&#10;                this.mapping.mappings[mappingName].properties.splice(rowIndex, 1);&#10;            }&#10;        }&#10;&#10;        row?.remove();&#10;&#10;        // Show empty row if no properties left&#10;        if (tbody &amp;&amp; tbody.querySelectorAll('tr.property-row').length === 0) {&#10;            tbody.innerHTML = this.renderPropertyRows();&#10;        }&#10;    }&#10;&#10;    clearPropertyForm() {&#10;        const fields = [&#10;            'new-prop-predicate',&#10;            'new-prop-column',&#10;            'new-prop-column-custom',&#10;            'new-prop-iri-local',&#10;            'new-prop-iri-column'&#10;        ];&#10;&#10;        fields.forEach(id =&gt; {&#10;            const el = document.getElementById(id);&#10;            if (el) el.value = '';&#10;        });&#10;&#10;        const provenanceCheck = document.getElementById('new-prop-provenance');&#10;        if (provenanceCheck) provenanceCheck.checked = false;&#10;&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;        if (typeSelect) typeSelect.value = 'literal';&#10;&#10;        this.onValueTypeChange('literal');&#10;    }&#10;&#10;    renderPropertyRows() {&#10;        // Get current mapping's properties&#10;        const mappingName = Object.keys(this.mapping.mappings)[0];&#10;        const properties = this.mapping.mappings[mappingName]?.properties || [];&#10;&#10;        if (properties.length === 0) {&#10;            return `&#10;                &lt;tr class=&quot;property-row empty-row&quot;&gt;&#10;                    &lt;td colspan=&quot;5&quot; style=&quot;text-align: center; color: var(--text-secondary); padding: 20px;&quot;&gt;&#10;                        No properties mapped yet. Use the form below to add property mappings.&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            `;&#10;        }&#10;&#10;        return properties.map((p, i) =&gt; {&#10;            // Handle both old format (column) and new format (valueTemplate)&#10;            let valueDisplay;&#10;            if (p.isIri || p.dataType === 'iri') {&#10;                if (p.isIriTemplate) {&#10;                    // Template like ex:organization/$(org_id)&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;${p.valueTemplate}&lt;/code&gt;`;&#10;                } else {&#10;                    // Column containing URI&#10;                    valueDisplay = `&lt;code class=&quot;iri-value&quot;&gt;$(${p.valueTemplate || p.column})&lt;/code&gt;`;&#10;                }&#10;            } else {&#10;                valueDisplay = `&lt;code&gt;$(${p.valueTemplate || p.column})&lt;/code&gt;`;&#10;            }&#10;&#10;            return `&#10;                &lt;tr class=&quot;property-row&quot;&gt;&#10;                    &lt;td&gt;&lt;code&gt;${p.predicate}&lt;/code&gt;&lt;/td&gt;&#10;                    &lt;td&gt;${valueDisplay}&lt;/td&gt;&#10;                    &lt;td&gt;&lt;span class=&quot;type-badge ${p.dataType}&quot;&gt;${p.dataType}&lt;/span&gt;&lt;/td&gt;&#10;                    &lt;td&gt;${p.trackProvenance ? '&lt;span class=&quot;prov-badge&quot;&gt;Yes&lt;/span&gt;' : 'No'}&lt;/td&gt;&#10;                    &lt;td&gt;&#10;                        &lt;button class=&quot;btn-icon&quot; onclick=&quot;yarrrmlBuilder.removePropertyMapping('${mappingName}', ${i})&quot;&gt;&#10;                            &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z&quot;/&gt;&lt;/svg&gt;&#10;                        &lt;/button&gt;&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            `;&#10;        }).join('');&#10;    }&#10;&#10;    removePropertyMapping(mappingName, index) {&#10;        if (this.mapping.mappings[mappingName]?.properties) {&#10;            this.mapping.mappings[mappingName].properties.splice(index, 1);&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    onMappingChange(mappingName) {&#10;        // Re-render property rows for selected mapping&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            const properties = this.mapping.mappings[mappingName]?.properties || [];&#10;            tbody.innerHTML = this.renderPropertyRows();&#10;        }&#10;    }&#10;&#10;    renderReviewStep() {&#10;        const yaml = this.generateYARRRML();&#10;&#10;        return `&#10;            &lt;div class=&quot;step-content&quot;&gt;&#10;                &lt;h2&gt;Step 5: Review &amp; Export&lt;/h2&gt;&#10;&#10;                &lt;div class=&quot;yaml-preview&quot;&gt;&#10;                    &lt;div class=&quot;yaml-header&quot;&gt;&#10;                        &lt;span&gt;Generated YARRRML&lt;/span&gt;&#10;                        &lt;div&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.copyYAML()&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z&quot;/&gt;&lt;/svg&gt;&#10;                                Copy&#10;                            &lt;/button&gt;&#10;                            &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.downloadYAML()&quot;&gt;&#10;                                &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z&quot;/&gt;&lt;/svg&gt;&#10;                                Download&#10;                            &lt;/button&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;pre id=&quot;yaml-output&quot;&gt;${this.escapeHtml(yaml)}&lt;/pre&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Sample Triple Preview --&gt;&#10;                &lt;div class=&quot;triple-preview&quot;&gt;&#10;                    &lt;div class=&quot;triple-preview-header&quot;&gt;&#10;                        &lt;h4&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z&quot;/&gt;&lt;/svg&gt;&#10;                            Sample Output Preview&#10;                        &lt;/h4&gt;&#10;                        &lt;span class=&quot;preview-note&quot;&gt;Example triples from mapping&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;pre class=&quot;triple-output&quot;&gt;${this.generateSampleTriples()}&lt;/pre&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;validation-results&quot;&gt;&#10;                    ${this.validateMapping()}&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Export Options --&gt;&#10;                &lt;div class=&quot;export-options&quot;&gt;&#10;                    &lt;h4&gt;Export Options&lt;/h4&gt;&#10;                    &lt;div class=&quot;export-buttons&quot;&gt;&#10;                        &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;yarrrmlBuilder.downloadYAML()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z&quot;/&gt;&lt;/svg&gt;&#10;                            Download YARRRML&#10;                        &lt;/button&gt;&#10;                        &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;yarrrmlBuilder.exportAsJSON()&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z&quot;/&gt;&lt;/svg&gt;&#10;                            Export Session&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    generateSampleTriples() {&#10;        // Generate dynamic sample based on actual mapping configuration&#10;        let output = `# Sample RDF Output (Turtle format)&#10;# Generated from your mapping configuration&#10;&#10;`;&#10;&#10;        // Add prefixes&#10;        for (const [prefix, uri] of Object.entries(this.mapping.prefixes)) {&#10;            output += `@prefix ${prefix}: &lt;${uri}&gt; .\n`;&#10;        }&#10;        output += `\n`;&#10;&#10;        // Check if we have mappings&#10;        const mappings = Object.entries(this.mapping.mappings);&#10;        if (mappings.length === 0) {&#10;            output += `# No mappings defined yet.\n`;&#10;            output += `# Complete Steps 1-4 to see a preview.\n`;&#10;            return output;&#10;        }&#10;&#10;        // Generate sample triples for each mapping&#10;        for (const [name, config] of mappings) {&#10;            output += `# Mapping: ${name}\n`;&#10;&#10;            // Sample subject - replace $(column) with sample value&#10;            const sampleSubject = config.subject&#10;                ? config.subject.replace(/\$\(([^)]+)\)/g, 'sample_$1')&#10;                : 'ex:resource/1';&#10;&#10;            output += `${sampleSubject} a ${config.class || 'ex:Thing'} `;&#10;&#10;            // Add properties&#10;            if (config.properties &amp;&amp; config.properties.length &gt; 0) {&#10;                output += `;\n`;&#10;                config.properties.forEach((prop, i) =&gt; {&#10;                    const sampleValue = prop.dataType === 'integer' ? '42' :&#10;                                       prop.dataType === 'decimal' ? '3.14' :&#10;                                       prop.dataType === 'date' ? '&quot;2026-02-17&quot;' :&#10;                                       prop.dataType === 'dateTime' ? '&quot;2026-02-17T10:00:00Z&quot;' :&#10;                                       prop.dataType === 'boolean' ? 'true' :&#10;                                       prop.dataType === 'iri' ? `ex:ref_${prop.column}` :&#10;                                       `&quot;Sample ${prop.column}&quot;`;&#10;&#10;                    const ending = i === config.properties.length - 1 ? ' .' : ' ;';&#10;                    output += `    ${prop.predicate} ${sampleValue}${ending}\n`;&#10;                });&#10;&#10;                // Show RDF-star provenance for properties that track it&#10;                const provenanceProps = config.properties.filter(p =&gt; p.trackProvenance);&#10;                if (provenanceProps.length &gt; 0) {&#10;                    output += `\n# RDF-star Provenance Annotations:\n`;&#10;                    provenanceProps.forEach(prop =&gt; {&#10;                        const sampleValue = prop.dataType === 'integer' ? '42' : `&quot;Sample ${prop.column}&quot;`;&#10;                        output += `&lt;&lt;${sampleSubject} ${prop.predicate} ${sampleValue}&gt;&gt;\n`;&#10;                        output += `    prov:wasDerivedFrom ex:source/system ;\n`;&#10;                        output += `    prov:generatedAtTime &quot;2026-02-17T10:00:00Z&quot;^^xsd:dateTime .\n\n`;&#10;                    });&#10;                }&#10;            } else {&#10;                output += `.\n`;&#10;                output += `# No properties mapped yet. Add properties in Step 4.\n`;&#10;            }&#10;&#10;            output += `\n`;&#10;        }&#10;&#10;        return output;&#10;    }&#10;&#10;    exportAsJSON() {&#10;        const session = {&#10;            version: '1.0',&#10;            created: new Date().toISOString(),&#10;            mapping: this.mapping,&#10;            detectedColumns: this.detectedColumns || []&#10;        };&#10;&#10;        const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });&#10;        const url = URL.createObjectURL(blob);&#10;        const a = document.createElement('a');&#10;        a.href = url;&#10;        a.download = 'yarrrml-session.json';&#10;        a.click();&#10;        URL.revokeObjectURL(url);&#10;    }&#10;&#10;    generateYARRRML() {&#10;        let yaml = `# YARRRML Mapping&#10;# Generated: ${new Date().toISOString()}&#10;&#10;prefixes:\n`;&#10;&#10;        for (const [prefix, uri] of Object.entries(this.mapping.prefixes)) {&#10;            yaml += `  ${prefix}: &quot;${uri}&quot;\n`;&#10;        }&#10;&#10;        yaml += `\nsources:\n`;&#10;&#10;        if (Object.keys(this.mapping.sources).length === 0) {&#10;            yaml += `  # No sources defined yet\n`;&#10;        } else {&#10;            for (const [name, config] of Object.entries(this.mapping.sources)) {&#10;                yaml += `  ${name}:\n`;&#10;                yaml += `    access: &quot;${config.access}&quot;\n`;&#10;                yaml += `    referenceFormulation: ${config.type || 'csv'}\n`;&#10;            }&#10;        }&#10;&#10;        yaml += `\nmappings:\n`;&#10;&#10;        if (Object.keys(this.mapping.mappings).length === 0) {&#10;            yaml += `  # No mappings defined yet\n`;&#10;        } else {&#10;            for (const [name, config] of Object.entries(this.mapping.mappings)) {&#10;                yaml += `  ${name}:\n`;&#10;                yaml += `    sources: ${config.source}\n`;&#10;                yaml += `    subject: ${config.subject}\n`;&#10;                yaml += `    predicateobjects:\n`;&#10;&#10;                // Add rdf:type&#10;                yaml += `      - predicates: rdf:type\n`;&#10;                yaml += `        objects:\n`;&#10;                yaml += `          value: ${config.class}\n`;&#10;                yaml += `          type: iri\n`;&#10;&#10;                // Add property mappings&#10;                if (config.properties &amp;&amp; config.properties.length &gt; 0) {&#10;                    for (const prop of config.properties) {&#10;                        yaml += `\n      - predicates: ${prop.predicate}\n`;&#10;                        yaml += `        objects:\n`;&#10;&#10;                        // Handle IRI vs literal values&#10;                        if (prop.isIri || prop.dataType === 'iri') {&#10;                            if (prop.isIriTemplate) {&#10;                                // It's a prefixed IRI template like ex:organization/$(org_id)&#10;                                yaml += `          value: ${prop.valueTemplate}\n`;&#10;                            } else {&#10;                                // It's a column containing full URI&#10;                                yaml += `          value: &quot;$(${prop.valueTemplate})&quot;\n`;&#10;                            }&#10;                            yaml += `          type: iri\n`;&#10;                        } else {&#10;                            // Literal value&#10;                            const column = prop.valueTemplate || prop.column;&#10;                            yaml += `          value: &quot;$(${column})&quot;\n`;&#10;&#10;                            // Add datatype for non-string literals&#10;                            if (prop.dataType &amp;&amp; prop.dataType !== 'string') {&#10;                                yaml += `          datatype: xsd:${prop.dataType}\n`;&#10;                            }&#10;                        }&#10;&#10;                        // Add provenance annotations if enabled&#10;                        if (prop.trackProvenance) {&#10;                            yaml += `        annotations:\n`;&#10;                            yaml += `          - predicates: prov:wasDerivedFrom\n`;&#10;                            yaml += `            objects:\n`;&#10;                            yaml += `              value: &quot;$(source_system)&quot;\n`;&#10;                            yaml += `              type: iri\n`;&#10;                            yaml += `          - predicates: prov:generatedAtTime\n`;&#10;                            yaml += `            objects:\n`;&#10;                            yaml += `              value: &quot;$(timestamp)&quot;\n`;&#10;                            yaml += `              datatype: xsd:dateTime\n`;&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        return yaml;&#10;    }&#10;&#10;    validateMapping() {&#10;        const issues = [];&#10;        const warnings = [];&#10;&#10;        if (Object.keys(this.mapping.sources).length === 0) {&#10;            warnings.push('No data sources defined');&#10;        }&#10;&#10;        if (Object.keys(this.mapping.mappings).length === 0) {&#10;            warnings.push('No class mappings defined');&#10;        }&#10;&#10;        return `&#10;            &lt;div class=&quot;validation-summary ${issues.length &gt; 0 ? 'has-errors' : 'valid'}&quot;&gt;&#10;                &lt;h4&gt;&#10;                    ${issues.length &gt; 0&#10;                        ? '&lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z&quot;/&gt;&lt;/svg&gt; Issues Found'&#10;                        : '&lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z&quot;/&gt;&lt;/svg&gt; Ready'&#10;                    }&#10;                &lt;/h4&gt;&#10;                ${warnings.length &gt; 0 ? `&#10;                    &lt;ul class=&quot;warning-list&quot;&gt;&#10;                        ${warnings.map(w =&gt; `&lt;li class=&quot;warning&quot;&gt;${w}&lt;/li&gt;`).join('')}&#10;                    &lt;/ul&gt;&#10;                ` : ''}&#10;                &lt;p class=&quot;validation-note&quot;&gt;&#10;                    Configure your mapping using the steps above.&#10;                &lt;/p&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    // ==========================================&#10;    // ONTOLOGY BROWSER&#10;    // ==========================================&#10;&#10;    buildSearchIndex() {&#10;        this.ontologyIndex.clear();&#10;&#10;        if (!this.ontology) return;&#10;&#10;        // Index classes&#10;        this.ontology.classes.forEach(cls =&gt; {&#10;            const terms = [&#10;                cls.label.toLowerCase(),&#10;                cls.id.toLowerCase(),&#10;                cls.prefix.toLowerCase(),&#10;                (cls.prefix + ':' + cls.label).toLowerCase()&#10;            ];&#10;&#10;            terms.forEach(term =&gt; {&#10;                if (!this.ontologyIndex.has(term)) {&#10;                    this.ontologyIndex.set(term, []);&#10;                }&#10;                this.ontologyIndex.get(term).push({ type: 'class', data: cls });&#10;            });&#10;        });&#10;&#10;        // Index data properties&#10;        Object.entries(this.ontology.dataProperties).forEach(([className, props]) =&gt; {&#10;            props.forEach(prop =&gt; {&#10;                const terms = [&#10;                    prop.name.toLowerCase(),&#10;                    (prop.prefix + ':' + prop.name).toLowerCase()&#10;                ];&#10;&#10;                terms.forEach(term =&gt; {&#10;                    if (!this.ontologyIndex.has(term)) {&#10;                        this.ontologyIndex.set(term, []);&#10;                    }&#10;                    this.ontologyIndex.get(term).push({ type: 'property', data: prop, className });&#10;                });&#10;            });&#10;        });&#10;&#10;        // Index object properties&#10;        this.ontology.objectProperties.forEach(rel =&gt; {&#10;            const term = rel.label.toLowerCase();&#10;            if (!this.ontologyIndex.has(term)) {&#10;                this.ontologyIndex.set(term, []);&#10;            }&#10;            this.ontologyIndex.get(term).push({ type: 'relationship', data: rel });&#10;        });&#10;    }&#10;&#10;    searchOntology(query) {&#10;        const resultsDiv = document.getElementById('search-results');&#10;&#10;        if (!query || query.length &lt; 2) {&#10;            resultsDiv.innerHTML = '';&#10;            resultsDiv.style.display = 'none';&#10;            return;&#10;        }&#10;&#10;        const queryLower = query.toLowerCase();&#10;        const results = [];&#10;&#10;        this.ontologyIndex.forEach((items, term) =&gt; {&#10;            if (term.includes(queryLower)) {&#10;                items.forEach(item =&gt; {&#10;                    if (!results.find(r =&gt; r.type === item.type &amp;&amp;&#10;                        (item.type === 'class' ? r.data.id === item.data.id :&#10;                         item.type === 'property' ? r.data.name === item.data.name : false))) {&#10;                        results.push(item);&#10;                    }&#10;                });&#10;            }&#10;        });&#10;&#10;        const limited = results.slice(0, 10);&#10;&#10;        if (limited.length === 0) {&#10;            resultsDiv.innerHTML = '&lt;div class=&quot;search-no-results&quot;&gt;No results found&lt;/div&gt;';&#10;        } else {&#10;            resultsDiv.innerHTML = limited.map(result =&gt; {&#10;                if (result.type === 'class') {&#10;                    const escapedId = result.data.id.replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item class&quot; onclick=&quot;yarrrmlBuilder.focusOnClass('${escapedId}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 2l-5.5 9h11z M17.5 13h-11l5.5 9z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.prefix}:${result.data.label}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;Class&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                } else if (result.type === 'property') {&#10;                    const escapedClassName = result.className.replace(/'/g, &quot;\\'&quot;);&#10;                    const escapedName = result.data.name.replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item property&quot; onclick=&quot;yarrrmlBuilder.showPropertyInContext('${escapedClassName}', '${escapedName}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.prefix}:${result.data.name}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;Property of ${result.className}&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                } else {&#10;                    const escapedFrom = (result.data.from || '').replace(/'/g, &quot;\\'&quot;);&#10;                    const escapedTo = (result.data.to || '').replace(/'/g, &quot;\\'&quot;);&#10;                    return `&#10;                        &lt;div class=&quot;search-result-item relationship&quot; onclick=&quot;yarrrmlBuilder.showRelationship('${escapedFrom}', '${escapedTo}')&quot;&gt;&#10;                            &lt;svg width=&quot;14&quot; height=&quot;14&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z&quot;/&gt;&lt;/svg&gt;&#10;                            &lt;span class=&quot;result-label&quot;&gt;${result.data.label}&lt;/span&gt;&#10;                            &lt;span class=&quot;result-type&quot;&gt;${result.data.from || ''} → ${result.data.to || ''}&lt;/span&gt;&#10;                        &lt;/div&gt;&#10;                    `;&#10;                }&#10;            }).join('');&#10;        }&#10;&#10;        resultsDiv.style.display = 'block';&#10;    }&#10;&#10;    focusOnClass(classId) {&#10;        console.log('focusOnClass called with:', classId);&#10;&#10;        if (!this.ontology || !this.ontology.classes) {&#10;            console.warn('Ontology not loaded yet');&#10;            return;&#10;        }&#10;&#10;        // Validate classId exists in ontology&#10;        const classExists = this.ontology.classes.find(c =&gt; c.id === classId);&#10;        if (!classExists) {&#10;            console.warn(`Class '${classId}' not found in ontology, showing all classes`);&#10;            this.expandAll();&#10;            return;&#10;        }&#10;&#10;        const searchInput = document.getElementById('ontology-search');&#10;        const resultsDiv = document.getElementById('search-results');&#10;        if (searchInput) searchInput.value = '';&#10;        if (resultsDiv) resultsDiv.style.display = 'none';&#10;&#10;        this.visibleClasses.clear();&#10;        this.visibleClasses.add(classId);&#10;&#10;        // Add valid neighbors&#10;        const neighbors = this.getNeighbors(classId);&#10;        neighbors.forEach(id =&gt; {&#10;            if (this.ontology.classes.some(c =&gt; c.id === id)) {&#10;                this.visibleClasses.add(id);&#10;            }&#10;        });&#10;&#10;        console.log('Visible classes after focus:', Array.from(this.visibleClasses));&#10;&#10;        this.renderOntologyGraph();&#10;&#10;        this.selectOntologyClass(classExists);&#10;    }&#10;&#10;    showPropertyInContext(className, propertyName) {&#10;        this.focusOnClass(className);&#10;    }&#10;&#10;    showRelationship(fromClass, toClass) {&#10;        this.visibleClasses.clear();&#10;        this.visibleClasses.add(fromClass);&#10;        this.visibleClasses.add(toClass);&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    getNeighbors(classId) {&#10;        const neighbors = new Set();&#10;&#10;        if (!this.ontology) return neighbors;&#10;&#10;        const cls = this.ontology.classes.find(c =&gt; c.id === classId);&#10;        if (cls?.parent) {&#10;            neighbors.add(cls.parent);&#10;        }&#10;&#10;        // Find child classes&#10;        this.ontology.classes&#10;            .filter(c =&gt; c.parent === classId)&#10;            .forEach(c =&gt; neighbors.add(c.id));&#10;&#10;        // Find connected classes via object properties&#10;        if (this.ontology.objectProperties) {&#10;            this.ontology.objectProperties.forEach(rel =&gt; {&#10;                if (rel.from &amp;&amp; rel.from === classId &amp;&amp; rel.to) {&#10;                    neighbors.add(rel.to);&#10;                }&#10;                if (rel.to &amp;&amp; rel.to === classId &amp;&amp; rel.from) {&#10;                    neighbors.add(rel.from);&#10;                }&#10;            });&#10;        }&#10;&#10;        return neighbors;&#10;    }&#10;&#10;    expandClass(classId) {&#10;        console.log('expandClass called with:', classId);&#10;        console.log('Current visible classes:', Array.from(this.visibleClasses));&#10;&#10;        this.visibleClasses.add(classId);&#10;        const neighbors = this.getNeighbors(classId);&#10;        console.log('Neighbors found:', Array.from(neighbors));&#10;&#10;        // Only add neighbors that actually exist in the ontology&#10;        neighbors.forEach(id =&gt; {&#10;            const exists = this.ontology.classes.some(c =&gt; c.id === id);&#10;            if (exists) {&#10;                this.visibleClasses.add(id);&#10;            } else {&#10;                console.warn(`Neighbor '${id}' not found in ontology classes`);&#10;            }&#10;        });&#10;&#10;        console.log('Visible classes after expand:', Array.from(this.visibleClasses));&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    hideClass(classId) {&#10;        this.visibleClasses.delete(classId);&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    resetOntologyView() {&#10;        if (this.ontology &amp;&amp; this.ontology.classes.length &gt; 0) {&#10;            // Show all classes initially for real ontology&#10;            this.visibleClasses.clear();&#10;            this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;            this.renderOntologyGraph();&#10;        }&#10;    }&#10;&#10;    expandAll() {&#10;        this.visibleClasses.clear();&#10;        this.ontology.classes.forEach(c =&gt; this.visibleClasses.add(c.id));&#10;        console.log('expandAll - visible classes:', Array.from(this.visibleClasses));&#10;        this.renderOntologyGraph();&#10;    }&#10;&#10;    initOntologyGraph() {&#10;        const container = document.getElementById('ontology-graph');&#10;        if (!container) {&#10;            console.warn('Ontology graph container not found');&#10;            return;&#10;        }&#10;&#10;        // Get actual computed size&#10;        const rect = container.getBoundingClientRect();&#10;        const width = rect.width || 400;&#10;        const height = rect.height || 250;&#10;&#10;        console.log(`Initializing ontology graph: ${width}x${height}`);&#10;&#10;        const svg = d3.select('#ontology-canvas')&#10;            .attr('width', width)&#10;            .attr('height', height);&#10;&#10;        // Clear any existing content&#10;        svg.selectAll('*').remove();&#10;&#10;        const zoom = d3.zoom()&#10;            .scaleExtent([0.3, 3])&#10;            .on('zoom', (event) =&gt; {&#10;                svg.select('g.ontology-content').attr('transform', event.transform);&#10;            });&#10;&#10;        svg.call(zoom);&#10;        svg.append('g').attr('class', 'ontology-content');&#10;&#10;        svg.append('defs').append('marker')&#10;            .attr('id', 'ont-arrow')&#10;            .attr('viewBox', '-0 -5 10 10')&#10;            .attr('refX', 20)&#10;            .attr('refY', 0)&#10;            .attr('orient', 'auto')&#10;            .attr('markerWidth', 6)&#10;            .attr('markerHeight', 6)&#10;            .append('path')&#10;            .attr('d', 'M 0,-5 L 10,0 L 0,5')&#10;            .attr('fill', '#7c7c9c');&#10;    }&#10;&#10;    renderOntologyGraph() {&#10;        const svg = d3.select('#ontology-canvas');&#10;        let g = svg.select('g.ontology-content');&#10;&#10;        if (!g.node()) {&#10;            console.warn('SVG group not found, reinitializing graph');&#10;            this.initOntologyGraph();&#10;            g = d3.select('#ontology-canvas').select('g.ontology-content');&#10;            if (!g.node()) {&#10;                console.error('Failed to create SVG group');&#10;                return;&#10;            }&#10;        }&#10;&#10;        // Ensure arrow marker exists&#10;        if (!svg.select('#ont-arrow').node()) {&#10;            svg.append('defs').append('marker')&#10;                .attr('id', 'ont-arrow')&#10;                .attr('viewBox', '-0 -5 10 10')&#10;                .attr('refX', 20)&#10;                .attr('refY', 0)&#10;                .attr('orient', 'auto')&#10;                .attr('markerWidth', 6)&#10;                .attr('markerHeight', 6)&#10;                .append('path')&#10;                .attr('d', 'M 0,-5 L 10,0 L 0,5')&#10;                .attr('fill', '#7c7c9c');&#10;        }&#10;&#10;        g.selectAll('*').remove();&#10;&#10;        if (!this.ontology || this.ontology.classes.length === 0) {&#10;            console.log('No ontology classes to render');&#10;            return;&#10;        }&#10;&#10;        const width = parseInt(svg.attr('width')) || 400;&#10;        const height = parseInt(svg.attr('height')) || 250;&#10;&#10;        const visibleClassIds = Array.from(this.visibleClasses);&#10;        console.log(`Rendering ${visibleClassIds.length} visible classes out of ${this.ontology.classes.length} total`);&#10;&#10;        if (visibleClassIds.length === 0) {&#10;            console.log('No visible classes - showing first class');&#10;            if (this.ontology.classes.length &gt; 0) {&#10;                this.visibleClasses.add(this.ontology.classes[0].id);&#10;                return this.renderOntologyGraph();&#10;            }&#10;            return;&#10;        }&#10;&#10;        const nodes = this.ontology.classes&#10;            .filter(c =&gt; visibleClassIds.includes(c.id))&#10;            .map(c =&gt; ({...c}));&#10;&#10;        const links = [];&#10;&#10;        // Add object property links (check for null/undefined)&#10;        if (this.ontology.objectProperties &amp;&amp; Array.isArray(this.ontology.objectProperties)) {&#10;            this.ontology.objectProperties.forEach(rel =&gt; {&#10;                if (rel &amp;&amp; rel.from &amp;&amp; rel.to &amp;&amp;&#10;                    visibleClassIds.includes(rel.from) &amp;&amp; visibleClassIds.includes(rel.to)) {&#10;                    links.push({&#10;                        source: rel.from,&#10;                        target: rel.to,&#10;                        label: rel.label || 'relatedTo',&#10;                        type: 'object'&#10;                    });&#10;                }&#10;            });&#10;        }&#10;&#10;        // Add inheritance links&#10;        nodes.forEach(node =&gt; {&#10;            if (node.parent &amp;&amp; visibleClassIds.includes(node.parent)) {&#10;                links.push({&#10;                    source: node.id,&#10;                    target: node.parent,&#10;                    label: 'subClassOf',&#10;                    type: 'inheritance'&#10;                });&#10;            }&#10;        });&#10;&#10;        console.log(`Rendering graph with ${nodes.length} nodes and ${links.length} links at ${width}x${height}`);&#10;&#10;        if (nodes.length === 0) {&#10;            console.warn('No nodes to render');&#10;            return;&#10;        }&#10;&#10;        // Adjust force simulation based on number of nodes&#10;        const nodeCount = nodes.length;&#10;        const linkDistance = nodeCount &lt;= 3 ? 100 : nodeCount &lt;= 6 ? 80 : 60;&#10;        const chargeStrength = nodeCount &lt;= 3 ? -200 : nodeCount &lt;= 6 ? -150 : -100;&#10;&#10;        const simulation = d3.forceSimulation(nodes)&#10;            .force('link', d3.forceLink(links).id(d =&gt; d.id).distance(linkDistance))&#10;            .force('charge', d3.forceManyBody().strength(chargeStrength))&#10;            .force('center', d3.forceCenter(width / 2, height / 2))&#10;            .force('collision', d3.forceCollide().radius(55))&#10;            .force('x', d3.forceX(width / 2).strength(0.1))&#10;            .force('y', d3.forceY(height / 2).strength(0.1))&#10;            .alphaDecay(0.05); // Faster stabilization&#10;&#10;        // Stop simulation after stabilizing&#10;        simulation.on('end', () =&gt; {&#10;            console.log('Simulation stabilized');&#10;        });&#10;&#10;        const link = g.append('g')&#10;            .selectAll('line')&#10;            .data(links)&#10;            .enter()&#10;            .append('line')&#10;            .attr('stroke', d =&gt; d.type === 'inheritance' ? '#9c27b0' : '#7c7c9c')&#10;            .attr('stroke-width', d =&gt; d.type === 'inheritance' ? 2 : 1.5)&#10;            .attr('stroke-dasharray', d =&gt; d.type === 'inheritance' ? '5,3' : 'none')&#10;            .attr('marker-end', 'url(#ont-arrow)');&#10;&#10;        const linkLabel = g.append('g')&#10;            .selectAll('text')&#10;            .data(links)&#10;            .enter()&#10;            .append('text')&#10;            .attr('font-size', 9)&#10;            .attr('fill', '#9e9e9e')&#10;            .attr('text-anchor', 'middle')&#10;            .text(d =&gt; d.label);&#10;&#10;        const node = g.append('g')&#10;            .selectAll('g')&#10;            .data(nodes)&#10;            .enter()&#10;            .append('g')&#10;            .style('cursor', 'pointer')&#10;            .call(d3.drag()&#10;                .on('start', (event, d) =&gt; {&#10;                    if (!event.active) simulation.alphaTarget(0.3).restart();&#10;                    d.fx = d.x;&#10;                    d.fy = d.y;&#10;                })&#10;                .on('drag', (event, d) =&gt; {&#10;                    d.fx = event.x;&#10;                    d.fy = event.y;&#10;                })&#10;                .on('end', (event, d) =&gt; {&#10;                    if (!event.active) simulation.alphaTarget(0);&#10;                    // Keep the node fixed where it was dropped&#10;                    // d.fx = null; d.fy = null; // Don't release - keeps graph stable&#10;                }))&#10;            .on('click', (event, d) =&gt; {&#10;                event.stopPropagation();&#10;                // Don't restart simulation on click&#10;                this.selectOntologyClass(d);&#10;            })&#10;            .on('contextmenu', (event, d) =&gt; {&#10;                event.preventDefault();&#10;                this.showContextMenu(event, d);&#10;            });&#10;&#10;        node.append('rect')&#10;            .attr('width', 90)&#10;            .attr('height', 32)&#10;            .attr('x', -45)&#10;            .attr('y', -16)&#10;            .attr('rx', 5)&#10;            .attr('fill', d =&gt; this.getClassColor(d))&#10;            .attr('stroke', '#fff')&#10;            .attr('stroke-width', 2);&#10;&#10;        node.append('text')&#10;            .attr('text-anchor', 'middle')&#10;            .attr('dy', 4)&#10;            .attr('fill', '#fff')&#10;            .attr('font-size', 10)&#10;            .attr('font-weight', 'bold')&#10;            .text(d =&gt; d.label.length &gt; 12 ? d.label.substring(0, 10) + '...' : d.label);&#10;&#10;        simulation.on('tick', () =&gt; {&#10;            link&#10;                .attr('x1', d =&gt; d.source.x)&#10;                .attr('y1', d =&gt; d.source.y)&#10;                .attr('x2', d =&gt; d.target.x)&#10;                .attr('y2', d =&gt; d.target.y);&#10;&#10;            linkLabel&#10;                .attr('x', d =&gt; (d.source.x + d.target.x) / 2)&#10;                .attr('y', d =&gt; (d.source.y + d.target.y) / 2 - 5);&#10;&#10;            node.attr('transform', d =&gt; `translate(${d.x},${d.y})`);&#10;        });&#10;    }&#10;&#10;    getClassColor(cls) {&#10;        const colors = {&#10;            'owl': '#9c27b0',&#10;            'schema': '#2196f3',&#10;            'foaf': '#4caf50',&#10;            'prov': '#ff9800',&#10;            'ex': '#00bcd4',&#10;            'dcat': '#e91e63',&#10;            'dct': '#795548'&#10;        };&#10;        return colors[cls.prefix] || '#607d8b';&#10;    }&#10;&#10;    // Context Menu&#10;    bindContextMenu() {&#10;        document.addEventListener('click', () =&gt; {&#10;            const menu = document.getElementById('context-menu');&#10;            if (menu) menu.style.display = 'none';&#10;        });&#10;    }&#10;&#10;    showContextMenu(event, classData) {&#10;        this.contextMenuTarget = classData;&#10;        const menu = document.getElementById('context-menu');&#10;&#10;        menu.style.left = event.pageX + 'px';&#10;        menu.style.top = event.pageY + 'px';&#10;        menu.style.display = 'block';&#10;&#10;        menu.querySelectorAll('.context-menu-item').forEach(item =&gt; {&#10;            item.onclick = (e) =&gt; {&#10;                e.stopPropagation();&#10;                const action = item.dataset.action;&#10;                this.handleContextMenuAction(action);&#10;                menu.style.display = 'none';&#10;            };&#10;        });&#10;    }&#10;&#10;    handleContextMenuAction(action) {&#10;        const cls = this.contextMenuTarget;&#10;        if (!cls) return;&#10;&#10;        switch(action) {&#10;            case 'expand':&#10;                this.expandClass(cls.id);&#10;                break;&#10;            case 'focus':&#10;                this.focusOnClass(cls.id);&#10;                break;&#10;            case 'hide':&#10;                this.hideClass(cls.id);&#10;                break;&#10;            case 'use-mapping':&#10;                this.useClassForMapping(`${cls.prefix}:${cls.label}`);&#10;                break;&#10;        }&#10;    }&#10;&#10;    selectOntologyClass(classData) {&#10;        this.selectedClass = classData;&#10;        const details = document.getElementById('ontology-details');&#10;&#10;        const allProps = this.getAllPropertiesForClass(classData.id);&#10;        const neighbors = this.getNeighbors(classData.id);&#10;&#10;        details.innerHTML = `&#10;            &lt;div class=&quot;class-details&quot;&gt;&#10;                &lt;div class=&quot;class-header-detail&quot;&gt;&#10;                    &lt;span class=&quot;class-badge&quot; style=&quot;background: ${this.getClassColor(classData)}&quot;&gt;${classData.prefix}:${classData.label}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;p class=&quot;class-uri&quot;&gt;${classData.uri || ''}&lt;/p&gt;&#10;                ${classData.comment ? `&lt;p class=&quot;class-comment&quot;&gt;${classData.comment}&lt;/p&gt;` : ''}&#10;&#10;                ${classData.parent ? `&lt;p class=&quot;class-parent&quot;&gt;Extends: &lt;strong&gt;${classData.parent}&lt;/strong&gt;&lt;/p&gt;` : ''}&#10;&#10;                &lt;h5&gt;Data Properties (${allProps.length})&lt;/h5&gt;&#10;                &lt;ul class=&quot;property-list&quot;&gt;&#10;                    ${allProps.length &gt; 0 ? allProps.map(p =&gt; `&#10;                        &lt;li class=&quot;property-item-small&quot; onclick=&quot;yarrrmlBuilder.useProperty('${p.prefix}:${p.name}', '${p.type}')&quot;&gt;&#10;                            &lt;span class=&quot;prop-name&quot;&gt;${p.prefix}:${p.name}&lt;/span&gt;&#10;                            &lt;span class=&quot;prop-type&quot;&gt;${p.type}&lt;/span&gt;&#10;                        &lt;/li&gt;&#10;                    `).join('') : '&lt;li class=&quot;no-props&quot;&gt;No data properties defined&lt;/li&gt;'}&#10;                &lt;/ul&gt;&#10;&#10;                &lt;h5&gt;Relationships&lt;/h5&gt;&#10;                &lt;ul class=&quot;relationship-list&quot;&gt;&#10;                    ${this.ontology.objectProperties&#10;                        .filter(r =&gt; r.from === classData.id || r.to === classData.id)&#10;                        .map(r =&gt; `&#10;                            &lt;li class=&quot;rel-item&quot; onclick=&quot;yarrrmlBuilder.showRelationship('${r.from}', '${r.to}')&quot;&gt;&#10;                                ${r.from === classData.id&#10;                                    ? `&lt;span class=&quot;rel-arrow&quot;&gt;→&lt;/span&gt; &lt;strong&gt;${r.label}&lt;/strong&gt; → ${r.to}`&#10;                                    : `${r.from} → &lt;strong&gt;${r.label}&lt;/strong&gt; &lt;span class=&quot;rel-arrow&quot;&gt;→&lt;/span&gt;`&#10;                                }&#10;                            &lt;/li&gt;&#10;                        `).join('') || '&lt;li class=&quot;no-rels&quot;&gt;No relationships defined&lt;/li&gt;'}&#10;                &lt;/ul&gt;&#10;&#10;                &lt;div class=&quot;class-actions&quot;&gt;&#10;                    &lt;button class=&quot;btn btn-small btn-primary&quot; onclick=&quot;yarrrmlBuilder.useClassForMapping('${classData.prefix}:${classData.label}')&quot;&gt;&#10;                        Use in Mapping&#10;                    &lt;/button&gt;&#10;                    &lt;button class=&quot;btn btn-small&quot; onclick=&quot;yarrrmlBuilder.expandClass('${classData.id}')&quot;&gt;&#10;                        Expand Neighbors&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        `;&#10;    }&#10;&#10;    getAllPropertiesForClass(classId) {&#10;        const props = [];&#10;        const visited = new Set();&#10;&#10;        const collectProps = (id) =&gt; {&#10;            if (visited.has(id)) return;&#10;            visited.add(id);&#10;&#10;            const classProps = this.ontology.dataProperties[id] || [];&#10;            props.push(...classProps);&#10;&#10;            const cls = this.ontology.classes.find(c =&gt; c.id === id);&#10;            if (cls?.parent) {&#10;                collectProps(cls.parent);&#10;            }&#10;        };&#10;&#10;        collectProps(classId);&#10;        return props;&#10;    }&#10;&#10;    useClassForMapping(classUri) {&#10;        const classInput = document.getElementById('new-mapping-class');&#10;        const classSearchInput = document.getElementById('new-mapping-class-search');&#10;        if (classInput) {&#10;            classInput.value = classUri;&#10;        }&#10;        if (classSearchInput) {&#10;            classSearchInput.value = classUri;&#10;        }&#10;    }&#10;&#10;    useProperty(propertyUri, propType) {&#10;        // If we're on step 4, fill in the form&#10;        const predicateInput = document.getElementById('new-prop-predicate');&#10;        const typeSelect = document.getElementById('new-prop-type');&#10;&#10;        if (predicateInput) {&#10;            predicateInput.value = propertyUri;&#10;        }&#10;&#10;        if (typeSelect &amp;&amp; propType) {&#10;            const typeMap = {&#10;                'string': 'string',&#10;                'integer': 'integer',&#10;                'decimal': 'decimal',&#10;                'date': 'date',&#10;                'dateTime': 'dateTime',&#10;                'boolean': 'boolean',&#10;                'iri': 'iri'&#10;            };&#10;            typeSelect.value = typeMap[propType] || 'string';&#10;        }&#10;&#10;        // If not on step 4, switch to it&#10;        if (this.currentStep !== 3) {&#10;            this.currentStep = 3;&#10;            this.renderBuilder();&#10;            // Re-fill after render&#10;            setTimeout(() =&gt; {&#10;                const input = document.getElementById('new-prop-predicate');&#10;                const select = document.getElementById('new-prop-type');&#10;                if (input) input.value = propertyUri;&#10;                if (select) select.value = propType || 'string';&#10;            }, 100);&#10;        }&#10;    }&#10;&#10;    // Event handlers&#10;    bindWizardEvents() {&#10;        document.getElementById('wizard-prev')?.addEventListener('click', () =&gt; this.prevStep());&#10;        document.getElementById('wizard-next')?.addEventListener('click', () =&gt; this.nextStep());&#10;    }&#10;&#10;    prevStep() {&#10;        if (this.currentStep &gt; 0) {&#10;            this.currentStep--;&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    nextStep() {&#10;        this.saveCurrentStep();&#10;        if (this.currentStep &lt; this.steps.length - 1) {&#10;            this.currentStep++;&#10;            this.renderBuilder();&#10;        } else {&#10;            this.downloadYAML();&#10;        }&#10;    }&#10;&#10;    saveCurrentStep() {&#10;        const step = this.steps[this.currentStep];&#10;&#10;        if (step === 'sources') {&#10;            const name = document.getElementById('new-source-name')?.value;&#10;            const type = document.getElementById('new-source-type')?.value;&#10;            const access = document.getElementById('new-source-access')?.value;&#10;            if (name &amp;&amp; access) {&#10;                this.mapping.sources[name] = { type, access, columns: this.detectedColumns };&#10;            }&#10;        } else if (step === 'classes') {&#10;            const mappingName = document.getElementById('new-mapping-name')?.value;&#10;            const source = document.getElementById('new-mapping-source')?.value;&#10;            const subject = document.getElementById('new-mapping-subject')?.value;&#10;            const rdfClass = document.getElementById('new-mapping-class')?.value;&#10;            if (mappingName &amp;&amp; subject &amp;&amp; rdfClass) {&#10;                this.mapping.mappings[mappingName] = {&#10;                    source: source,&#10;                    subject,&#10;                    class: rdfClass,&#10;                    properties: []&#10;                };&#10;            }&#10;        }&#10;    }&#10;&#10;    addSource() {&#10;        this.saveCurrentStep();&#10;        this.renderBuilder();&#10;    }&#10;&#10;    removeSource(name) {&#10;        delete this.mapping.sources[name];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addPrefix() {&#10;        const key = document.getElementById('new-prefix-key')?.value;&#10;        const uri = document.getElementById('new-prefix-uri')?.value;&#10;        if (key &amp;&amp; uri) {&#10;            this.mapping.prefixes[key] = uri;&#10;            this.renderBuilder();&#10;        }&#10;    }&#10;&#10;    removePrefix(key) {&#10;        delete this.mapping.prefixes[key];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addClassMapping() {&#10;        this.saveCurrentStep();&#10;        this.renderBuilder();&#10;    }&#10;&#10;    removeMapping(name) {&#10;        delete this.mapping.mappings[name];&#10;        this.renderBuilder();&#10;    }&#10;&#10;    addPropertyMapping() {&#10;        const tbody = document.getElementById('properties-tbody');&#10;        if (tbody) {&#10;            const emptyRow = tbody.querySelector('.empty-row');&#10;            if (emptyRow) emptyRow.remove();&#10;&#10;            const newRow = document.createElement('tr');&#10;            newRow.className = 'property-row';&#10;            newRow.innerHTML = `&#10;                &lt;td&gt;&lt;input type=&quot;text&quot; class=&quot;col-source&quot; placeholder=&quot;column&quot;&gt;&lt;/td&gt;&#10;                &lt;td&gt;&lt;input type=&quot;text&quot; class=&quot;col-predicate&quot; placeholder=&quot;prefix:property&quot;&gt;&lt;/td&gt;&#10;                &lt;td&gt;&#10;                    &lt;select class=&quot;col-type&quot;&gt;&#10;                        &lt;option value=&quot;literal&quot;&gt;string&lt;/option&gt;&#10;                        &lt;option value=&quot;integer&quot;&gt;integer&lt;/option&gt;&#10;                        &lt;option value=&quot;date&quot;&gt;date&lt;/option&gt;&#10;                        &lt;option value=&quot;uri&quot;&gt;URI&lt;/option&gt;&#10;                    &lt;/select&gt;&#10;                &lt;/td&gt;&#10;                &lt;td&gt;&lt;input type=&quot;checkbox&quot; class=&quot;col-provenance&quot;&gt;&lt;/td&gt;&#10;            `;&#10;            tbody.appendChild(newRow);&#10;        }&#10;    }&#10;&#10;    copyYAML() {&#10;        const yaml = document.getElementById('yaml-output')?.textContent;&#10;        navigator.clipboard.writeText(yaml);&#10;    }&#10;&#10;    downloadYAML() {&#10;        const yaml = this.generateYARRRML();&#10;        const blob = new Blob([yaml], { type: 'text/yaml' });&#10;        const url = URL.createObjectURL(blob);&#10;        const a = document.createElement('a');&#10;        a.href = url;&#10;        a.download = 'mapping.yarrrml.yaml';&#10;        a.click();&#10;        URL.revokeObjectURL(url);&#10;    }&#10;&#10;    escapeHtml(text) {&#10;        const div = document.createElement('div');&#10;        div.textContent = text;&#10;        return div.innerHTML;&#10;    }&#10;}&#10;&#10;// Initialize&#10;const yarrrmlBuilder = new YARRRMLBuilder();&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ETL-RDF-STAR/test_fix.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ETL-RDF-STAR/test_fix.py" />
              <option name="updatedContent" value="&quot;&quot;&quot;&#10;Test the fixed FastAPI server locally without running uvicorn&#10;&quot;&quot;&quot;&#10;from pyoxigraph import Store, RdfFormat&#10;import json&#10;&#10;# Load data&#10;print(&quot;Loading data...&quot;)&#10;store = Store()&#10;with open(&quot;ontology/data_products_ontology.ttl&quot;, 'rb') as f:&#10;    store.load(f, RdfFormat.TURTLE)&#10;with open(&quot;output/output_data_star.trig&quot;, 'rb') as f:&#10;    store.load(f, RdfFormat.TRIG)&#10;&#10;print(f&quot;Loaded {len(list(store)):,} quads\n&quot;)&#10;&#10;# Test query&#10;query = &quot;&quot;&quot;&#10;PREFIX dcat: &lt;http://www.w3.org/ns/dcat#&gt;&#10;PREFIX dct: &lt;http://purl.org/dc/terms/&gt;&#10;&#10;SELECT ?dataset ?title ?issued&#10;WHERE {&#10;    ?dataset a dcat:Dataset ;&#10;             dct:title ?title ;&#10;             dct:issued ?issued .&#10;}&#10;LIMIT 5&#10;&quot;&quot;&quot;&#10;&#10;print(&quot;Executing query...&quot;)&#10;query_results = store.query(query)&#10;&#10;# Get variables BEFORE converting to list&#10;vars = []&#10;if hasattr(query_results, 'variables'):&#10;    var_objects = query_results.variables&#10;    vars = [str(v).lstrip('?') for v in var_objects]&#10;    print(f&quot;✓ Variables: {vars}\n&quot;)&#10;&#10;# Convert to list&#10;results = list(query_results)&#10;print(f&quot;✓ Got {len(results)} results\n&quot;)&#10;&#10;# Convert to bindings&#10;bindings = []&#10;for result in results:&#10;    binding = {}&#10;    for var in vars:&#10;        try:&#10;            value = result[var]&#10;            if value is not None:&#10;                value_str = str(value)&#10;                if value_str.startswith('&lt;') and value_str.endswith('&gt;'):&#10;                    binding[var] = {'type': 'uri', 'value': value_str[1:-1]}&#10;                elif value_str.startswith('&quot;'):&#10;                    if '^^' in value_str:&#10;                        parts = value_str.split('^^')&#10;                        binding[var] = {&#10;                            'type': 'literal',&#10;                            'value': parts[0].strip('&quot;'),&#10;                            'datatype': parts[1].strip('&lt;&gt;')&#10;                        }&#10;                    else:&#10;                        binding[var] = {'type': 'literal', 'value': value_str.strip('&quot;')}&#10;                else:&#10;                    binding[var] = {'type': 'literal', 'value': value_str}&#10;        except KeyError:&#10;            continue&#10;    bindings.append(binding)&#10;&#10;# Display results&#10;response = {&#10;    'head': {'vars': vars},&#10;    'results': {'bindings': bindings}&#10;}&#10;&#10;print(&quot;=&quot;*80)&#10;print(&quot;RESULT:&quot;)&#10;print(&quot;=&quot;*80)&#10;print(json.dumps(response, indent=2))&#10;&#10;print(&quot;\n&quot; + &quot;=&quot;*80)&#10;print(&quot;VERIFICATION:&quot;)&#10;print(&quot;=&quot;*80)&#10;for i, binding in enumerate(bindings, 1):&#10;    print(f&quot;\n{i}. Dataset: {binding.get('dataset', {}).get('value', 'N/A')}&quot;)&#10;    print(f&quot;   Title: {binding.get('title', {}).get('value', 'N/A')}&quot;)&#10;    print(f&quot;   Issued: {binding.get('issued', {}).get('value', 'N/A')}&quot;)&#10;&#10;print(&quot;\n✅ SUCCESS! Bindings are no longer empty!&quot;)&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>